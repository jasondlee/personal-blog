<!DOCTYPE html>
<html>
<head>
    <title>Coming Up for Air : Incorporating preview/experimental features in WildFly</title>

    <script src="/assets/js/simple-jekyll-search.min.js" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3GQK1YDRQM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-3GQK1YDRQM');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="me" href="https://mastodon.cloud/@jasondlee"/>

    <link rel="alternate" type="application/rss+xml" title="jasondl.ee RSS feed" href="/feed.xml">

    <link rel="stylesheet" href="/assets/css/main.css" />

    <!-- Web Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Cherry+Cream+Soda">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Philosopher">
    <link rel="stylesheet" type="text/css" href="/assets/css/font-awesome.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/primeflex@3.1.2/primeflex.css"/>
    <link rel="stylesheet" href="https://unpkg.com/primeflex/themes/saga-blue.css"/>
    <link rel="author" href="/images/profile-pic.jpg"/>
</head>
<body>
<div class="grid">
    <div class="col blogname">
        <span>
            <a href="https://jasondl.ee">Coming Up for Air</a>
        </span>
    </div>
</div>
<div class="grid main">
    <div class="col-9">
        <div id="content">
            <article class="post">
    <h1 class="title" style="border-bottom: solid 1px #47586d; margin-bottom: 0.25rem;">
        Incorporating preview/experimental features in WildFly
    </h1>
    Friday, July 07, 2023 | <span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2023/incorporating-experimental-features-in-wildfly&title=Incorporating preview/experimental features in WildFly" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Incorporating preview/experimental features in WildFly&url=https://jasondl.ee/2023/incorporating-experimental-features-in-wildfly&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2023/incorporating-experimental-features-in-wildfly" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2023/incorporating-experimental-features-in-wildfly" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Incorporating preview/experimental features in WildFly&amp;body=Incorporating preview/experimental features in WildFly https://jasondl.ee/2023/incorporating-experimental-features-in-wildfly" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>

    <div>
        <div class="paragraph">
<p>One of the toughest challenges facing a mature product like WildFly is adding features without breaking existing users. It&#8217;s especially difficult when that project serves as the foundation for a commercial product downstream that requires a higher degree of stability. While WildFly is a wholly independent project, it&#8217;s not completely immune to concerns that EAP may have with regard to API stability, long term support, etc. That has made it difficult at times to change WildFly, though efforts like WildFly Preview have certainly helped.</p>
</div>
<div class="paragraph">
<p>With that in mind, I&#8217;d like to draw your attention to a project WildFly/EAP engineer extraordinaire, Paul Ferraro <a href="https://lists.jboss.org/archives/list/wildfly-dev@lists.jboss.org/thread/4JCTIWREUBBX4DVIJIUAFQ2FWDBN3AXW/">recently announced</a> on the <a href="https://lists.jboss.org/archives/list/wildfly-dev@lists.jboss.org/">wildfly-dev email list</a>. You can click through to the <a href="https://lists.jboss.org/archives/list/wildfly-dev@lists.jboss.org/thread/4JCTIWREUBBX4DVIJIUAFQ2FWDBN3AXW/">list archive</a>, or read a more nicely-formatted copy of the email below. Either way, we would greatly value any feedback you might provide.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is Paul&#8217;s email (and, thus, none of my work and all credit to him) copied, pasted, and slightly reformatted here for convenience.
</td>
</tr>
</table>
</div>
<hr>
<div style="margin-left: 2rem">
<div class="paragraph">
<p>We have long wanted the ability to easily give users opt-in access to less-than-stable features within WildFly. To this end, WildFly currently includes a preview feature pack that facilitates the delivery of preview features to WildFly users. This gives us the ability to include new or alternate versions of modules not included in our default feature pack. However, this mechanism is not well utilized, as evident by the large number of feature proposals sitting the pull request queue, largely because the vast majority of "features" do not naturally arrive via a new module (or different version of an existing module), but rather via changes to existing modules usually residing within the WildFly codebase. For the purpose of this proposal, I am mostly concerned with "features" as defined as new runtime behavior enabled via configuration within a new or existing subsystem.</p>
</div>
<div class="paragraph">
<p>Usually, development of a new feature not only involves the feature code itself, which may be bundled with the wildfly codebase, or via an external component; but also changes to the management model of the corresponding subsystem otherwise required to enable the feature.  This might be a new subsystem, but more typically, a new resource within an existing subsystem, or a new attribute of an existing resource, etc.</p>
</div>
<div class="paragraph">
<p>Rather than only being able to control the set of available features via controlling the modules of a given feature pack, it would be more useful, I think, to allow existing modules to enable features by filtering a subsystem&#8217;s management model, thus exposing/restricting the configuration needed to enable feature&#8217;s runtime behavior.</p>
</div>
<div class="paragraph">
<p>Several months ago, I created <a href="https://issues.redhat.com/browse/WFCORE-6221" class="bare">https://issues.redhat.com/browse/WFCORE-6221</a> which proposes to formalize the concept of a "feature stream" within the WildFly kernel.</p>
</div>
<div class="paragraph">
<p>We currently only support the inclusion of stable, well-tested features, which generally requires a new subsystem management model version.  Let&#8217;s call this the STABLE feature stream, where a "feature stream" is a set of features with specific stability guarantees, e.g. STABLE, PREVIEW, EXPERIMENTAL, etc.</p>
</div>
<div class="paragraph">
<p>By associating incoming features with a non-STABLE "feature stream", e.g. PREVIEW, EXPERIMENTAL, we can more quickly include new features into WildFly, allowing users access to them via a simple opt-in mechanism.  This way we can more quickly evolve WildFly while still retaining the same testing standards required for a feature to be deemed STABLE.</p>
</div>
<div class="paragraph">
<p>While we can complicate things later, let&#8217;s assume for now that feature streams are a nested hierarchy. i.e.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a server configured with the STABLE feature stream will only contain STABLE features, not PREVIEW nor EXPERIMENTAL features</p>
</li>
<li>
<p>a server configured with the PREVIEW feature stream will contain STABLE and PREVIEW features, but not EXPERIMENTAL features.</p>
</li>
<li>
<p>a server configured with the EXPERIMENTAL feature stream will contain all features.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WFCORE-6221 proposes that the features exposed by a given subsystem are defined, not just by its management model, but also the feature stream of the server. To achieve this, WFCORE-6221 proposes the following changes to WildFly core:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the ability to start WildFly with a specific "feature stream"</p>
<div class="ulist">
<ul>
<li>
<p>This takes inspiration from JEP 12, which introduced "preview features" to OpenJDK (<a href="https://openjdk.org/jeps/12" class="bare">https://openjdk.org/jeps/12</a>)</p>
</li>
<li>
<p>e.g.<br>
./standalone.sh --feature-stream=experimental<br>
./domain.sh --feature-stream=experimental</p>
</li>
</ul>
</div>
</li>
<li>
<p>Add the ability to manipulate management model registration based on the "feature stream" of the server</p>
</li>
<li>
<p>Add support for "feature stream"-specific subsystem XML namespaces</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A WildFly server instance is assigned a "feature stream" at startup, either via the command line (for the standalone use case), or via its host controller (for the managed domain use case).  By default, a server will use the STABLE feature stream.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at a few different use cases, and explore how each might be handled.  Forgive me in advance if all of my examples are clustering-related&#8230;&#8203; :)</p>
</div>
<div class="paragraph">
<p>In general, I will show 2 approaches: one using programmatic filtering, and the other using auto-filtering. I expect most users would use the auto-filtering approach.</p>
</div>
<div class="sect1">
<h2 id="introducing-an-experimental-feature-enabled-via-a-new-subsystem">Introducing an experimental feature enabled via a new subsystem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>e.g. <a href="https://issues.redhat.com/browse/WFLY-14953" class="bare">https://issues.redhat.com/browse/WFLY-14953</a></p>
</div>
<div class="paragraph">
<p>The module containing the extension for an experimental subsystem needs to be made available within the target feature pack. However, an experimental subsystem simply skips registration if the current feature stream does not support EXPERIMENTAL features. e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">FooExtension</span> <span style="color: #cf222e">implements</span> <span style="color: #953800">Extension</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">initialize</span><span style="color: #0550ae">(</span><span style="color: #953800">ExtensionContext</span> <span style="color: #24292f;background-color: #f6f8fa">context</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">context</span><span style="color: #0550ae">.</span><span style="color: #116329">enables</span><span style="color: #0550ae">(</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">))</span> <span style="color: #0550ae">{</span>
            <span style="color: #953800">SubsystemRegistration</span> <span style="color: #24292f;background-color: #f6f8fa">subsystem</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">context</span><span style="color: #0550ae">.</span><span style="color: #116329">registerSubsystem</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"foo"</span><span style="color: #0550ae">,</span>
                <span style="color: #953800">FooSubsystemModel</span><span style="color: #0550ae">.</span><span style="color: #116329">VERSION_1_0</span><span style="color: #0550ae">.</span><span style="color: #116329">getVersion</span><span style="color: #0550ae">());</span>
            <span style="color: #6e7781">// ...</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>
    <span style="color: #6e7781">// ...</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>To promote this feature to the PREVIEW stream, we simply change our logic accordingly:</p>
</div>
<div class="paragraph">
<p>Promotion to the STABLE stream can remove the condition entirely, since <code>context.enables(FeatureStream.STABLE)</code> always return true. However, promotion to STABLE will likely involve incrementing the management model version, so existing processes for stable features will apply.</p>
</div>
<div class="paragraph">
<p>Alternatively, if the subsystem is self-contained within its own extension (as opposed to an existing extension), we can simply associate the extension with a specific feature stream. e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">FooExtension</span> <span style="color: #cf222e">implements</span> <span style="color: #953800">Extension</span> <span style="color: #0550ae">{</span>
    <span style="color: #6e7781">// ...</span>
    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">FeatureStream</span> <span style="color: #8250df">getFeatureStream</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the server loads the extension, it will automatically skip initialization of any extensions not enabled by the current feature stream of the server.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introducing-an-experimental-feature-enabled-via-a-new-resource-of-an-existing-subsystem">Introducing an experimental feature enabled via a new resource of an existing subsystem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>e.g. <a href="https://issues.redhat.com/browse/WFLY-16345" class="bare">https://issues.redhat.com/browse/WFLY-16345</a></p>
</div>
<div class="paragraph">
<p>Similar to the above, we need to skip registration of the experimental resource definition if the current feature stream does not support EXPERIMENTAL features. If the experimental resource is never registered, it never installs the services required to enable the experimental feature. e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span style="color: #8250df">@Override</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">registerChildren</span><span style="color: #0550ae">(</span><span style="color: #953800">ManagementResourceRegistration</span> <span style="color: #24292f;background-color: #f6f8fa">parent</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
    <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">parent</span><span style="color: #0550ae">.</span><span style="color: #116329">enables</span><span style="color: #0550ae">(</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">))</span> <span style="color: #0550ae">{</span>
        <span style="color: #24292f;background-color: #f6f8fa">parent</span><span style="color: #0550ae">.</span><span style="color: #116329">registerSubModel</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">FooResourceDefinition</span><span style="color: #0550ae">(...));</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, we can simply associate the ResourceDefinition with a specific feature stream. e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span style="color: #cf222e">class</span> <span style="color: #953800">FooResourceDefinition</span> <span style="color: #cf222e">extends</span> <span style="color: #953800">SimpleResourceDefinition</span> <span style="color: #0550ae">{</span>
    <span style="color: #6e7781">// ...</span>
    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">FeatureStream</span> <span style="color: #8250df">getFeatureStream</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>When registering this resource via <code>ManagementResourceRegistration.registerSubModel(new FooResourceDefinition(&#8230;&#8203;))</code>, the server will omit registration if the feature stream associated with the <code>ResourceDefinition</code> is not enabled by the server. N.B. Care must be taken when using this approach, as the <code>registerSubModel(&#8230;&#8203;)</code> method will return null if registration was skipped.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introducing-an-experimental-feature-enabled-via-a-new-attribute-of-an-existing-subsystem-resource">Introducing an experimental feature enabled via a new attribute of an existing subsystem resource</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://issues.redhat.com/browse/WFLY-18000" class="bare">https://issues.redhat.com/browse/WFLY-18000</a></p>
</div>
<div class="paragraph">
<p>Similar to the above, we need to skip registration of the experimental attribute if the current feature stream does not support EXPERIMENTAL features.e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span style="color: #cf222e">class</span> <span style="color: #953800">FooResourceDefinition</span> <span style="color: #cf222e">extends</span> <span style="color: #953800">SimpleResourceDefinition</span> <span style="color: #0550ae">{</span>

    <span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">AttributeDefinition</span> <span style="color: #953800">BAR</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">...;</span> <span style="color: #6e7781">// Our new attribute that enables the new experimental feature</span>
    <span style="color: #6e7781">// ...</span>
    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">registerAttributes</span><span style="color: #0550ae">(</span><span style="color: #953800">ManagementResourceRegistration</span> <span style="color: #24292f;background-color: #f6f8fa">registration</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">registration</span><span style="color: #0550ae">.</span><span style="color: #116329">enables</span><span style="color: #0550ae">(</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">))</span> <span style="color: #0550ae">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">registration</span><span style="color: #0550ae">.</span><span style="color: #116329">registerReadWriteAttribute</span><span style="color: #0550ae">(</span><span style="color: #953800">BAR</span><span style="color: #0550ae">,</span> <span style="color: #0550ae">null</span><span style="color: #0550ae">,</span> <span style="color: #cf222e">new</span> <span style="color: #953800">ReloadRequiredWriteAttributeHandler</span><span style="color: #0550ae">(</span><span style="color: #953800">FOO</span><span style="color: #0550ae">);</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, the current registration mechanism available in wildfly-core, which registers the <code>OperationDefinition</code> parameters of the add operation parameters independently from resource attributes (via different <code>ResourceDefinition.registerXXX(&#8230;&#8203;) `methods), makes this awkward.  Additionally, resource add operation handlers and write-attribute operation handlers are constructed with a separately defined set of parameters (rather than using the parameters of the corresponding `OperationDefinition</code>).
For this reason, I submitted <a href="https://issues.redhat.com/browse/WFCORE-6407" class="bare">https://issues.redhat.com/browse/WFCORE-6407</a> (WIP <a href="https://github.com/wildfly/wildfly-core/pull/5563" class="bare">https://github.com/wildfly/wildfly-core/pull/5563</a>) which eliminates the need to construct add resource operation handlers or write-attribute operation handlers using a set of attributes.</p>
</div>
<div class="paragraph">
<p>Until that change is in place, most resource definitions for most subsystems (i.e. those not using the registration mechanics from wildfly-clustering-common) will require separate logic to exclude the EXPERIMENTAL attributes from its add operation handler independently from the resource&#8217;s attributes.  Consequently, until WFCORE-6407 is complete, add operation parameter handling will be very awkward: e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span style="color: #cf222e">class</span> <span style="color: #953800">FooResourceDefinition</span> <span style="color: #cf222e">extends</span> <span style="color: #953800">SimpleResourceDefinition</span> <span style="color: #0550ae">{</span>
<span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">AttributeDefinition</span> <span style="color: #953800">ATTRIBUTE</span> <span style="color: #0550ae">=</span> <span style="color: #6e7781">//... an existing attribute</span>

    <span style="color: #6e7781">// Our new experimental attribute</span>
    <span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">AttributeDefinition</span> <span style="color: #953800">BAR</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">SimpleAttributeDefinitionBuilder</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"bar"</span><span style="color: #0550ae">,</span> <span style="color: #953800">ModelType</span><span style="color: #0550ae">.</span><span style="color: #116329">STRING</span><span style="color: #0550ae">);</span>

    <span style="color: #6e7781">// N.B. FeatureStream.complete(...) is a convenience method that returns a full map of feature-per stream</span>
    <span style="color: #6e7781">// e.g. will auto-map FeatureStream.PREVIEW to the FeatureStream.STABLE value</span>
    <span style="color: #6e7781">// In this way, the addition of a new feature stream will not affect existing usage</span>
    <span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">Map</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">,</span> <span style="color: #953800">Collection</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">AttributeDefinition</span><span style="color: #0550ae">&gt;&gt;</span> <span style="color: #953800">ATTRIBUTES</span> <span style="color: #0550ae">=</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">complete</span><span style="color: #0550ae">(</span><span style="color: #953800">Map</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">STABLE</span><span style="color: #0550ae">,</span> <span style="color: #953800">List</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #953800">ATTRIBUTE</span><span style="color: #0550ae">),</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">,</span> <span style="color: #953800">List</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #953800">List</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #953800">ATTRIBUTE</span><span style="color: #0550ae">,</span> <span style="color: #953800">BAR</span><span style="color: #0550ae">)));</span>
    <span style="color: #6e7781">// ...</span>
    <span style="color: #cf222e">public</span> <span style="color: #8250df">FooResourceDefinition</span><span style="color: #0550ae">(</span><span style="color: #953800">ManagementResourceRegistration</span> <span style="color: #24292f;background-color: #f6f8fa">parent</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">super</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">Parameters</span><span style="color: #0550ae">(</span><span style="color: #953800">PATH</span><span style="color: #0550ae">,</span> <span style="color: #953800">DESCRIPTION_RESOLVER</span><span style="color: #0550ae">).</span><span style="color: #116329">setAddHandler</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">ReloadRequiredAddStepHandler</span><span style="color: #0550ae">(</span><span style="color: #953800">ATTRIBUTES</span><span style="color: #0550ae">.</span><span style="color: #116329">get</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">parent</span><span style="color: #0550ae">.</span><span style="color: #116329">getFeatureStream</span><span style="color: #0550ae">()))));</span>
    <span style="color: #0550ae">}</span>
    <span style="color: #6e7781">// ...</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>W.R.T. runtime, if the experimental attribute is never registered, it will not be allowed within our resource&#8217;s add operation, and thus will always resolve to its default value.</p>
</div>
<div class="paragraph">
<p>Alternatively, once WFCORE-6407 is complete, we can associate an <code>AttributeDefinition</code> with a <code>FeatureStream</code> and perform the conditional registration automatically. e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">AttributeDefinition</span> <span style="color: #953800">BAR</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">SimpleAttributeDefinitionBuilder</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"bar"</span><span style="color: #0550ae">,</span> <span style="color: #953800">ModelType</span><span style="color: #0550ae">.</span><span style="color: #116329">STRING</span><span style="color: #0550ae">)</span>
    <span style="color: #0550ae">.</span><span style="color: #116329">setRequired</span><span style="color: #0550ae">(</span><span style="color: #0550ae">false</span><span style="color: #0550ae">)</span>
    <span style="color: #0550ae">.</span><span style="color: #116329">setValidator</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">EnumValidator</span><span style="color: #0550ae">&lt;&gt;(</span><span style="color: #953800">EnumSet</span><span style="color: #0550ae">.</span><span style="color: #116329">allOf</span><span style="color: #0550ae">(</span><span style="color: #953800">Baz</span><span style="color: #0550ae">.</span><span style="color: #116329">class</span><span style="color: #0550ae">))</span>
    <span style="color: #0550ae">.</span><span style="color: #116329">setFeatureStream</span><span style="color: #0550ae">(</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">)</span>
    <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The attribute registration methods of <code>ManagementResourceRegistration</code> will omit registration of an attribute its associated feature stream is not enabled by the server.</p>
</div>
<div class="paragraph">
<p>Similarly, the <code>OperationDefinition</code> of the add operation of the containing <code>ResourceDefinition</code> will omit this attribute from its allowed parameters if the feature stream associated with the <code>AttributeDefinition</code> is not enabled by the server.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introducing-an-experimental-feature-enabled-via-a-new-value-of-an-existing-subsystem-resource-attribute">Introducing an experimental feature enabled via a new value of an existing subsystem resource attribute.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>e.g. <a href="https://issues.redhat.com/browse/WFLY-13904" class="bare">https://issues.redhat.com/browse/WFLY-13904</a></p>
</div>
<div class="paragraph">
<p>Typically, this would involve adding a new value to an existing enum. Here we need to conditionally register a <code>ParameterValidator</code> specific to the current <code>FeatureStream</code>.</p>
</div>
<div class="paragraph">
<p>As with the previous example, selecting the appropriate validator for a given "feature stream" is also awkward due to the way that resource attributes vs resource add operation parameters are handled. With the existing limitations, a "feature stream"-specific validator can be registered using logic such as:
e.g.
Using our <code>AttributeDefinition</code> <code>BAR</code> from the above example, which specifies a value enumerated by the enum <code>Baz</code>.
Our experimental feature involves a newly added <code>QUX</code> value to our <code>Baz</code> enum.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">Map</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">,</span> <span style="color: #953800">Set</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">Baz</span><span style="color: #0550ae">&gt;&gt;</span> <span style="color: #953800">BAZ_VALUES</span> <span style="color: #0550ae">=</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">complete</span><span style="color: #0550ae">(</span><span style="color: #953800">Map</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">STABLE</span><span style="color: #0550ae">,</span>
    <span style="color: #953800">Enum</span><span style="color: #0550ae">.</span><span style="color: #116329">complementOf</span><span style="color: #0550ae">(</span><span style="color: #953800">EnumSet</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #953800">Baz</span><span style="color: #0550ae">.</span><span style="color: #116329">QUX</span><span style="color: #0550ae">)),</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">,</span> <span style="color: #953800">EnumSet</span><span style="color: #0550ae">.</span><span style="color: #116329">allOf</span><span style="color: #0550ae">(</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">class</span><span style="color: #0550ae">)));</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>During attribute registration, we specify the validator specific to the current stream. e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span style="color: #8250df">@Override</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">registerAttributes</span><span style="color: #0550ae">(</span><span style="color: #953800">ManagementResourceRegistration</span> <span style="color: #24292f;background-color: #f6f8fa">registration</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
    <span style="color: #953800">ParameterValidator</span> <span style="color: #24292f;background-color: #f6f8fa">bazValidator</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">EnumValidator</span><span style="color: #0550ae">&lt;&gt;(</span><span style="color: #953800">BAZ_VALUES</span><span style="color: #0550ae">.</span><span style="color: #116329">get</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">registration</span><span style="color: #0550ae">.</span><span style="color: #116329">getFeatureStream</span><span style="color: #0550ae">()));</span>
    <span style="color: #6e7781">// Copy attribute and apply correct validator</span>
    <span style="color: #953800">AttributeDefinition</span> <span style="color: #24292f;background-color: #f6f8fa">attribute</span> <span style="color: #0550ae">=</span> <span style="color: #953800">SimpleAttributeDefinitionBuilder</span><span style="color: #0550ae">.</span><span style="color: #116329">create</span><span style="color: #0550ae">(</span><span style="color: #953800">BAR</span><span style="color: #0550ae">).</span><span style="color: #116329">setValidator</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">bazValidator</span><span style="color: #0550ae">).</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>
    <span style="color: #24292f;background-color: #f6f8fa">registration</span><span style="color: #0550ae">.</span><span style="color: #116329">registerReadWriteAttribute</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">attribute</span><span style="color: #0550ae">,</span> <span style="color: #0550ae">null</span><span style="color: #0550ae">,</span> <span style="color: #cf222e">new</span> <span style="color: #953800">ReloadRequiredWriteAttributeHandler</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">attribute</span><span style="color: #0550ae">));</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Not so pleasant&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Due to the same limitation of the current registration mechanics as described previously, a similar hack will be needed to ensure that the <code>AttributeDefinition</code> provided to the constructor of the add <code>OperationStepHandler</code> has the correct validator applied.  Again, this limitation will be addressed via WFCORE-6407.</p>
</div>
<div class="paragraph">
<p>Alternatively, with some minor changes to the <code>ParameterValidator</code> interface, and once WFCORE-6407 is complete, we can associate a <code>ParameterValidator</code> with an <code>AttributeDefinition</code> per feature stream and perform the selection automatically wherever necessary, e.g. via the base <code>OperationStepHandler</code> implementations.  I have not completely thought this through, but my current thinking is something like: e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">AttributeDefinition</span> <span style="color: #953800">BAR</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">SimpleAttributeDefinitionBuilder</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"bar"</span><span style="color: #0550ae">,</span> <span style="color: #953800">ModelType</span><span style="color: #0550ae">.</span><span style="color: #116329">STRING</span><span style="color: #0550ae">)</span>
    <span style="color: #0550ae">.</span><span style="color: #116329">setRequired</span><span style="color: #0550ae">(</span><span style="color: #0550ae">false</span><span style="color: #0550ae">)</span>
    <span style="color: #0550ae">.</span><span style="color: #116329">setValidator</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">FeatureStreamValidator</span><span style="color: #0550ae">(</span><span style="color: #953800">Map</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">STABLE</span><span style="color: #0550ae">,</span> <span style="color: #cf222e">new</span> <span style="color: #953800">EnumValidator</span><span style="color: #0550ae">&lt;&gt;(</span><span style="color: #953800">Enum</span><span style="color: #0550ae">.</span><span style="color: #116329">complementOf</span><span style="color: #0550ae">(</span><span style="color: #953800">EnumSet</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #953800">Baz</span><span style="color: #0550ae">.</span><span style="color: #116329">QUX</span><span style="color: #0550ae">))),</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">,</span> <span style="color: #cf222e">new</span> <span style="color: #953800">EnumValidator</span><span style="color: #0550ae">&lt;&gt;(</span><span style="color: #953800">Enum</span><span style="color: #0550ae">.</span><span style="color: #116329">allOf</span><span style="color: #0550ae">(</span><span style="color: #953800">Baz</span><span style="color: #0550ae">.</span><span style="color: #116329">class</span><span style="color: #0550ae">)))))</span>
    <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>where <code>FeatureStreamValidator</code> is a composite <code>ParameterValidator</code> implementation that delegates to a specific <code>ParameterValidator</code> depending on the feature-stream of the server.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="subsystem-xml-parsing">Subsystem XML parsing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Just as the feature stream is a new dimension to a subsystem&#8217;s management model version - so too is the feature stream an optional dimension of a subsystem configuration XML namespace.</p>
</div>
<div class="paragraph">
<p>Say the current version of an existing subsystem uses the XML namespace <code>urn:wildfly:foo:2.1</code>. Implementing a new experimental feature would involve a new XML namespace <code>urn:wildfly:foo:experimental:2.1</code>. If/when this feature is promoted to STABLE, we would need to increment the schema version itself, e.g. <code>urn:wildfly:foo:2.2</code>. If instead, a new stable feature is added, and the experimental feature remains experimental, we would increment the version for both the stable and experimental schemas. e.g. <code>urn:wildfly:foo:2.2</code>, <code>urn:wildfly:foo:experimental:2.2</code>.</p>
</div>
<div class="paragraph">
<p>W.R.T. XML parsing, filtering attributes/resource by stream must be done inline with existing filtering by version.
e.g. Consider the following set of subsystem namespaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span style="color: #cf222e">public</span> <span style="color: #cf222e">enum</span> <span style="color: #953800">FooSubsystemSchema</span> <span style="color: #cf222e">implements</span> <span style="color: #953800">PersistentSubsystemSchema</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">FooSubsystemSchema</span><span style="color: #0550ae">&gt;</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">VERSION_1_0</span><span style="color: #0550ae">(</span><span style="color: #0550ae">1</span><span style="color: #0550ae">),</span>
        <span style="color: #953800">VERSION_2_0</span><span style="color: #0550ae">(</span><span style="color: #0550ae">2</span><span style="color: #0550ae">),</span>
        <span style="color: #953800">VERSION_2_0_EXPERIMENTAL</span><span style="color: #0550ae">(</span><span style="color: #0550ae">2</span><span style="color: #0550ae">,</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">),</span> <span style="color: #6e7781">// We added a new experimental attribute</span>
    <span style="color: #0550ae">;</span>

    <span style="color: #cf222e">private</span> <span style="color: #cf222e">final</span> <span style="color: #953800">VersionedNamespace</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">IntVersion</span><span style="color: #0550ae">,</span> <span style="color: #953800">ExperimentalSubsystemSchema</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">namespace</span><span style="color: #0550ae">;</span>

    <span style="color: #953800">ExperimentalSubsystemSchema</span><span style="color: #0550ae">(</span><span style="color: #cf222e">int</span> <span style="color: #24292f;background-color: #f6f8fa">major</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">this</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">major</span><span style="color: #0550ae">,</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">DEFAULT</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #953800">ExperimentalSubsystemSchema</span><span style="color: #0550ae">(</span><span style="color: #cf222e">int</span> <span style="color: #24292f;background-color: #f6f8fa">major</span><span style="color: #0550ae">,</span> <span style="color: #953800">FeatureStream</span> <span style="color: #24292f;background-color: #f6f8fa">stream</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span><span style="color: #116329">namespace</span> <span style="color: #0550ae">=</span> <span style="color: #953800">SubsystemSchema</span><span style="color: #0550ae">.</span><span style="color: #116329">createSubsystemURN</span><span style="color: #0550ae">(</span><span style="color: #953800">FooSubsystemResourceDefinition</span><span style="color: #0550ae">.</span><span style="color: #116329">SUBSYSTEM_NAME</span><span style="color: #0550ae">,</span> <span style="color: #cf222e">new</span> <span style="color: #953800">IntVersion</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">major</span><span style="color: #0550ae">),</span> <span style="color: #24292f;background-color: #f6f8fa">stream</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">VersionedNamespace</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">IntVersion</span><span style="color: #0550ae">,</span> <span style="color: #953800">ExperimentalSubsystemSchema</span><span style="color: #0550ae">&gt;</span> <span style="color: #8250df">getNamespace</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span><span style="color: #116329">namespace</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">PersistentResourceXMLDescription</span> <span style="color: #8250df">getXMLDescription</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">PersistentResourceXMLBuilder</span> <span style="color: #24292f;background-color: #f6f8fa">builder</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">builder</span><span style="color: #0550ae">(</span><span style="color: #953800">FooSubsystemResourceDefinition</span><span style="color: #0550ae">.</span><span style="color: #116329">PATH</span><span style="color: #0550ae">,</span> <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span><span style="color: #116329">namespace</span><span style="color: #0550ae">);</span>
        <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #cf222e">this</span><span style="color: #0550ae">.</span><span style="color: #116329">namespace</span><span style="color: #0550ae">.</span><span style="color: #116329">since</span><span style="color: #0550ae">(</span><span style="color: #953800">VERSION_2_0</span><span style="color: #0550ae">))</span> <span style="color: #0550ae">{</span>
            <span style="color: #6e7781">// BAR is new since version 2.0, but only for specific feature streams</span>
            <span style="color: #24292f;background-color: #f6f8fa">builder</span><span style="color: #0550ae">.</span><span style="color: #116329">addAttributes</span><span style="color: #0550ae">(</span><span style="color: #953800">FooSubsystemResourceDefinition</span><span style="color: #0550ae">.</span><span style="color: #116329">ATTRIBUTES</span><span style="color: #0550ae">.</span><span style="color: #116329">stream</span><span style="color: #0550ae">().</span><span style="color: #116329">filter</span><span style="color: #0550ae">(</span><span style="color: #cf222e">this</span><span style="color: #0550ae">::</span><span style="color: #24292f;background-color: #f6f8fa">enables</span><span style="color: #0550ae">));</span>
        <span style="color: #0550ae">}</span> <span style="color: #cf222e">else</span> <span style="color: #0550ae">{</span>
            <span style="color: #6e7781">// BAR does not exist prior to version 2.0</span>
            <span style="color: #24292f;background-color: #f6f8fa">builder</span><span style="color: #0550ae">.</span><span style="color: #116329">addAttributes</span><span style="color: #0550ae">(</span><span style="color: #953800">FooSubsystemResourceDefinition</span><span style="color: #0550ae">.</span><span style="color: #116329">ATTRIBUTES</span><span style="color: #0550ae">.</span><span style="color: #116329">stream</span><span style="color: #0550ae">().</span><span style="color: #116329">filter</span><span style="color: #0550ae">(</span><span style="color: #953800">Predicates</span><span style="color: #0550ae">.</span><span style="color: #116329">not</span><span style="color: #0550ae">(</span><span style="color: #953800">BAR</span><span style="color: #0550ae">)));</span>
        <span style="color: #0550ae">}</span>
        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">builder</span><span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Registering subsystem parsers should generally look the same as it does now, since the server can skip registration of schemas associated with a feature stream not supported by the server.
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span style="color: #8250df">@Override</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">initializeParsers</span><span style="color: #0550ae">(</span><span style="color: #953800">ExtensionParsingContext</span> <span style="color: #24292f;background-color: #f6f8fa">context</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
    <span style="color: #6e7781">// This will skip registration of FooSubsystemSchema.VERSION_2_0_EXPERIMENTAL</span>
    <span style="color: #6e7781">// if the server does not support it</span>
    <span style="color: #24292f;background-color: #f6f8fa">context</span><span style="color: #0550ae">.</span><span style="color: #116329">setSubsystemXmlMappings</span><span style="color: #0550ae">(</span><span style="color: #953800">FooSubsystemResourceDefinition</span><span style="color: #0550ae">.</span><span style="color: #116329">SUBSYSTEM_NAME</span><span style="color: #0550ae">,</span>
        <span style="color: #953800">EnumSet</span><span style="color: #0550ae">.</span><span style="color: #116329">allOf</span><span style="color: #0550ae">(</span><span style="color: #953800">FooSubsystemSchema</span><span style="color: #0550ae">.</span><span style="color: #116329">class</span><span style="color: #0550ae">));</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Subsystem extensions will also need to register the appropriate writer based on the feature stream of the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span style="color: #6e7781">// The "current" schema will depend on the feature stream of the server</span>
<span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">Map</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">,</span> <span style="color: #953800">FooSubsystemSchema</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">CURRENT_SCHEMAS</span> <span style="color: #0550ae">=</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">complete</span><span style="color: #0550ae">(</span>
        <span style="color: #953800">Map</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">STABLE</span><span style="color: #0550ae">,</span> <span style="color: #953800">VERSION_2_0</span><span style="color: #0550ae">,</span> <span style="color: #953800">FeatureStream</span><span style="color: #0550ae">.</span><span style="color: #116329">EXPERIMENTAL</span><span style="color: #0550ae">,</span> <span style="color: #953800">VERSION_2_0_EXPERIMENTAL</span><span style="color: #0550ae">));</span>

<span style="color: #8250df">@Override</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">initialize</span><span style="color: #0550ae">(</span><span style="color: #953800">ExtensionContext</span> <span style="color: #24292f;background-color: #f6f8fa">context</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
    <span style="color: #953800">SubsystemRegistration</span> <span style="color: #24292f;background-color: #f6f8fa">subsystem</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">context</span><span style="color: #0550ae">.</span><span style="color: #116329">registerSubsystem</span><span style="color: #0550ae">(</span>
            <span style="color: #953800">FooSubsystemResourceDefinition</span><span style="color: #0550ae">.</span><span style="color: #116329">SUBSYSTEM_NAME</span><span style="color: #0550ae">,</span>
            <span style="color: #953800">FooSubsystemModel</span><span style="color: #0550ae">.</span><span style="color: #116329">VERSION_2_0</span><span style="color: #0550ae">.</span><span style="color: #116329">getVersion</span><span style="color: #0550ae">());</span>
    <span style="color: #6e7781">// ...</span>
    <span style="color: #24292f;background-color: #f6f8fa">subsystem</span><span style="color: #0550ae">.</span><span style="color: #116329">registerXMLElementWriter</span><span style="color: #0550ae">(</span>
            <span style="color: #cf222e">new</span> <span style="color: #8250df">PersistentResourceXMLDescriptionWriter</span><span style="color: #0550ae">(</span>
                    <span style="color: #953800">CURRENT_SCHEMAS</span><span style="color: #0550ae">.</span><span style="color: #116329">get</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">context</span><span style="color: #0550ae">.</span><span style="color: #116329">getFeatureStream</span><span style="color: #0550ae">())));</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="misc-concerns">Misc concerns</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Subsystem model transformers for mixed-domains</p>
<div class="ulist">
<ul>
<li>
<p>I anticipate that we would restrict the use of mixed-domains to the STABLE feature stream.  That means that only STABLE features need to be concerned with subsystem model transformations.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Experimental/preview wildfly kernel features</p>
<div class="ulist">
<ul>
<li>
<p>The above mechanisms should work for any features configured by a <code>ResourceDefinition</code>/<code>AttributeDefinition</code>, even if they have no corresponding subsystem</p>
</li>
<li>
<p>Anything else would need to conditionally enable based on the feature stream of the controller</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>That&#8217;s about all I have for now.</p>
</div>
<div class="paragraph">
<p>Again, I think this approach should cover the bulk of feature development use cases in WildFly.
Let me know if anything was particularly unclear, confusing, or requires elaboration; or if there are any major use cases that I have missed.</p>
</div>
<div class="paragraph">
<p>STATUS:
I have a pull request open for WFCORE-6221 [1] that implements most of the above.  It is still a work in progress - and needs to be rebased on my WFCORE-6407 branch (once that is complete).</p>
</div>
<div class="paragraph">
<p>Please browse my topic branch [2], and leave any comments on the PR [3].  A good place to start is the integration tests [4], which validates this against a sample subsystem demonstrating several of the above use cases.</p>
</div>
<div class="paragraph">
<p>For any design-related discussion, either reply to this thread or to the WFCORE-6221 jira itself.</p>
</div>
<div class="paragraph">
<p>Paul Ferraro</p>
</div>
<div class="paragraph">
<p>[1] <a href="https://issues.redhat.com/browse/WFCORE-6221" class="bare">https://issues.redhat.com/browse/WFCORE-6221</a><br>
[2] <a href="https://github.com/pferraro/wildfly-core/tree/" class="bare">https://github.com/pferraro/wildfly-core/tree/</a><br>
[3] <a href="https://github.com/wildfly/wildfly-core/pull/5413" class="bare">https://github.com/wildfly/wildfly-core/pull/5413</a><br>
[4] <a href="https://github.com/pferraro/wildfly-core/tree/WFCORE-6221/subsystem-test/tests/src/test/java/org/jboss/as/subsystem/test/experimental" class="bare">https://github.com/pferraro/wildfly-core/tree/WFCORE-6221/subsystem-test/tests/src/test/java/org/jboss/as/subsystem/test/experimental</a><br></p>
</div>
</div>
</div>
</div>
    </div>
    <footer>
        <div class="grid">
            <div class="col tags">
                
                <span class="title">tags: </span>
                
                <a href="/tag/wildfly/">WildFly</a>
                <!--                <a href="https://jasondl.ee/tags/WildFly.html">WildFly</a>-->
                
                
            </div>
            <div class="col"><span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2023/incorporating-experimental-features-in-wildfly&title=Incorporating preview/experimental features in WildFly" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Incorporating preview/experimental features in WildFly&url=https://jasondl.ee/2023/incorporating-experimental-features-in-wildfly&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2023/incorporating-experimental-features-in-wildfly" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2023/incorporating-experimental-features-in-wildfly" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Incorporating preview/experimental features in WildFly&amp;body=Incorporating preview/experimental features in WildFly https://jasondl.ee/2023/incorporating-experimental-features-in-wildfly" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>
</div>
        </div>
    </footer>
</article>

        </div>
    </div>
    <div class="col-3 widget">
        <div>
            <h3>Search</h3>
            <!-- HTML elements for search -->
            <input type="text" id="search-input" placeholder="Search blog posts.." style="width: 98%"/>
            <ul id="results-container"></ul>

            <script>
                var sjs = SimpleJekyllSearch({
                    searchInput: document.getElementById('search-input'),
                    resultsContainer: document.getElementById('results-container'),
                    json: '/search.json',
                    limit: 50
                })
            </script>
        </div>
        <div>
            <h3>Quotes</h3>
            <p id="quote">Sample quote</p>
            <p id="source">Quote source</p>
        </div>
        <div>
            <h3>About</h3>
            <p><img src="/images/profile-pic.jpg" style="float:right; object-fit: scale-down; padding-bottom: 1em;"/>My name is Jason Lee. I am a software developer living in the middle of Oklahoma. I’ve been a professional developer since 1997,
using a variety of languages, including Java, Javascript, PHP, Python, Delphi, and even a bit of C#. I currently work for Red Hat
on the WildFly/EAP team, where, among other things, I maintain integrations for some MicroProfile specs, OpenTelemetry, Micrometer,
Jakarta Faces, and Bean Validation. (Full resume <a href="resume">here</a>.
LinkedIn <a href="https://www.linkedin.com/in/jasondlee">profile</a>)</p>

<p>I am the president of the Oklahoma City JUG, and an occasional speaker at the JUG and a variety of technical conferences.</p>

<p>On the personal side, I’m active in my church, and enjoy bass guitar, running, fishing, and a variety of martial arts. I’m also
married to a beautiful woman, and have two boys, who, thankfully, look like their mother.</p>

        </div>
        <div>
            <h3>My Links</h3>
            <ul>
                
                <li>
                    <a href="/presentations" title="Presentations">
                        Presentations
                    </a>
                </li>
                
                <li>
                    <a href="/assets/resume.pdf" title="Resume/CV">
                        Resume/CV
                    </a>
                </li>
                
                <li>
                    <a href="https://linkedin.com/in/jasondlee" title="LinkedIn">
                        LinkedIn
                    </a>
                </li>
                
                <li>
                    <a href="https://twitter.com/jasondlee" title="Twitter">
                        Twitter
                    </a>
                </li>
                
                <li>
                    <a href="https://mastodon.cloud/@jasondlee" title="Mastodon">
                        Mastodon
                    </a>
                </li>
                
                <li>
                    <a href="/tag" title="Tags">
                        Tags
                    </a>
                </li>
                
            </ul>

        </div>
        <div>
            <h3>Publications</h3>
            <ul>
                <li>
                    <div class="grid">
                        <div class="col-8" style="text-weight: bold; font-size: large">
                            <div>Java 9 Programming Blueprints:</div>
                            <div>
                                <a title="My Java 9 book at Amazon" href="https://amzn.to/2FD2XAo" style="padding-left: 10px">Amazon</a>
                            </div>
                            <div>
                                <a title="My Java 9 book at Packt"
                                   href="https://www.packtpub.com/application-development/java-9-programming-blueprints"
                                   style="padding-left: 10px">Packt</a>
                            </div>
                        </div>
                            <div class="col-4">
                                <a href="https://amzn.to/2FD2XAo"><img src="/images/2017/j9pb.png" width="100"/></a>
                            </div>
                    </div>
                </li>
                
                <li>
                    <a href="https://jaxenter.com/tips-for-writing-pluggable-java-ee-applications-105281.html" title="This article discusses ways to use Java EE specs to implement a simple, yet powerful plugin system with a minimum of thrid party libraries.">
                        Tips for Writing Pluggable Java EE Applications
                    </a>
                </li>
                
                <li>
                    <a href="http://www.oracle.com/technetwork/articles/javaee/jsf-templating-137822.html" title="An article Ken Paulsen and I wrote detailing easy JSF component creation">
                        JSFTemplating and Woodstock: Component Authoring Made Easy
                    </a>
                </li>
                
                <li>
                    <a href="http://jsfcentral.com/articles/lee-03-09.html" title="Jason Lee in depth: Mojarra and Scales">
                        Jason Lee in depth: Mojarra and Scales
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20090301060746/http://www.theserverside.com/news/thread.tss?thread_id=49343" title="My JavaOne 2008 Wrap Up">
                        Jason Lee: Postmortem for JavaOne 2008
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20130621192312/https://blogs.oracle.com/stories/entry/international_environmental" title="The GlassFish Adoption Story from my time at IEC">
                        International Environmental: A Cooling Company Which Prefers Hot Software
                    </a>
                </li>
                
                <li>
                    <a href="http://www.jsfcentral.com/articles/trenches_7.html" title="This details the project that spawned a couple of the Mojarra Scales components">
                        IEC donates custom JSF component to Mojarra Scales
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>
<div class="footer">
    <div>
        <p>&#169; Copyright Jason Lee, 2005-2023. All rights reserved.</p>
    </div>
</div>
<!--
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-1091049-6', 'auto');
    ga('send', 'pageview');
</script>
-->
<script src="/assets/js/quotes.js" type="text/javascript"></script>
<script src="/assets/js/local.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script type="text/javascript" src="/assets/js/copy.js"></script>
</body>
</html>
