<!DOCTYPE html>
<html>
<head>
    <title>Coming Up for Air : Unit Testing EJBs</title>

    <script src="/assets/js/simple-jekyll-search.min.js" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3GQK1YDRQM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-3GQK1YDRQM');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="me" href="https://mastodon.cloud/@jasondlee"/>

    <link rel="alternate" type="application/rss+xml" title="jasondl.ee RSS feed" href="/feed.xml">

    <link rel="stylesheet" href="/assets/css/main.css" />

    <!-- Web Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Cherry+Cream+Soda">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Philosopher">
    <link rel="stylesheet" type="text/css" href="/assets/css/font-awesome.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/primeflex@3.1.2/primeflex.css"/>
    <link rel="stylesheet" href="https://unpkg.com/primeflex/themes/saga-blue.css"/>
    <link rel="author" href="/images/profile-pic.jpg"/>
</head>
<body>
<div class="grid">
    <div class="col blogname">
        <span>
            <a href="https://jasondl.ee">Coming Up for Air</a>
        </span>
    </div>
</div>
<div class="grid main">
    <div class="col-9">
        <div id="content">
            <article class="post">
    <h1 class="title" style="border-bottom: solid 1px #47586d; margin-bottom: 0.25rem;">
        Unit Testing EJBs
    </h1>
    Tuesday, March 27, 2007 | <span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2007/unit-testing-ejbs&title=Unit Testing EJBs" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Unit Testing EJBs&url=https://jasondl.ee/2007/unit-testing-ejbs&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2007/unit-testing-ejbs" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2007/unit-testing-ejbs" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Unit Testing EJBs&amp;body=Unit Testing EJBs https://jasondl.ee/2007/unit-testing-ejbs" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>

    <div>
        <div class="paragraph">
<p>As we&#8217;ve done more and more EJB development, we&#8217;ve had to think pretty hard about how to unit test our beans.  We&#8217;ve tried a couple of different approaches (including <em>not</em> testing, which I don&#8217;t recommend ;), but weren&#8217;t ever just real comfortable with the results.  I&#8217;m pretty happy with the method we&#8217;re using now, and it&#8217;s so simple, I&#8217;m a bit embarrassed that we didn&#8217;t think of it earlier.</p>
</div>
<div class="paragraph">
<p>One of our earliest attempts used JBoss' <a href="http://docs.jboss.org/ejb3/embedded/embedded.html">embeddable container</a>, which we eventually discarded for a couple of reasons.  It was <em>really</em> heavy in terms of configuration and startup time, and, as hard as I&#8217;m sure the JBoss team is working on AS 5 in terms of EE 5 compliance, the embeddable container is still using an <em>old</em> version of the spec, which meant we had to change the way we handled resource look ups, which we didn&#8217;t like.   We&#8217;ve also tried using mock objects, but, for the most part, we found that to be overkill.  What we ended up with is pretty light and simple.</p>
</div>
<div class="paragraph">
<p>To make things work, we had to change the way we setup our EJBs.  Since the beginning our EE 5 development, we&#8217;ve been using field injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span style="color: #8250df">@EJB</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">mappedName</span><span style="color: #0550ae">=</span><span style="color: #0a3069">"ejb/MyEjb"</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">private</span> <span style="color: #953800">MyEjbInterface</span> <span style="color: #24292f;background-color: #f6f8fa">myEjb</span><span style="color: #0550ae">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>which we have changed to using property injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span style="color: #cf222e">private</span> <span style="color: #953800">MyEjbInterface</span> <span style="color: #24292f;background-color: #f6f8fa">myEjb</span><span style="color: #0550ae">;</span>
<span style="color: #8250df">@EJB</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">mappedName</span><span style="color: #0550ae">=</span><span style="color: #0a3069">"ejb/MyEjb"</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">setMyEjb</span><span style="color: #0550ae">(</span><span style="color: #953800">MyEjb</span> <span style="color: #24292f;background-color: #f6f8fa">myEjb</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
    <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span><span style="color: #116329">myEjb</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">myEjb</span><span style="color: #0550ae">;</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our general approach has been to avoid making changes to production code for the purpose of testing, but, after talking things over with a <a href="http://blog.rodcoffin.com">friend</a> from our local <a href="http://www.okcjug.org">JUG</a>, I felt the change was not only appropriate, but a good general philosophy change.  What Rod explained to me is that, by using property injection, we make our beans reusable across integration technologies.  If, for example, we ever wanted to use this class with <a href="http://code.google.com/p/google-guice/">Guice</a> or <a href="http://springframework.org">Spring</a>, we&#8217;d be out of luck using field injection, as they don&#8217;t support that.  They do, though, support property injection, so using that makes sense in terms of portability.</p>
</div>
<div class="paragraph">
<p>With that change made, our unit tests became a lot easier to write.  Our applications are all multi-tiered, with JSF handling the view, and service and DAO layers that are either Faces-managed or container-managed and Session Beans, depending on the need for remote access.  For the purposes of our discussion here, we&#8217;ll start with the data layer.  Let&#8217;s say we have this simple DAO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span style="color: #8250df">@Stateful</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">UserDaoImpl</span> <span style="color: #cf222e">implements</span> <span style="color: #953800">UserDao</span> <span style="color: #0550ae">{</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">EntityManager</span> <span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">;</span>
    <span style="color: #8250df">@PersistenceContext</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">unitName</span><span style="color: #0550ae">=</span><span style="color: #0a3069">"myapp"</span><span style="color: #0550ae">)</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">setEntityManager</span><span style="color: #0550ae">(</span><span style="color: #953800">EntityManager</span> <span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span><span style="color: #116329">entityManager</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">User</span> <span style="color: #8250df">addUser</span><span style="color: #0550ae">(</span><span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">userName</span><span style="color: #0550ae">,</span> <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">emailAddress</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">User</span> <span style="color: #24292f;background-color: #f6f8fa">user</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">User</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">userName</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">emailAddress</span><span style="color: #0550ae">);</span>
        <span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">.</span><span style="color: #116329">persist</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">user</span><span style="color: #0550ae">);</span>
        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">user</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a very simple DAO, and there is a lot intentionally left out, but it demonstrates a simple DAO using JPA.  So how do we test that?  How do we create the EntityManager, for example?  Here&#8217;s how the unit test might look using JUnit 4 and DBUnit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">UserDaoImplTest</span> <span style="color: #0550ae">{</span>
    <span style="color: #cf222e">private</span> <span style="color: #cf222e">static</span> <span style="color: #953800">UserDaoImpl</span> <span style="color: #24292f;background-color: #f6f8fa">dao</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">UserDaoImpl</span><span style="color: #0550ae">();</span>
    <span style="color: #cf222e">private</span> <span style="color: #cf222e">static</span> <span style="color: #953800">EntityManagerFactory</span> <span style="color: #24292f;background-color: #f6f8fa">emf</span> <span style="color: #0550ae">=</span> <span style="color: #953800">Persistence</span><span style="color: #0550ae">.</span><span style="color: #116329">createEntityManagerFactory</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"myapp-test"</span><span style="color: #0550ae">);</span>
    <span style="color: #cf222e">private</span> <span style="color: #cf222e">static</span> <span style="color: #953800">EntityManager</span> <span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">;</span>
    <span style="color: #8250df">@BeforeClass</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">static</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">classSetup</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">try</span> <span style="color: #0550ae">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">entityManager</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">(</span><span style="color: #953800">EntityManager</span><span style="color: #0550ae">)</span> <span style="color: #24292f;background-color: #f6f8fa">emf</span><span style="color: #0550ae">.</span><span style="color: #116329">createEntityManager</span><span style="color: #0550ae">();</span>
            <span style="color: #953800">DbUnitHelper</span><span style="color: #0550ae">.</span><span style="color: #116329">initDatabase</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"doc/sql/myapp.sql"</span><span style="color: #0550ae">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">dao</span><span style="color: #0550ae">.</span><span style="color: #116329">setEntityManager</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">);</span>
        <span style="color: #0550ae">}</span> <span style="color: #cf222e">catch</span> <span style="color: #0550ae">(</span><span style="color: #953800">Exception</span> <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #cf222e">throw</span> <span style="color: #cf222e">new</span> <span style="color: #8250df">RuntimeException</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">);</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>
    <span style="color: #8250df">@AfterClass</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">static</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">classTearDown</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">try</span> <span style="color: #0550ae">{</span>
            <span style="color: #953800">DbUnitHelper</span><span style="color: #0550ae">.</span><span style="color: #116329">closeConnection</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span> <span style="color: #cf222e">catch</span> <span style="color: #0550ae">(</span><span style="color: #953800">SQLException</span> <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">.</span><span style="color: #116329">printStackTrace</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>
    <span style="color: #8250df">@Before</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">setUp</span><span style="color: #0550ae">()</span> <span style="color: #cf222e">throws</span> <span style="color: #953800">DatabaseUnitException</span><span style="color: #0550ae">,</span> <span style="color: #953800">SQLException</span><span style="color: #0550ae">,</span> <span style="color: #953800">Exception</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">DbUnitHelper</span><span style="color: #0550ae">.</span><span style="color: #116329">loadData</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/dataset.xml"</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>
    <span style="color: #8250df">@Test</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">addUser</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">DbUnitHelper</span><span style="color: #0550ae">.</span><span style="color: #116329">startTransaction</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">);</span>
        <span style="color: #953800">User</span> <span style="color: #24292f;background-color: #f6f8fa">user</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">dao</span><span style="color: #0550ae">.</span><span style="color: #116329">addUser</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Jim Halpert"</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"jim@dundermiffflin.com"</span><span style="color: #0550ae">);</span>
        <span style="color: #953800">Assert</span><span style="color: #0550ae">.</span><span style="color: #116329">assertNotNull</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">user</span><span style="color: #0550ae">);</span>
        <span style="color: #953800">DbUnitHelper</span><span style="color: #0550ae">.</span><span style="color: #116329">rollbackTransaction</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The unit test starts by declaring some static resources:  the DAO implementation, an <code>EntityManagerFactory</code>, and an <code>EntityManager</code>.  In the <code>@BeforeClass</code>, we ask the EMF for the EntityManager, then pass that to a <a href="/images/2007/03/dbunithelper.zip">DBUnit helper class</a>, then set the EM on the DAO (you should see now where the property injection comes in handy).  The <code>@Before</code> method simply loads our test data before each test.  One could just as easily have each unit test rollback at the end, but we chose to reload our small test dataset before each run.  The unit test itself is fairly straightforward, except that we are explicitly handling transactions to mimic the container-managed transaction handling we get for free in production.</p>
</div>
<div class="paragraph">
<p>The persistence context is defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span style="color: #6e7781">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span style="color: #116329">&lt;persistence</span> <span style="color: #116329">xmlns=</span><span style="color: #0a3069">"http://java.sun.com/xml/ns/persistence"</span>
    <span style="color: #116329">xmlns:xsi=</span><span style="color: #0a3069">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span style="color: #116329">xsi:schemaLocation=</span><span style="color: #0a3069">"http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd"</span>
    <span style="color: #116329">version=</span><span style="color: #0a3069">"1.0"</span><span style="color: #116329">&gt;</span>
    <span style="color: #116329">&lt;persistence-unit</span> <span style="color: #116329">name=</span><span style="color: #0a3069">"myapp-test"</span> <span style="color: #f6f8fa;background-color: #82071e">transaction-type:</span> <span style="color: #f6f8fa;background-color: #82071e">"RESOURCE_LOCAL"</span><span style="color: #116329">&gt;</span>
        <span style="color: #116329">&lt;class&gt;</span>com.steeplesoft.myapp.model.beans.User<span style="color: #116329">&lt;/class&gt;</span>
        <span style="color: #116329">&lt;exclude-unlisted-classes/&gt;</span>
        <span style="color: #116329">&lt;properties&gt;</span>
            <span style="color: #116329">&lt;property</span> <span style="color: #116329">name=</span><span style="color: #0a3069">"toplink.jdbc.driver"</span> <span style="color: #116329">value=</span><span style="color: #0a3069">"org.postgresql.Driver"</span><span style="color: #116329">/&gt;</span>
            <span style="color: #116329">&lt;property</span> <span style="color: #116329">name=</span><span style="color: #0a3069">"toplink.jdbc.url"</span> <span style="color: #116329">value=</span><span style="color: #0a3069">"jdbc:postgresql://localhost/myapp"</span><span style="color: #116329">/&gt;</span>
            <span style="color: #116329">&lt;property</span> <span style="color: #116329">name=</span><span style="color: #0a3069">"toplink.jdbc.user"</span> <span style="color: #116329">value=</span><span style="color: #0a3069">"myapp"</span><span style="color: #116329">/&gt;</span>
            <span style="color: #116329">&lt;property</span> <span style="color: #116329">name=</span><span style="color: #0a3069">"toplink.jdbc.password"</span> <span style="color: #116329">value=</span><span style="color: #0a3069">"myapp"</span><span style="color: #116329">/&gt;</span>
            <span style="color: #116329">&lt;property</span> <span style="color: #116329">name=</span><span style="color: #0a3069">"toplink.logging.level"</span> <span style="color: #116329">value=</span><span style="color: #0a3069">"FINE"</span><span style="color: #116329">/&gt;</span>
        <span style="color: #116329">&lt;/properties&gt;</span>
    <span style="color: #116329">&lt;/persistence-unit&gt;</span>
<span style="color: #116329">&lt;/persistence&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="/images/2007/03/dbunithelper.zip">Here</a> is the code for the DBUnitHelper class.  Note that this is still experimental, but I&#8217;ve used it on three projects now with good success, but it does abuse the JPA API by talking to the TopLink objects directly, so it is definitely not portable.  You have been warned. :)</p>
</div>
<div class="paragraph">
<p>Testing our service is fairly similar, needing just a bit more setup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">MyAppServiceImplTest</span> <span style="color: #0550ae">{</span>
    <span style="color: #cf222e">private</span> <span style="color: #cf222e">static</span> <span style="color: #953800">MyAppServiceImpl</span> <span style="color: #24292f;background-color: #f6f8fa">service</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">MyAppServiceImpl</span><span style="color: #0550ae">();</span>
    <span style="color: #cf222e">private</span> <span style="color: #cf222e">static</span> <span style="color: #953800">UserDaoImpl</span> <span style="color: #24292f;background-color: #f6f8fa">dao</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">UserDaoImpl</span><span style="color: #0550ae">();</span>
    <span style="color: #cf222e">private</span> <span style="color: #cf222e">static</span> <span style="color: #953800">EntityManagerFactory</span> <span style="color: #24292f;background-color: #f6f8fa">emf</span> <span style="color: #0550ae">=</span> <span style="color: #953800">Persistence</span><span style="color: #0550ae">.</span><span style="color: #116329">createEntityManagerFactory</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"myapp-test"</span><span style="color: #0550ae">);</span>
    <span style="color: #cf222e">private</span> <span style="color: #cf222e">static</span> <span style="color: #953800">EntityManager</span> <span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">;</span>
    <span style="color: #8250df">@BeforeClass</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">static</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">classSetup</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">try</span> <span style="color: #0550ae">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">entityManager</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">(</span><span style="color: #953800">EntityManager</span><span style="color: #0550ae">)</span> <span style="color: #24292f;background-color: #f6f8fa">emf</span><span style="color: #0550ae">.</span><span style="color: #116329">createEntityManager</span><span style="color: #0550ae">();</span>
            <span style="color: #953800">DbUnitHelper</span><span style="color: #0550ae">.</span><span style="color: #116329">initDatabase</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"doc/sql/myapp.sql"</span><span style="color: #0550ae">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">dao</span><span style="color: #0550ae">.</span><span style="color: #116329">setEntityManager</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">service</span><span style="color: #0550ae">.</span><span style="color: #116329">setUserDao</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">dao</span><span style="color: #0550ae">);</span>
        <span style="color: #0550ae">}</span> <span style="color: #cf222e">catch</span> <span style="color: #0550ae">(</span><span style="color: #953800">Exception</span> <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #cf222e">throw</span> <span style="color: #cf222e">new</span> <span style="color: #8250df">RuntimeException</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">);</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>
    <span style="color: #8250df">@AfterClass</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">static</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">classTearDown</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">try</span> <span style="color: #0550ae">{</span>
            <span style="color: #953800">DbUnitHelper</span><span style="color: #0550ae">.</span><span style="color: #116329">closeConnection</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span> <span style="color: #cf222e">catch</span> <span style="color: #0550ae">(</span><span style="color: #953800">SQLException</span> <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">.</span><span style="color: #116329">printStackTrace</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>
    <span style="color: #8250df">@Before</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">setUp</span><span style="color: #0550ae">()</span> <span style="color: #cf222e">throws</span> <span style="color: #953800">DatabaseUnitException</span><span style="color: #0550ae">,</span> <span style="color: #953800">SQLException</span><span style="color: #0550ae">,</span> <span style="color: #953800">Exception</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">DbUnitHelper</span><span style="color: #0550ae">.</span><span style="color: #116329">loadData</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/dataset.xml"</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>
    <span style="color: #8250df">@Test</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">addUser</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">DbUnitHelper</span><span style="color: #0550ae">.</span><span style="color: #116329">startTransaction</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">);</span>
        <span style="color: #953800">User</span> <span style="color: #24292f;background-color: #f6f8fa">user</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">service</span><span style="color: #0550ae">.</span><span style="color: #116329">addUser</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Jim Halpert"</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"jim@dundermiffflin.com"</span><span style="color: #0550ae">);</span>
        <span style="color: #953800">Assert</span><span style="color: #0550ae">.</span><span style="color: #116329">assertNotNull</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">user</span><span style="color: #0550ae">);</span>
        <span style="color: #953800">DbUnitHelper</span><span style="color: #0550ae">.</span><span style="color: #116329">rollbackTransaction</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">entityManager</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This test is very similar to the DAO test, including transaction management, but we call the service instead of the DAO.  I also chose to create a "real" instance of the DAO as opposed to mocking one up, since the resource was local to the project.  That makes the test more of an integration test in some ways, but we&#8217;re OK with that.</p>
</div>
<div class="paragraph">
<p>For external resources, we&#8217;re tempted to use mock objects, but another sharp OKC JUG regular, <a href="http://www.davenicolette.net">Dave Nicolette</a>, suggests that that might be overkill.  Anything we might inject we will have an interface for, so he suggests just writing a stubbed implementation of the interface and injecting that, making our "stub" behave the way our test expects, which would allow us to focus on testing the client and not the "remote" object.  That&#8217;s an interesting approach.  I have not been able to test that yet, but I certainly will when the need arises.</p>
</div>
<div class="paragraph">
<p>That about sums it up.  All that&#8217;s left to test is the JSF layer, for which we don&#8217;t have a solution with which I&#8217;m all that comfortable.  Once we nail something down, I&#8217;ll be sure to write it up here. :)</p>
</div>
<div class="paragraph">
<p>So, how is everyone else testing EJBs?  Comments, suggestions, corrections, etc. are, of course, welcome!</p>
</div>
    </div>
    <footer>
        <div class="grid">
            <div class="col tags">
                
                <span class="title">tags: </span>
                
                <a href="/tag/ejb3/">EJB3</a>
                <!--                <a href="https://jasondl.ee/tags/EJB3.html">EJB3</a>-->
                
                <a href="/tag/java/">Java</a>
                <!--                <a href="https://jasondl.ee/tags/Java.html">Java</a>-->
                
                <a href="/tag/testing/">Testing</a>
                <!--                <a href="https://jasondl.ee/tags/Testing.html">Testing</a>-->
                
                
            </div>
            <div class="col"><span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2007/unit-testing-ejbs&title=Unit Testing EJBs" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Unit Testing EJBs&url=https://jasondl.ee/2007/unit-testing-ejbs&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2007/unit-testing-ejbs" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2007/unit-testing-ejbs" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Unit Testing EJBs&amp;body=Unit Testing EJBs https://jasondl.ee/2007/unit-testing-ejbs" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>
</div>
        </div>
    </footer>
</article>

        </div>
    </div>
    <div class="col-3 widget">
        <div>
            <h3>Search</h3>
            <!-- HTML elements for search -->
            <input type="text" id="search-input" placeholder="Search blog posts.." style="width: 98%"/>
            <ul id="results-container"></ul>

            <script>
                var sjs = SimpleJekyllSearch({
                    searchInput: document.getElementById('search-input'),
                    resultsContainer: document.getElementById('results-container'),
                    json: '/search.json',
                    limit: 50
                })
            </script>
        </div>
        <div>
            <h3>Quotes</h3>
            <p id="quote">Sample quote</p>
            <p id="source">Quote source</p>
        </div>
        <div>
            <h3>About</h3>
            <p><img src="/images/profile-pic.jpg" style="float:right; object-fit: scale-down; padding-bottom: 1em;"/>My name is Jason Lee. I am a software developer living in the middle of Oklahoma. I’ve been a professional developer since 1997,
using a variety of languages, including Java, Javascript, PHP, Python, Delphi, and even a bit of C#. I currently work for Red Hat
on the WildFly/EAP team, where, among other things, I maintain integrations for some MicroProfile specs, OpenTelemetry, Micrometer,
Jakarta Faces, and Bean Validation. (Full resume <a href="resume">here</a>.
LinkedIn <a href="https://www.linkedin.com/in/jasondlee">profile</a>)</p>

<p>I am the president of the Oklahoma City JUG, and an occasional speaker at the JUG and a variety of technical conferences.</p>

<p>On the personal side, I’m active in my church, and enjoy bass guitar, running, fishing, and a variety of martial arts. I’m also
married to a beautiful woman, and have two boys, who, thankfully, look like their mother.</p>

        </div>
        <div>
            <h3>My Links</h3>
            <ul>
                
                <li>
                    <a href="/presentations" title="Presentations">
                        Presentations
                    </a>
                </li>
                
                <li>
                    <a href="/assets/resume.pdf" title="Resume/CV">
                        Resume/CV
                    </a>
                </li>
                
                <li>
                    <a href="https://linkedin.com/in/jasondlee" title="LinkedIn">
                        LinkedIn
                    </a>
                </li>
                
                <li>
                    <a href="https://twitter.com/jasondlee" title="Twitter">
                        Twitter
                    </a>
                </li>
                
                <li>
                    <a href="https://mastodon.cloud/@jasondlee" title="Mastodon">
                        Mastodon
                    </a>
                </li>
                
                <li>
                    <a href="/tag" title="Tags">
                        Tags
                    </a>
                </li>
                
            </ul>

        </div>
        <div>
            <h3>Publications</h3>
            <ul>
                <li>
                    <div class="grid">
                        <div class="col-8" style="text-weight: bold; font-size: large">
                            <div>Java 9 Programming Blueprints:</div>
                            <div>
                                <a title="My Java 9 book at Amazon" href="https://amzn.to/2FD2XAo" style="padding-left: 10px">Amazon</a>
                            </div>
                            <div>
                                <a title="My Java 9 book at Packt"
                                   href="https://www.packtpub.com/application-development/java-9-programming-blueprints"
                                   style="padding-left: 10px">Packt</a>
                            </div>
                        </div>
                            <div class="col-4">
                                <a href="https://amzn.to/2FD2XAo"><img src="/images/2017/j9pb.png" width="100"/></a>
                            </div>
                    </div>
                </li>
                
                <li>
                    <a href="https://jaxenter.com/tips-for-writing-pluggable-java-ee-applications-105281.html" title="This article discusses ways to use Java EE specs to implement a simple, yet powerful plugin system with a minimum of thrid party libraries.">
                        Tips for Writing Pluggable Java EE Applications
                    </a>
                </li>
                
                <li>
                    <a href="http://www.oracle.com/technetwork/articles/javaee/jsf-templating-137822.html" title="An article Ken Paulsen and I wrote detailing easy JSF component creation">
                        JSFTemplating and Woodstock: Component Authoring Made Easy
                    </a>
                </li>
                
                <li>
                    <a href="http://jsfcentral.com/articles/lee-03-09.html" title="Jason Lee in depth: Mojarra and Scales">
                        Jason Lee in depth: Mojarra and Scales
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20090301060746/http://www.theserverside.com/news/thread.tss?thread_id=49343" title="My JavaOne 2008 Wrap Up">
                        Jason Lee: Postmortem for JavaOne 2008
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20130621192312/https://blogs.oracle.com/stories/entry/international_environmental" title="The GlassFish Adoption Story from my time at IEC">
                        International Environmental: A Cooling Company Which Prefers Hot Software
                    </a>
                </li>
                
                <li>
                    <a href="http://www.jsfcentral.com/articles/trenches_7.html" title="This details the project that spawned a couple of the Mojarra Scales components">
                        IEC donates custom JSF component to Mojarra Scales
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>
<div class="footer">
    <div>
        <p>&#169; Copyright Jason Lee, 2005-2023. All rights reserved.</p>
    </div>
</div>
<!--
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-1091049-6', 'auto');
    ga('send', 'pageview');
</script>
-->
<script src="/assets/js/quotes.js" type="text/javascript"></script>
<script src="/assets/js/local.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script type="text/javascript" src="/assets/js/copy.js"></script>
</body>
</html>
