<!DOCTYPE html>
<html>
<head>
    <title>Coming Up for Air : A Simple OAuth2 Client and Server Example: Part I</title>

    <script src="/assets/js/simple-jekyll-search.min.js" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3GQK1YDRQM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-3GQK1YDRQM');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="me" href="https://mastodon.cloud/@jasondlee"/>

    <link rel="alternate" type="application/rss+xml" title="jasondl.ee RSS feed" href="/feed.xml">

    <link rel="stylesheet" href="/assets/css/main.css" />

    <!-- Web Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Cherry+Cream+Soda">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Philosopher">
    <link rel="stylesheet" type="text/css" href="/assets/css/font-awesome.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/primeflex@3.1.2/primeflex.css"/>
    <link rel="stylesheet" href="https://unpkg.com/primeflex/themes/saga-blue.css"/>
    <link rel="author" href="/images/profile-pic.jpg"/>
</head>
<body>
<div class="grid">
    <div class="col blogname">
        <span>
            <a href="https://jasondl.ee">Coming Up for Air</a>
        </span>
    </div>
</div>
<div class="grid main">
    <div class="col-9">
        <div id="content">
            <article class="post">
    <h1 class="title" style="border-bottom: solid 1px #47586d; margin-bottom: 0.25rem;">
        A Simple OAuth2 Client and Server Example: Part I
    </h1>
    Thursday, July 11, 2013 | <span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2013/a-simple-oauth2-client-and-server-example-part-i&title=A Simple OAuth2 Client and Server Example: Part I" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=A Simple OAuth2 Client and Server Example: Part I&url=https://jasondl.ee/2013/a-simple-oauth2-client-and-server-example-part-i&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2013/a-simple-oauth2-client-and-server-example-part-i" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2013/a-simple-oauth2-client-and-server-example-part-i" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=A Simple OAuth2 Client and Server Example: Part I&amp;body=A Simple OAuth2 Client and Server Example: Part I https://jasondl.ee/2013/a-simple-oauth2-client-and-server-example-part-i" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>

    <div>
        <div class="paragraph">
<p>When implementing web site security, OAuth2 almost always comes up. We&#8217;ve had requests to implement OAuth2 in the GlassFish REST interface, and, it turns out, I have a similar need on a personal project. Looking at the spec, though, OAuth2 can be pretty daunting. Fortunately, you don&#8217;t need to understand it all, and Apache has a project, Oltu (nee Amber) that handles most of the implementation.</p>
</div>
<div class="paragraph">
<p>Before we get too excited, I need to qualify the statements I&#8217;m about to make: I am very new to OAuth2 and, then, by no means an expert. What I&#8217;m going to present here is my current understanding of part of what the spec offers. Hopefully, it&#8217;s accurate and helpful. As with everything you read on the internet, though, it never hurts to verify. :)</p>
</div>
<div class="paragraph">
<p>With that out of the way, we&#8217;re going to implement a very simple token-based authorization system.  This will allow a third-party app to interact with your service on behalf of a user.  Here&#8217;s the basic flow in English:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A user logs in to new application on the web, which we&#8217;ll call <em>TheApp</em>. <em>TheApp</em> offers integration with a service you provide, <em>TheService</em>.</p>
</li>
<li>
<p>In order to achieve this integration, <em>TheService</em> must authorize <em>TheApp</em> to act on behalf of <em>TheUser</em>, so <em>TheApp</em> redirects the user to <em>TheService</em>'s authorization page.</p>
</li>
<li>
<p><em>TheUser</em> is presented with the option to grant or deny access to <em>TheApp</em>. He clicks "grant", and is redirected back to <em>TheApp</em>.</p>
</li>
<li>
<p>When <em>TheService</em> redirects back to <em>TheApp</em>, it sends and authorization code. <em>TheApp</em> then takes that authorization code and asks <em>TheService</em> for the access token.</p>
</li>
<li>
<p><em>TheService</em> verifies the authorization code and returns the token to <em>TheApp</em>.</p>
</li>
<li>
<p>Now, when <em>TheUser</em> asks <em>TheApp</em> to do something with <em>TheService</em>, either directly via the web interface or via a scheduled job, <em>TheApp</em> passes the token as part of the request, which <em>TheService</em> uses to authenticate the request.</p>
</li>
<li>
<p>At any time, <em>TheUser</em> can visit <em>TheService</em> and revoke the token, which will break the integration between <em>TheApp</em> and <em>TheService</em> for that user.</p>
</li>
<li>
<p>At no point does <em>TheApp</em> need to know the username and password for <em>TheUser</em> with <em>TheService</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Still with me? I hope so. I&#8217;ve put too much work into this to lose you now! :P</p>
</div>
<div class="paragraph">
<p>With our basic workflow described, let&#8217;s look at an implementation. In this example, <em>TheApp</em> and <em>TheService</em> will be the same app, and <em>TheUser</em> will be unit tests. Let&#8217;s start with the authorization code resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/authz"</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">AuthzEndpoint</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@Inject</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">Database</span> <span style="color: #24292f;background-color: #f6f8fa">database</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@GET</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">Response</span> <span style="color: #8250df">authorize</span><span style="color: #0550ae">(</span><span style="color: #8250df">@Context</span> <span style="color: #953800">HttpServletRequest</span> <span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">)</span>
            <span style="color: #cf222e">throws</span> <span style="color: #953800">URISyntaxException</span><span style="color: #0550ae">,</span> <span style="color: #953800">OAuthSystemException</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">try</span> <span style="color: #0550ae">{</span>
            <span style="color: #953800">OAuthAuthzRequest</span> <span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span> <span style="color: #0550ae">=</span>
                <span style="color: #cf222e">new</span> <span style="color: #8250df">OAuthAuthzRequest</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">);</span>
            <span style="color: #953800">OAuthIssuerImpl</span> <span style="color: #24292f;background-color: #f6f8fa">oauthIssuerImpl</span> <span style="color: #0550ae">=</span>
                <span style="color: #cf222e">new</span> <span style="color: #8250df">OAuthIssuerImpl</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">MD5Generator</span><span style="color: #0550ae">());</span>

            <span style="color: #6e7781">//build response according to response_type</span>
            <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">responseType</span> <span style="color: #0550ae">=</span>
                <span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getParam</span><span style="color: #0550ae">(</span><span style="color: #953800">OAuth</span><span style="color: #0550ae">.</span><span style="color: #116329">OAUTH_RESPONSE_TYPE</span><span style="color: #0550ae">);</span>

            <span style="color: #953800">OAuthASResponse</span><span style="color: #0550ae">.</span><span style="color: #116329">OAuthAuthorizationResponseBuilder</span> <span style="color: #24292f;background-color: #f6f8fa">builder</span> <span style="color: #0550ae">=</span>
                    <span style="color: #953800">OAuthASResponse</span><span style="color: #0550ae">.</span><span style="color: #116329">authorizationResponse</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">,</span>
                        <span style="color: #953800">HttpServletResponse</span><span style="color: #0550ae">.</span><span style="color: #116329">SC_FOUND</span><span style="color: #0550ae">);</span>

            <span style="color: #6e7781">// 1</span>
            <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">responseType</span><span style="color: #0550ae">.</span><span style="color: #116329">equals</span><span style="color: #0550ae">(</span><span style="color: #953800">ResponseType</span><span style="color: #0550ae">.</span><span style="color: #116329">CODE</span><span style="color: #0550ae">.</span><span style="color: #116329">toString</span><span style="color: #0550ae">()))</span> <span style="color: #0550ae">{</span>
                <span style="color: #cf222e">final</span> <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">authorizationCode</span> <span style="color: #0550ae">=</span>
                    <span style="color: #24292f;background-color: #f6f8fa">oauthIssuerImpl</span><span style="color: #0550ae">.</span><span style="color: #116329">authorizationCode</span><span style="color: #0550ae">();</span>
                <span style="color: #24292f;background-color: #f6f8fa">database</span><span style="color: #0550ae">.</span><span style="color: #116329">addAuthCode</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">authorizationCode</span><span style="color: #0550ae">);</span>
                <span style="color: #24292f;background-color: #f6f8fa">builder</span><span style="color: #0550ae">.</span><span style="color: #116329">setCode</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">authorizationCode</span><span style="color: #0550ae">);</span>
            <span style="color: #0550ae">}</span>

            <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">redirectURI</span> <span style="color: #0550ae">=</span>
                <span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getParam</span><span style="color: #0550ae">(</span><span style="color: #953800">OAuth</span><span style="color: #0550ae">.</span><span style="color: #116329">OAUTH_REDIRECT_URI</span><span style="color: #0550ae">);</span>
            <span style="color: #cf222e">final</span> <span style="color: #953800">OAuthResponse</span> <span style="color: #24292f;background-color: #f6f8fa">response</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">builder</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">location</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">redirectURI</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">buildQueryMessage</span><span style="color: #0550ae">();</span>
            <span style="color: #953800">URI</span> <span style="color: #24292f;background-color: #f6f8fa">url</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">URI</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">response</span><span style="color: #0550ae">.</span><span style="color: #116329">getLocationUri</span><span style="color: #0550ae">());</span>
            <span style="color: #cf222e">return</span> <span style="color: #953800">Response</span><span style="color: #0550ae">.</span><span style="color: #116329">status</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">response</span><span style="color: #0550ae">.</span><span style="color: #116329">getResponseStatus</span><span style="color: #0550ae">())</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">location</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">url</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span> <span style="color: #cf222e">catch</span> <span style="color: #0550ae">(</span><span style="color: #953800">OAuthProblemException</span> <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #6e7781">// ...</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>While we&#8217;ve implemented this as a REST resource, this is the code that would back the authorization page, so it would most likely be, for example, a JSF or CDI managed bean. The user would click "authorize", and the <code>authorize</code> method would be called. In this case, our client (which we&#8217;ll look at in a bit), sends a request with a response type of code, so it&#8217;s handled via the block at [1].</p>
</div>
<div class="paragraph">
<p>Notice that we&#8217;re not doing any authentication for the request. If this were a real system, this method would be called in the context of an HTTP session, for which the client would already be authenticated. Probably. :) At any rate, to make things simple, we just return the authorization code via the redirect back to <em>TheApp</em>.</p>
</div>
<div class="paragraph">
<p>Once <em>TheApp</em> has the authorization code, it can then request the actual token, sometimes referred to as a "bearer token". The server side of that can be implemented like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="code"><pre><span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/token"</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">TokenEndpoint</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@Inject</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">Database</span> <span style="color: #24292f;background-color: #f6f8fa">database</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@POST</span>
    <span style="color: #8250df">@Consumes</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"application/x-www-form-urlencoded"</span><span style="color: #0550ae">)</span>
    <span style="color: #8250df">@Produces</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"application/json"</span><span style="color: #0550ae">)</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">Response</span> <span style="color: #8250df">authorize</span><span style="color: #0550ae">(</span><span style="color: #8250df">@Context</span> <span style="color: #953800">HttpServletRequest</span> <span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">)</span>
        <span style="color: #cf222e">throws</span> <span style="color: #953800">OAuthSystemException</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">try</span> <span style="color: #0550ae">{</span>
            <span style="color: #953800">OAuthTokenRequest</span> <span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span> <span style="color: #0550ae">=</span>
                <span style="color: #cf222e">new</span> <span style="color: #8250df">OAuthTokenRequest</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">);</span>
            <span style="color: #953800">OAuthIssuer</span> <span style="color: #24292f;background-color: #f6f8fa">oauthIssuerImpl</span> <span style="color: #0550ae">=</span>
                <span style="color: #cf222e">new</span> <span style="color: #8250df">OAuthIssuerImpl</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">MD5Generator</span><span style="color: #0550ae">());</span>

            <span style="color: #6e7781">// check if clientid is valid</span>
            <span style="color: #cf222e">if</span> <span style="color: #0550ae">(!</span><span style="color: #24292f;background-color: #f6f8fa">checkClientId</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getClientId</span><span style="color: #0550ae">()))</span> <span style="color: #0550ae">{</span>
                <span style="color: #cf222e">return</span> <span style="color: #8250df">buildInvalidClientIdResponse</span><span style="color: #0550ae">();</span>
            <span style="color: #0550ae">}</span>

            <span style="color: #6e7781">// check if client_secret is valid</span>
            <span style="color: #cf222e">if</span> <span style="color: #0550ae">(!</span><span style="color: #24292f;background-color: #f6f8fa">checkClientSecret</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getClientSecret</span><span style="color: #0550ae">()))</span> <span style="color: #0550ae">{</span>
                <span style="color: #cf222e">return</span> <span style="color: #8250df">buildInvalidClientSecretResponse</span><span style="color: #0550ae">();</span>
            <span style="color: #0550ae">}</span>

            <span style="color: #6e7781">// do checking for different grant types</span>
            <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getParam</span><span style="color: #0550ae">(</span><span style="color: #953800">OAuth</span><span style="color: #0550ae">.</span><span style="color: #116329">OAUTH_GRANT_TYPE</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">equals</span><span style="color: #0550ae">(</span><span style="color: #953800">GrantType</span><span style="color: #0550ae">.</span><span style="color: #116329">AUTHORIZATION_CODE</span><span style="color: #0550ae">.</span><span style="color: #116329">toString</span><span style="color: #0550ae">()))</span> <span style="color: #0550ae">{</span>
                <span style="color: #cf222e">if</span> <span style="color: #0550ae">(!</span><span style="color: #24292f;background-color: #f6f8fa">checkAuthCode</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getParam</span><span style="color: #0550ae">(</span><span style="color: #953800">OAuth</span><span style="color: #0550ae">.</span><span style="color: #116329">OAUTH_CODE</span><span style="color: #0550ae">)))</span> <span style="color: #0550ae">{</span>
                    <span style="color: #cf222e">return</span> <span style="color: #8250df">buildBadAuthCodeResponse</span><span style="color: #0550ae">();</span>
                <span style="color: #0550ae">}</span>
            <span style="color: #0550ae">}</span> <span style="color: #cf222e">else</span> <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getParam</span><span style="color: #0550ae">(</span><span style="color: #953800">OAuth</span><span style="color: #0550ae">.</span><span style="color: #116329">OAUTH_GRANT_TYPE</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">equals</span><span style="color: #0550ae">(</span><span style="color: #953800">GrantType</span><span style="color: #0550ae">.</span><span style="color: #116329">PASSWORD</span><span style="color: #0550ae">.</span><span style="color: #116329">toString</span><span style="color: #0550ae">()))</span> <span style="color: #0550ae">{</span>
                <span style="color: #cf222e">if</span> <span style="color: #0550ae">(!</span><span style="color: #24292f;background-color: #f6f8fa">checkUserPass</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getUsername</span><span style="color: #0550ae">(),</span>
                        <span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getPassword</span><span style="color: #0550ae">()))</span> <span style="color: #0550ae">{</span>
                    <span style="color: #cf222e">return</span> <span style="color: #8250df">buildInvalidUserPassResponse</span><span style="color: #0550ae">();</span>
                <span style="color: #0550ae">}</span>
            <span style="color: #0550ae">}</span> <span style="color: #cf222e">else</span> <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getParam</span><span style="color: #0550ae">(</span><span style="color: #953800">OAuth</span><span style="color: #0550ae">.</span><span style="color: #116329">OAUTH_GRANT_TYPE</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">equals</span><span style="color: #0550ae">(</span><span style="color: #953800">GrantType</span><span style="color: #0550ae">.</span><span style="color: #116329">REFRESH_TOKEN</span><span style="color: #0550ae">.</span><span style="color: #116329">toString</span><span style="color: #0550ae">()))</span> <span style="color: #0550ae">{</span>
                <span style="color: #6e7781">// refresh token is not supported in this implementation</span>
                <span style="color: #24292f;background-color: #f6f8fa">buildInvalidUserPassResponse</span><span style="color: #0550ae">();</span>
            <span style="color: #0550ae">}</span>

            <span style="color: #cf222e">final</span> <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">accessToken</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">oauthIssuerImpl</span><span style="color: #0550ae">.</span><span style="color: #116329">accessToken</span><span style="color: #0550ae">();</span>
            <span style="color: #24292f;background-color: #f6f8fa">database</span><span style="color: #0550ae">.</span><span style="color: #116329">addToken</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">accessToken</span><span style="color: #0550ae">);</span>

            <span style="color: #953800">OAuthResponse</span> <span style="color: #24292f;background-color: #f6f8fa">response</span> <span style="color: #0550ae">=</span> <span style="color: #953800">OAuthASResponse</span>
                    <span style="color: #0550ae">.</span><span style="color: #116329">tokenResponse</span><span style="color: #0550ae">(</span><span style="color: #953800">HttpServletResponse</span><span style="color: #0550ae">.</span><span style="color: #116329">SC_OK</span><span style="color: #0550ae">)</span>
                    <span style="color: #0550ae">.</span><span style="color: #116329">setAccessToken</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">accessToken</span><span style="color: #0550ae">)</span>
                    <span style="color: #0550ae">.</span><span style="color: #116329">setExpiresIn</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"3600"</span><span style="color: #0550ae">)</span>
                    <span style="color: #0550ae">.</span><span style="color: #116329">buildJSONMessage</span><span style="color: #0550ae">();</span>
            <span style="color: #cf222e">return</span> <span style="color: #953800">Response</span><span style="color: #0550ae">.</span><span style="color: #116329">status</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">response</span><span style="color: #0550ae">.</span><span style="color: #116329">getResponseStatus</span><span style="color: #0550ae">())</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">entity</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">response</span><span style="color: #0550ae">.</span><span style="color: #116329">getBody</span><span style="color: #0550ae">()).</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>

        <span style="color: #0550ae">}</span> <span style="color: #cf222e">catch</span> <span style="color: #0550ae">(</span><span style="color: #953800">OAuthProblemException</span> <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #953800">OAuthResponse</span> <span style="color: #24292f;background-color: #f6f8fa">res</span> <span style="color: #0550ae">=</span> <span style="color: #953800">OAuthASResponse</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">errorResponse</span><span style="color: #0550ae">(</span><span style="color: #953800">HttpServletResponse</span><span style="color: #0550ae">.</span><span style="color: #116329">SC_BAD_REQUEST</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">error</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">buildJSONMessage</span><span style="color: #0550ae">();</span>
            <span style="color: #cf222e">return</span> <span style="color: #953800">Response</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">status</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">res</span><span style="color: #0550ae">.</span><span style="color: #116329">getResponseStatus</span><span style="color: #0550ae">()).</span><span style="color: #116329">entity</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">res</span><span style="color: #0550ae">.</span><span style="color: #116329">getBody</span><span style="color: #0550ae">())</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #6e7781">// ...</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This resource is actually a bit more complex. In a fully implemented OAuth2 system, <em>TheApp</em> would have had to register a client ID and a client secret. This done, as best as I can tell, to help control access to the number of apps that can use <em>TheService</em>, as well help prevent given out tokens to anyone except the intended client.</p>
</div>
<div class="paragraph">
<p>Once the client ID and secret have been validated (which we&#8217;ve stubbed out here), we come to the meat of the resource, and the behavior is based on the "grant type" requested by the client (<em>TheApp</em>).  The first grant type we check, "code", tells the service that we have an authorization code and would like a token. To make things interesting and mostly functional, I have implemented a simple datastore, called <code>Database</code>, that is simple a couple of Sets to store valid auth codes and tokens. If the auth code is valid, we continue. Otherwise, we return a <code>BAD_REQUEST</code> response.</p>
</div>
<div class="paragraph">
<p>The next grant type we check is "password". One means of acquiring token, in addition to an authorization code, is using a username and password. This can be used, for example, where a mobile app redirects the user to a login page, where the user provides his credentials, which are then used to authenticate to generate the token.</p>
</div>
<div class="paragraph">
<p>Once we validated the request, we can generate a token (using the Oltu class <code>OAuthIssuer</code>), which we store in our fake database, then generate an OAuthResponse for the client.</p>
</div>
<div class="paragraph">
<p><em>TheApp</em>, now equipped with the bearer token, can store it internally for use on behalf of <em>TheUser</em>. When requests are made to <em>TheService</em>, <em>TheApp</em> includes the token in the <code>Authorization</code> header:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="linenums"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre>Authorization: Bearer &lt;token&gt;
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resource must then validate the token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="code"><pre><span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/resource"</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">ResourceEndpoint</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@Inject</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">Database</span> <span style="color: #24292f;background-color: #f6f8fa">database</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@GET</span>
    <span style="color: #8250df">@Produces</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"text/html"</span><span style="color: #0550ae">)</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">Response</span> <span style="color: #8250df">get</span><span style="color: #0550ae">(</span><span style="color: #8250df">@Context</span> <span style="color: #953800">HttpServletRequest</span> <span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">)</span>
        <span style="color: #cf222e">throws</span> <span style="color: #953800">OAuthSystemException</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">try</span> <span style="color: #0550ae">{</span>
            <span style="color: #6e7781">// Make the OAuth Request out of this request</span>
            <span style="color: #953800">OAuthAccessResourceRequest</span> <span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span> <span style="color: #0550ae">=</span>
                <span style="color: #cf222e">new</span> <span style="color: #8250df">OAuthAccessResourceRequest</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">,</span> <span style="color: #953800">ParameterStyle</span><span style="color: #0550ae">.</span><span style="color: #116329">HEADER</span><span style="color: #0550ae">);</span>
            <span style="color: #6e7781">// Get the access token</span>
            <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">accessToken</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">oauthRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">getAccessToken</span><span style="color: #0550ae">();</span>

            <span style="color: #6e7781">// Validate the access token</span>
            <span style="color: #cf222e">if</span> <span style="color: #0550ae">(!</span><span style="color: #24292f;background-color: #f6f8fa">database</span><span style="color: #0550ae">.</span><span style="color: #116329">isValidToken</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">accessToken</span><span style="color: #0550ae">))</span> <span style="color: #0550ae">{</span>
                <span style="color: #6e7781">// Return the OAuth error message</span>
                <span style="color: #953800">OAuthResponse</span> <span style="color: #24292f;background-color: #f6f8fa">oauthResponse</span> <span style="color: #0550ae">=</span> <span style="color: #953800">OAuthRSResponse</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">errorResponse</span><span style="color: #0550ae">(</span><span style="color: #953800">HttpServletResponse</span><span style="color: #0550ae">.</span><span style="color: #116329">SC_UNAUTHORIZED</span><span style="color: #0550ae">)</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">setRealm</span><span style="color: #0550ae">(</span><span style="color: #953800">Common</span><span style="color: #0550ae">.</span><span style="color: #116329">RESOURCE_SERVER_NAME</span><span style="color: #0550ae">)</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">setError</span><span style="color: #0550ae">(</span><span style="color: #953800">OAuthError</span><span style="color: #0550ae">.</span><span style="color: #116329">ResourceResponse</span><span style="color: #0550ae">.</span><span style="color: #116329">INVALID_TOKEN</span><span style="color: #0550ae">)</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">buildHeaderMessage</span><span style="color: #0550ae">();</span>

                <span style="color: #6e7781">//return Response.status(Response.Status.UNAUTHORIZED).build();</span>
                <span style="color: #cf222e">return</span> <span style="color: #953800">Response</span><span style="color: #0550ae">.</span><span style="color: #116329">status</span><span style="color: #0550ae">(</span><span style="color: #953800">Response</span><span style="color: #0550ae">.</span><span style="color: #116329">Status</span><span style="color: #0550ae">.</span><span style="color: #116329">UNAUTHORIZED</span><span style="color: #0550ae">)</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">header</span><span style="color: #0550ae">(</span><span style="color: #953800">OAuth</span><span style="color: #0550ae">.</span><span style="color: #116329">HeaderType</span><span style="color: #0550ae">.</span><span style="color: #116329">WWW_AUTHENTICATE</span><span style="color: #0550ae">,</span>
                        <span style="color: #24292f;background-color: #f6f8fa">oauthResponse</span>
                            <span style="color: #0550ae">.</span><span style="color: #116329">getHeader</span><span style="color: #0550ae">(</span><span style="color: #953800">OAuth</span><span style="color: #0550ae">.</span><span style="color: #116329">HeaderType</span><span style="color: #0550ae">.</span><span style="color: #116329">WWW_AUTHENTICATE</span><span style="color: #0550ae">))</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>

            <span style="color: #0550ae">}</span>
            <span style="color: #6e7781">// [1]</span>
            <span style="color: #cf222e">return</span> <span style="color: #953800">Response</span><span style="color: #0550ae">.</span><span style="color: #116329">status</span><span style="color: #0550ae">(</span><span style="color: #953800">Response</span><span style="color: #0550ae">.</span><span style="color: #116329">Status</span><span style="color: #0550ae">.</span><span style="color: #116329">OK</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">entity</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">accessToken</span><span style="color: #0550ae">).</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span> <span style="color: #cf222e">catch</span> <span style="color: #0550ae">(</span><span style="color: #953800">OAuthProblemException</span> <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #6e7781">// Check if the error code has been set</span>
            <span style="color: #6e7781">// Build error response....</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s quite a bit of boilerplate code there to validate the access token. It&#8217;s not until [1] that we actually do the work the resource was written to do (which is, in this case, simply returning the accessToken).  Clearly, that&#8217;s too much work to be repeated, so that really should be factored out. For our purposes here, though, I&#8217;ll leave that as an exercise for the reader. If you watch the <a href="https://bitbucket.org/jdlee/oauth2-example">git repo</a> for this example, though, you should find a solution for this at some point. :)</p>
</div>
<div class="paragraph">
<p>That about covers the server side. In the next post, we&#8217;ll cover <em>TheUser</em>, which are the unit tests that drive/test our implementation.</p>
</div>
    </div>
    <footer>
        <div class="grid">
            <div class="col tags">
                
                <span class="title">tags: </span>
                
                <a href="/tag/java-ee/">Java EE</a>
                <!--                <a href="https://jasondl.ee/tags/Java EE.html">Java EE</a>-->
                
                <a href="/tag/oauth2/">OAuth2</a>
                <!--                <a href="https://jasondl.ee/tags/OAuth2.html">OAuth2</a>-->
                
                <a href="/tag/rest/">REST</a>
                <!--                <a href="https://jasondl.ee/tags/REST.html">REST</a>-->
                
                <a href="/tag/jax-rs/">JAX-RS</a>
                <!--                <a href="https://jasondl.ee/tags/JAX-RS.html">JAX-RS</a>-->
                
                
            </div>
            <div class="col"><span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2013/a-simple-oauth2-client-and-server-example-part-i&title=A Simple OAuth2 Client and Server Example: Part I" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=A Simple OAuth2 Client and Server Example: Part I&url=https://jasondl.ee/2013/a-simple-oauth2-client-and-server-example-part-i&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2013/a-simple-oauth2-client-and-server-example-part-i" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2013/a-simple-oauth2-client-and-server-example-part-i" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=A Simple OAuth2 Client and Server Example: Part I&amp;body=A Simple OAuth2 Client and Server Example: Part I https://jasondl.ee/2013/a-simple-oauth2-client-and-server-example-part-i" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>
</div>
        </div>
    </footer>
</article>

        </div>
    </div>
    <div class="col-3 widget">
        <div>
            <h3>Search</h3>
            <!-- HTML elements for search -->
            <input type="text" id="search-input" placeholder="Search blog posts.." style="width: 98%"/>
            <ul id="results-container"></ul>

            <script>
                var sjs = SimpleJekyllSearch({
                    searchInput: document.getElementById('search-input'),
                    resultsContainer: document.getElementById('results-container'),
                    json: '/search.json',
                    limit: 50
                })
            </script>
        </div>
        <div>
            <h3>Quotes</h3>
            <p id="quote">Sample quote</p>
            <p id="source">Quote source</p>
        </div>
        <div>
            <h3>About</h3>
            <p><img src="/images/profile-pic.jpg" style="float:right; object-fit: scale-down; padding-bottom: 1em;"/>My name is Jason Lee. I am a software developer living in the middle of Oklahoma. I’ve been a professional developer since 1997,
using a variety of languages, including Java, Javascript, PHP, Python, Delphi, and even a bit of C#. I currently work for Red Hat
on the WildFly/EAP team, where, among other things, I maintain integrations for some MicroProfile specs, OpenTelemetry, Micrometer,
Jakarta Faces, and Bean Validation. (Full resume <a href="resume">here</a>.
LinkedIn <a href="https://www.linkedin.com/in/jasondlee">profile</a>)</p>

<p>I am the president of the Oklahoma City JUG, and an occasional speaker at the JUG and a variety of technical conferences.</p>

<p>On the personal side, I’m active in my church, and enjoy bass guitar, running, fishing, and a variety of martial arts. I’m also
married to a beautiful woman, and have two boys, who, thankfully, look like their mother.</p>

        </div>
        <div>
            <h3>My Links</h3>
            <ul>
                
                <li>
                    <a href="/presentations" title="Presentations">
                        Presentations
                    </a>
                </li>
                
                <li>
                    <a href="/assets/resume.pdf" title="Resume/CV">
                        Resume/CV
                    </a>
                </li>
                
                <li>
                    <a href="https://linkedin.com/in/jasondlee" title="LinkedIn">
                        LinkedIn
                    </a>
                </li>
                
                <li>
                    <a href="https://twitter.com/jasondlee" title="Twitter">
                        Twitter
                    </a>
                </li>
                
                <li>
                    <a href="https://mastodon.cloud/@jasondlee" title="Mastodon">
                        Mastodon
                    </a>
                </li>
                
                <li>
                    <a href="/tag" title="Tags">
                        Tags
                    </a>
                </li>
                
            </ul>

        </div>
        <div>
            <h3>Publications</h3>
            <ul>
                <li>
                    <div class="grid">
                        <div class="col-8" style="text-weight: bold; font-size: large">
                            <div>Java 9 Programming Blueprints:</div>
                            <div>
                                <a title="My Java 9 book at Amazon" href="https://amzn.to/2FD2XAo" style="padding-left: 10px">Amazon</a>
                            </div>
                            <div>
                                <a title="My Java 9 book at Packt"
                                   href="https://www.packtpub.com/application-development/java-9-programming-blueprints"
                                   style="padding-left: 10px">Packt</a>
                            </div>
                        </div>
                            <div class="col-4">
                                <a href="https://amzn.to/2FD2XAo"><img src="/images/2017/j9pb.png" width="100"/></a>
                            </div>
                    </div>
                </li>
                
                <li>
                    <a href="https://jaxenter.com/tips-for-writing-pluggable-java-ee-applications-105281.html" title="This article discusses ways to use Java EE specs to implement a simple, yet powerful plugin system with a minimum of thrid party libraries.">
                        Tips for Writing Pluggable Java EE Applications
                    </a>
                </li>
                
                <li>
                    <a href="http://www.oracle.com/technetwork/articles/javaee/jsf-templating-137822.html" title="An article Ken Paulsen and I wrote detailing easy JSF component creation">
                        JSFTemplating and Woodstock: Component Authoring Made Easy
                    </a>
                </li>
                
                <li>
                    <a href="http://jsfcentral.com/articles/lee-03-09.html" title="Jason Lee in depth: Mojarra and Scales">
                        Jason Lee in depth: Mojarra and Scales
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20090301060746/http://www.theserverside.com/news/thread.tss?thread_id=49343" title="My JavaOne 2008 Wrap Up">
                        Jason Lee: Postmortem for JavaOne 2008
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20130621192312/https://blogs.oracle.com/stories/entry/international_environmental" title="The GlassFish Adoption Story from my time at IEC">
                        International Environmental: A Cooling Company Which Prefers Hot Software
                    </a>
                </li>
                
                <li>
                    <a href="http://www.jsfcentral.com/articles/trenches_7.html" title="This details the project that spawned a couple of the Mojarra Scales components">
                        IEC donates custom JSF component to Mojarra Scales
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>
<div class="footer">
    <div>
        <p>&#169; Copyright Jason Lee, 2005-2023. All rights reserved.</p>
    </div>
</div>
<!--
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-1091049-6', 'auto');
    ga('send', 'pageview');
</script>
-->
<script src="/assets/js/quotes.js" type="text/javascript"></script>
<script src="/assets/js/local.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script type="text/javascript" src="/assets/js/copy.js"></script>
</body>
</html>
