<!DOCTYPE html>
<html>
<head>
    <title>Coming Up for Air : Microprofile Fault Tolerance Retry in Action</title>

    <script src="/assets/js/simple-jekyll-search.min.js" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3GQK1YDRQM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-3GQK1YDRQM');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="me" href="https://mastodon.cloud/@jasondlee"/>

    <link rel="alternate" type="application/rss+xml" title="jasondl.ee RSS feed" href="/feed.xml">

    <link rel="stylesheet" href="/assets/css/main.css" />

    <!-- Web Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Cherry+Cream+Soda">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Philosopher">
    <link rel="stylesheet" type="text/css" href="/assets/css/font-awesome.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/primeflex@3.1.2/primeflex.css"/>
    <link rel="stylesheet" href="https://unpkg.com/primeflex/themes/saga-blue.css"/>
    <link rel="author" href="/images/profile-pic.jpg"/>
</head>
<body>
<div class="grid">
    <div class="col blogname">
        <span>
            <a href="https://jasondl.ee">Coming Up for Air</a>
        </span>
    </div>
</div>
<div class="grid main">
    <div class="col-9">
        <div id="content">
            <article class="post">
    <h1 class="title" style="border-bottom: solid 1px #47586d; margin-bottom: 0.25rem;">
        Microprofile Fault Tolerance Retry in Action
    </h1>
    Tuesday, March 02, 2021 | <span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2021/microprofile-fault-tolerance-retry-in-action&title=Microprofile Fault Tolerance Retry in Action" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Microprofile Fault Tolerance Retry in Action&url=https://jasondl.ee/2021/microprofile-fault-tolerance-retry-in-action&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2021/microprofile-fault-tolerance-retry-in-action" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2021/microprofile-fault-tolerance-retry-in-action" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Microprofile Fault Tolerance Retry in Action&amp;body=Microprofile Fault Tolerance Retry in Action https://jasondl.ee/2021/microprofile-fault-tolerance-retry-in-action" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>

    <div>
        <div class="paragraph">
<p>As part of some of my recent work, I&#8217;ve gotten some exposure to some Microprofile specs I&#8217;ve not had the opportunity or need to use. One of those is <a href="https://github.com/eclipse/microprofile-fault-tolerance">Fault Tolerance</a>. I was curious to see it action, so I&#8217;ve cobbled together this simple example that demonstrates some of that spec&#8217;s features, namely retries and fallback.</p>
</div>
<div class="paragraph">
<p>It should be noted that the Fault Tolerance spec actually provides several mechanisms to improve the reliability of a distributed system including timeouts, retries, bulkheads, circuit breakers, and fallbacks. We are only going to look at retries and fallbacks here. Perhaps in a future post we&#8217;ll explore the others.</p>
</div>
<div class="paragraph">
<p>To start, let&#8217;s describe our (contrived) scenario and show the code. We&#8217;re going to implement a simple REST service that calls an external service. In this case, we&#8217;re going to submit a search request to Google. (We won&#8217;t be using any API for this, just a simple GET request. There&#8217;s no need for anything more complicated at this point). To that end, here&#8217;s our gem:</p>
</div>
<div class="listingblock">
<div class="title">FailingResource.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/failing"</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">FailingResource</span> <span style="color: #0550ae">{</span>

    <span style="color: #8250df">@Inject</span>
    <span style="color: #8250df">@RestClient</span>
    <span style="color: #953800">GoogleClient</span> <span style="color: #24292f;background-color: #f6f8fa">client</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@GET</span>
    <span style="color: #8250df">@Produces</span><span style="color: #0550ae">(</span><span style="color: #953800">MediaType</span><span style="color: #0550ae">.</span><span style="color: #116329">TEXT_PLAIN</span><span style="color: #0550ae">)</span>
    <span style="color: #8250df">@Retry</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">maxRetries</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span><span style="color: #0550ae">,</span>
           <span style="color: #24292f;background-color: #f6f8fa">delay</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">200</span><span style="color: #0550ae">,</span>
           <span style="color: #24292f;background-color: #f6f8fa">jitter</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">100</span><span style="color: #0550ae">)</span>
    <span style="color: #8250df">@Fallback</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">fallbackMethod</span> <span style="color: #0550ae">=</span> <span style="color: #0a3069">"doWorkFallback"</span><span style="color: #0550ae">)</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">String</span> <span style="color: #8250df">hello</span><span style="color: #0550ae">()</span> <span style="color: #cf222e">throws</span> <span style="color: #953800">URISyntaxException</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">client</span><span style="color: #0550ae">.</span><span style="color: #116329">search</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"microprofile"</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #cf222e">private</span> <span style="color: #953800">String</span> <span style="color: #8250df">doWorkFallback</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #0a3069">"fallback"</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a pretty vanilla resource. On the resource method itself, note that we have two additional annotionations: <code>@Retry</code> and <code>@Fallback</code>. Using <code>@Retry</code>, we specifiy how many times the method should be called (<code>maxRetries</code>), how long to wait between invocations (<code>delay</code>), as well as a random "jitter", or variation, in the delay (<code>jitter</code>). Should <code>maxRetries</code> be exceeded, <code>@Fallback</code> comes into play, instructing the system to call <code>doWorkFallback()</code>.</p>
</div>
<div class="paragraph">
<p>In this example, we&#8217;re also using the <a href="https://microprofile.io/project/eclipse/microprofile-rest-client">Microprofile REST Client</a>. Note the injection of a <code>GoogleClient</code>:</p>
</div>
<div class="listingblock">
<div class="title">GoogleClient.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span style="color: #8250df">@RegisterRestClient</span>
<span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/"</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">interface</span> <span style="color: #953800">GoogleClient</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@GET</span>
    <span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"search"</span><span style="color: #0550ae">)</span>
    <span style="color: #953800">String</span> <span style="color: #8250df">search</span><span style="color: #0550ae">(</span><span style="color: #8250df">@QueryParam</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"q"</span><span style="color: #0550ae">)</span> <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">text</span><span style="color: #0550ae">);</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>I don&#8217;t want to spend too much time here, so I&#8217;ll just note that the MP REST Client allows us to create a type-safe REST client as an <code>interface</code>, with which "the system" will then create a concrete instance that does the actual work of making the remote calls. We configure that client using yet another specification, <a href="https://microprofile.io/project/eclipse/microprofile-config">Microprofile Config</a>:</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre>com.steeplesoft.GoogleClient/mp-rest/url=https://www.google.com
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The client will make requests against <a href="https://www.google.com" class="bare">https://www.google.com</a>, but, for testing, we&#8217;ll need to change that. We&#8217;ll see how to do that in a bit.</p>
</div>
<div class="paragraph">
<p>As in my <a href="securing-and-testing-quarkus.html">last post</a>, we&#8217;re going to test this using <a href="https://wiremock.org">Wiremock</a>. Before we jump into the code, though, let&#8217;s talk about how we need to go about testing this. Obviously, the point of the exercise to see Fault Tolerance&#8217;s retry and fallback in action. From what we saw in the last post, though, it seems we configure Wiremock to return certain response for each request to a given endpoint. While that is certainly true, Wiremock does allow us to change what the response is based on something they call <a href="http://wiremock.org/docs/stateful-behaviour/">scenarios</a>.</p>
</div>
<div class="paragraph">
<p>A scenarios is "essentially a state machine whose states can be arbitrarily assigned." They are arbitrarily named using string names, but always start with <code>Scenario.STARTED</code>. Using the Wiremock API, we can advance the scenario from one state to another based on various aspects of the request (such as reqest body, query params, etc). In our example, though, we just want it to fail a certain number of times, then, possibly, not fail. Let&#8217;s see what that looks like.</p>
</div>
<div class="listingblock">
<div class="title">FailingResourceTest.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span style="color: #8250df">@QuarkusTest</span>
<span style="color: #8250df">@QuarkusTestResource</span><span style="color: #0550ae">(</span><span style="color: #953800">MockServer</span><span style="color: #0550ae">.</span><span style="color: #116329">class</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">FailingResourceTest</span> <span style="color: #0550ae">{</span>

    <span style="color: #cf222e">public</span> <span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">String</span> <span style="color: #953800">SCENARIO_NAME</span> <span style="color: #0550ae">=</span> <span style="color: #0a3069">"Failing Resource"</span><span style="color: #0550ae">;</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">String</span><span style="color: #0550ae">[]</span> <span style="color: #953800">STATES</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">String</span><span style="color: #0550ae">[]{</span><span style="color: #0a3069">"one"</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"two"</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"three"</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"four"</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"five"</span><span style="color: #0550ae">};</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">static</span> <span style="color: #cf222e">final</span> <span style="color: #953800">String</span> <span style="color: #953800">REQUEST_URL</span> <span style="color: #0550ae">=</span> <span style="color: #0a3069">"/search?q=microprofile"</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@Test</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">testSuccessfulRetry</span><span style="color: #0550ae">()</span> <span style="color: #cf222e">throws</span> <span style="color: #953800">URISyntaxException</span> <span style="color: #0550ae">{</span>
        <span style="color: #24292f;background-color: #f6f8fa">reset</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">stubFor</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">get</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">urlEqualTo</span><span style="color: #0550ae">(</span><span style="color: #953800">REQUEST_URL</span><span style="color: #0550ae">))</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">inScenario</span><span style="color: #0550ae">(</span><span style="color: #953800">SCENARIO_NAME</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">whenScenarioStateIs</span><span style="color: #0550ae">(</span><span style="color: #953800">Scenario</span><span style="color: #0550ae">.</span><span style="color: #116329">STARTED</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">willReturn</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">aResponse</span><span style="color: #0550ae">().</span><span style="color: #116329">withStatus</span><span style="color: #0550ae">(</span><span style="color: #0550ae">500</span><span style="color: #0550ae">))</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">willSetStateTo</span><span style="color: #0550ae">(</span><span style="color: #953800">STATES</span><span style="color: #0550ae">[</span><span style="color: #0550ae">0</span><span style="color: #0550ae">]));</span>
        <span style="color: #24292f;background-color: #f6f8fa">stubFor</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">get</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">urlEqualTo</span><span style="color: #0550ae">(</span><span style="color: #953800">REQUEST_URL</span><span style="color: #0550ae">))</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">inScenario</span><span style="color: #0550ae">(</span><span style="color: #953800">SCENARIO_NAME</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">whenScenarioStateIs</span><span style="color: #0550ae">(</span><span style="color: #953800">STATES</span><span style="color: #0550ae">[</span><span style="color: #0550ae">0</span><span style="color: #0550ae">])</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">willReturn</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">aResponse</span><span style="color: #0550ae">().</span><span style="color: #116329">withStatus</span><span style="color: #0550ae">(</span><span style="color: #0550ae">500</span><span style="color: #0550ae">))</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">willSetStateTo</span><span style="color: #0550ae">(</span><span style="color: #953800">STATES</span><span style="color: #0550ae">[</span><span style="color: #0550ae">1</span><span style="color: #0550ae">]));</span>
        <span style="color: #24292f;background-color: #f6f8fa">stubFor</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">get</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">urlEqualTo</span><span style="color: #0550ae">(</span><span style="color: #953800">REQUEST_URL</span><span style="color: #0550ae">))</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">inScenario</span><span style="color: #0550ae">(</span><span style="color: #953800">SCENARIO_NAME</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">whenScenarioStateIs</span><span style="color: #0550ae">(</span><span style="color: #953800">STATES</span><span style="color: #0550ae">[</span><span style="color: #0550ae">1</span><span style="color: #0550ae">])</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">willReturn</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">aResponse</span><span style="color: #0550ae">().</span><span style="color: #116329">withBody</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"success"</span><span style="color: #0550ae">)));</span>

        <span style="color: #24292f;background-color: #f6f8fa">given</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">when</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">get</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/failing"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">then</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">statusCode</span><span style="color: #0550ae">(</span><span style="color: #0550ae">200</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">body</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">is</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"success"</span><span style="color: #0550ae">));</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>While it&#8217;s overkill, we call <code>reset()</code> at the start to&#8230;&#8203;wait for it&#8230;&#8203; reset the Wiremock state, making sure the stubs and scenarios are in a clean, known state. The need for that will become apparent shortly. The <code>stubFor()</code> calls follow this logic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For requests to <code>/search?q=microprofile</code>, if the scenario is <code>STARTED</code>, return a <code>500</code> error, and set the state to <code>one</code>.</p>
</li>
<li>
<p>For requests to <code>/search?q=microprofile</code>, if the scenario is <code>one</code>, return a <code>500</code> error, and set the state to <code>two</code>.</p>
</li>
<li>
<p>For requests to <code>/search?q=microprofile</code>, if the scenario is <code>two</code>, return a <code>200</code>, with a response body of <code>success</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now, using RestAssured, we call our resource, which calls the mocked server using the MP Rest Client we configured above. Before we can do that, though, we need to setup and start Wiremock:</p>
</div>
<div class="listingblock">
<div class="title">MockServer.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">MockServer</span> <span style="color: #cf222e">implements</span> <span style="color: #953800">QuarkusTestResourceLifecycleManager</span> <span style="color: #0550ae">{</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">WireMockServer</span> <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">Map</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">,</span> <span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #8250df">start</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">WireMockServer</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">.</span><span style="color: #116329">start</span><span style="color: #0550ae">();</span>

        <span style="color: #cf222e">return</span> <span style="color: #953800">Map</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"com.steeplesoft.GoogleClient/mp-rest/url"</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">.</span><span style="color: #116329">baseUrl</span><span style="color: #0550ae">());</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">stop</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">.</span><span style="color: #116329">stop</span><span style="color: #0550ae">();</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we&#8217;re stubbing the responses in our test, our setup is pretty simple. The super important part here, though, is the <code>Map</code> we return. Remember how we configure the REST Client using Microprofile Config? We can override the value of that configuration property by adding a key of the same name to the map, but providing the URL representing our mock server: <code>wireMockServer.baseUrl()</code>. Now if you run your test, you should get a green test. Huzzah!</p>
</div>
<div class="paragraph">
<p>But what about the retry? The fallback? Let&#8217;s add another test, with a slightly different scenario setup. Here&#8217;s where <code>reset()</code> is important ;)</p>
</div>
<div class="listingblock">
<div class="title">FailingResourceTest.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
</pre></td><td class="code"><pre>    <span style="color: #8250df">@Test</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">testUnsuccessfulRetry</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #24292f;background-color: #f6f8fa">reset</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">stubFor</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">get</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">urlEqualTo</span><span style="color: #0550ae">(</span><span style="color: #953800">REQUEST_URL</span><span style="color: #0550ae">))</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">inScenario</span><span style="color: #0550ae">(</span><span style="color: #953800">SCENARIO_NAME</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">whenScenarioStateIs</span><span style="color: #0550ae">(</span><span style="color: #953800">Scenario</span><span style="color: #0550ae">.</span><span style="color: #116329">STARTED</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">willReturn</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">aResponse</span><span style="color: #0550ae">().</span><span style="color: #116329">withStatus</span><span style="color: #0550ae">(</span><span style="color: #0550ae">500</span><span style="color: #0550ae">)));</span>

        <span style="color: #24292f;background-color: #f6f8fa">given</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">when</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">get</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/failing"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">then</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">statusCode</span><span style="color: #0550ae">(</span><span style="color: #0550ae">200</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">body</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">is</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"fallback"</span><span style="color: #0550ae">));</span>
    <span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this scenario, we will always return a <code>500</code> error since we don&#8217;t really care if "the server" ever recovers. We just want to attempts to fail over to our fallback method, in which case our resource returns "fallback".</p>
</div>
<div class="paragraph">
<p>There is much, much more to the Fault Tolerance spec, but that gives you a taste of what retry and fallback looks like. You can find the complete project <a href="https://github.com/jasondlee/mpft-wiremock">here</a>.</p>
</div>
    </div>
    <footer>
        <div class="grid">
            <div class="col tags">
                
                <span class="title">tags: </span>
                
                <a href="/tag/java/">Java</a>
                <!--                <a href="https://jasondl.ee/tags/Java.html">Java</a>-->
                
                <a href="/tag/quarkus/">Quarkus</a>
                <!--                <a href="https://jasondl.ee/tags/Quarkus.html">Quarkus</a>-->
                
                <a href="/tag/microprofile/">MicroProfile</a>
                <!--                <a href="https://jasondl.ee/tags/MicroProfile.html">MicroProfile</a>-->
                
                <a href="/tag/fault-tolerance/">Fault Tolerance</a>
                <!--                <a href="https://jasondl.ee/tags/Fault Tolerance.html">Fault Tolerance</a>-->
                
                <a href="/tag/wiremock/">Wiremock</a>
                <!--                <a href="https://jasondl.ee/tags/Wiremock.html">Wiremock</a>-->
                
                
            </div>
            <div class="col"><span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2021/microprofile-fault-tolerance-retry-in-action&title=Microprofile Fault Tolerance Retry in Action" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Microprofile Fault Tolerance Retry in Action&url=https://jasondl.ee/2021/microprofile-fault-tolerance-retry-in-action&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2021/microprofile-fault-tolerance-retry-in-action" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2021/microprofile-fault-tolerance-retry-in-action" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Microprofile Fault Tolerance Retry in Action&amp;body=Microprofile Fault Tolerance Retry in Action https://jasondl.ee/2021/microprofile-fault-tolerance-retry-in-action" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>
</div>
        </div>
    </footer>
</article>

        </div>
    </div>
    <div class="col-3 widget">
        <div>
            <h3>Search</h3>
            <!-- HTML elements for search -->
            <input type="text" id="search-input" placeholder="Search blog posts.." style="width: 98%"/>
            <ul id="results-container"></ul>

            <script>
                var sjs = SimpleJekyllSearch({
                    searchInput: document.getElementById('search-input'),
                    resultsContainer: document.getElementById('results-container'),
                    json: '/search.json',
                    limit: 50
                })
            </script>
        </div>
        <div>
            <h3>Quotes</h3>
            <p id="quote">Sample quote</p>
            <p id="source">Quote source</p>
        </div>
        <div>
            <h3>About</h3>
            <p><img src="/images/profile-pic.jpg" style="float:right; object-fit: scale-down; padding-bottom: 1em;"/>My name is Jason Lee. I am a software developer living in the middle of Oklahoma. I’ve been a professional developer since 1997,
using a variety of languages, including Java, Javascript, PHP, Python, Delphi, and even a bit of C#. I currently work for Red Hat
on the WildFly/EAP team, where, among other things, I maintain integrations for some MicroProfile specs, OpenTelemetry, Micrometer,
Jakarta Faces, and Bean Validation. (Full resume <a href="resume">here</a>.
LinkedIn <a href="https://www.linkedin.com/in/jasondlee">profile</a>)</p>

<p>I am the president of the Oklahoma City JUG, and an occasional speaker at the JUG and a variety of technical conferences.</p>

<p>On the personal side, I’m active in my church, and enjoy bass guitar, running, fishing, and a variety of martial arts. I’m also
married to a beautiful woman, and have two boys, who, thankfully, look like their mother.</p>

        </div>
        <div>
            <h3>My Links</h3>
            <ul>
                
                <li>
                    <a href="/presentations" title="Presentations">
                        Presentations
                    </a>
                </li>
                
                <li>
                    <a href="/assets/resume.pdf" title="Resume/CV">
                        Resume/CV
                    </a>
                </li>
                
                <li>
                    <a href="https://linkedin.com/in/jasondlee" title="LinkedIn">
                        LinkedIn
                    </a>
                </li>
                
                <li>
                    <a href="https://twitter.com/jasondlee" title="Twitter">
                        Twitter
                    </a>
                </li>
                
                <li>
                    <a href="https://mastodon.cloud/@jasondlee" title="Mastodon">
                        Mastodon
                    </a>
                </li>
                
                <li>
                    <a href="/tag" title="Tags">
                        Tags
                    </a>
                </li>
                
            </ul>

        </div>
        <div>
            <h3>Publications</h3>
            <ul>
                <li>
                    <div class="grid">
                        <div class="col-8" style="text-weight: bold; font-size: large">
                            <div>Java 9 Programming Blueprints:</div>
                            <div>
                                <a title="My Java 9 book at Amazon" href="https://amzn.to/2FD2XAo" style="padding-left: 10px">Amazon</a>
                            </div>
                            <div>
                                <a title="My Java 9 book at Packt"
                                   href="https://www.packtpub.com/application-development/java-9-programming-blueprints"
                                   style="padding-left: 10px">Packt</a>
                            </div>
                        </div>
                            <div class="col-4">
                                <a href="https://amzn.to/2FD2XAo"><img src="/images/2017/j9pb.png" width="100"/></a>
                            </div>
                    </div>
                </li>
                
                <li>
                    <a href="https://jaxenter.com/tips-for-writing-pluggable-java-ee-applications-105281.html" title="This article discusses ways to use Java EE specs to implement a simple, yet powerful plugin system with a minimum of thrid party libraries.">
                        Tips for Writing Pluggable Java EE Applications
                    </a>
                </li>
                
                <li>
                    <a href="http://www.oracle.com/technetwork/articles/javaee/jsf-templating-137822.html" title="An article Ken Paulsen and I wrote detailing easy JSF component creation">
                        JSFTemplating and Woodstock: Component Authoring Made Easy
                    </a>
                </li>
                
                <li>
                    <a href="http://jsfcentral.com/articles/lee-03-09.html" title="Jason Lee in depth: Mojarra and Scales">
                        Jason Lee in depth: Mojarra and Scales
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20090301060746/http://www.theserverside.com/news/thread.tss?thread_id=49343" title="My JavaOne 2008 Wrap Up">
                        Jason Lee: Postmortem for JavaOne 2008
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20130621192312/https://blogs.oracle.com/stories/entry/international_environmental" title="The GlassFish Adoption Story from my time at IEC">
                        International Environmental: A Cooling Company Which Prefers Hot Software
                    </a>
                </li>
                
                <li>
                    <a href="http://www.jsfcentral.com/articles/trenches_7.html" title="This details the project that spawned a couple of the Mojarra Scales components">
                        IEC donates custom JSF component to Mojarra Scales
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>
<div class="footer">
    <div>
        <p>&#169; Copyright Jason Lee, 2005-2023. All rights reserved.</p>
    </div>
</div>
<!--
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-1091049-6', 'auto');
    ga('send', 'pageview');
</script>
-->
<script src="/assets/js/quotes.js" type="text/javascript"></script>
<script src="/assets/js/local.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script type="text/javascript" src="/assets/js/copy.js"></script>
</body>
</html>
