<!DOCTYPE html>
<html>
<head>
    <title>Coming Up for Air : OpenTelemetry and Jakarta REST Services</title>

    <script src="/assets/js/simple-jekyll-search.min.js" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3GQK1YDRQM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-3GQK1YDRQM');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="me" href="https://mastodon.cloud/@jasondlee"/>

    <link rel="alternate" type="application/rss+xml" title="jasondl.ee RSS feed" href="/feed.xml">

    <link rel="stylesheet" href="/assets/css/main.css" />

    <!-- Web Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Cherry+Cream+Soda">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Philosopher">
    <link rel="stylesheet" type="text/css" href="/assets/css/font-awesome.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/primeflex@3.1.2/primeflex.css"/>
    <link rel="stylesheet" href="https://unpkg.com/primeflex/themes/saga-blue.css"/>
    <link rel="author" href="/images/profile-pic.jpg"/>
</head>
<body>
<div class="grid">
    <div class="col blogname">
        <span>
            <a href="https://jasondl.ee">Coming Up for Air</a>
        </span>
    </div>
</div>
<div class="grid main">
    <div class="col-9">
        <div id="content">
            <article class="post">
    <h1 class="title" style="border-bottom: solid 1px #47586d; margin-bottom: 0.25rem;">
        OpenTelemetry and Jakarta REST Services
    </h1>
    Wednesday, June 02, 2021 | <span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2021/opentelemetry-and-jakarta-rest-services&title=OpenTelemetry and Jakarta REST Services" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=OpenTelemetry and Jakarta REST Services&url=https://jasondl.ee/2021/opentelemetry-and-jakarta-rest-services&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2021/opentelemetry-and-jakarta-rest-services" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2021/opentelemetry-and-jakarta-rest-services" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=OpenTelemetry and Jakarta REST Services&amp;body=OpenTelemetry and Jakarta REST Services https://jasondl.ee/2021/opentelemetry-and-jakarta-rest-services" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>

    <div>
        <div class="paragraph">
<p>Knowing what&#8217;s going on in your microservices deployment is extremely important when something goes wrong. In a distributed system, though, it can be difficult to know where things have gone wrong. That&#8217;s where a tracing system such as <a href="https://opentelemetry.io">OpenTelemetry</a> can be immensely valuable. In this post, we&#8217;ll build two simple services, one of which calls the other, and trace the execution from end to end.</p>
</div>
<div class="sect1">
<h2 id="the-parent-pom">The Parent POM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll start by setting up the project, and we&#8217;ll do so by creating a multimodule Maven pom:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="code"><pre><span style="color: #116329">&lt;project</span> <span style="color: #116329">xmlns=</span><span style="color: #0a3069">"http://maven.apache.org/POM/4.0.0"</span>
         <span style="color: #116329">xmlns:xsi=</span><span style="color: #0a3069">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span style="color: #116329">xsi:schemaLocation=</span><span style="color: #0a3069">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span style="color: #116329">&gt;</span>
    <span style="color: #116329">&lt;modelVersion&gt;</span>4.0.0<span style="color: #116329">&lt;/modelVersion&gt;</span>

    <span style="color: #116329">&lt;groupId&gt;</span>com.steeplesoft.otel<span style="color: #116329">&lt;/groupId&gt;</span>
    <span style="color: #116329">&lt;artifactId&gt;</span>multiservice-demo<span style="color: #116329">&lt;/artifactId&gt;</span>
    <span style="color: #116329">&lt;version&gt;</span>1.0-SNAPSHOT<span style="color: #116329">&lt;/version&gt;</span>
    <span style="color: #116329">&lt;packaging&gt;</span>pom<span style="color: #116329">&lt;/packaging&gt;</span>

    <span style="color: #116329">&lt;modules&gt;</span>
        <span style="color: #116329">&lt;module&gt;</span>otel-integration<span style="color: #116329">&lt;/module&gt;</span>
        <span style="color: #116329">&lt;module&gt;</span>service1<span style="color: #116329">&lt;/module&gt;</span>
        <span style="color: #116329">&lt;module&gt;</span>service2<span style="color: #116329">&lt;/module&gt;</span>
    <span style="color: #116329">&lt;/modules&gt;</span>

    <span style="color: #116329">&lt;properties&gt;</span>
        <span style="color: #116329">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span style="color: #116329">&lt;/project.build.sourceEncoding&gt;</span>
        <span style="color: #116329">&lt;maven.compiler.source&gt;</span>11<span style="color: #116329">&lt;/maven.compiler.source&gt;</span>
        <span style="color: #116329">&lt;maven.compiler.target&gt;</span>11<span style="color: #116329">&lt;/maven.compiler.target&gt;</span>
    <span style="color: #116329">&lt;/properties&gt;</span>

    <span style="color: #116329">&lt;dependencyManagement&gt;</span>
        <span style="color: #116329">&lt;dependencies&gt;</span>
            <span style="color: #116329">&lt;dependency&gt;</span>
                <span style="color: #116329">&lt;groupId&gt;</span>io.opentelemetry<span style="color: #116329">&lt;/groupId&gt;</span>
                <span style="color: #116329">&lt;artifactId&gt;</span>opentelemetry-bom<span style="color: #116329">&lt;/artifactId&gt;</span>
                <span style="color: #116329">&lt;version&gt;</span>1.2.0<span style="color: #116329">&lt;/version&gt;</span>
                <span style="color: #116329">&lt;type&gt;</span>pom<span style="color: #116329">&lt;/type&gt;</span>
                <span style="color: #116329">&lt;scope&gt;</span>import<span style="color: #116329">&lt;/scope&gt;</span>
            <span style="color: #116329">&lt;/dependency&gt;</span>
        <span style="color: #116329">&lt;/dependencies&gt;</span>
    <span style="color: #116329">&lt;/dependencyManagement&gt;</span>
    <span style="color: #116329">&lt;dependencies&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>jakarta.ws.rs<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>jakarta.ws.rs-api<span style="color: #116329">&lt;/artifactId&gt;</span>
            <span style="color: #116329">&lt;version&gt;</span>2.1.6<span style="color: #116329">&lt;/version&gt;</span>
            <span style="color: #116329">&lt;scope&gt;</span>provided<span style="color: #116329">&lt;/scope&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>jakarta.enterprise<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>jakarta.enterprise.cdi-api<span style="color: #116329">&lt;/artifactId&gt;</span>
            <span style="color: #116329">&lt;version&gt;</span>2.0.2<span style="color: #116329">&lt;/version&gt;</span>
            <span style="color: #116329">&lt;scope&gt;</span>provided<span style="color: #116329">&lt;/scope&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>io.grpc<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>grpc-okhttp<span style="color: #116329">&lt;/artifactId&gt;</span>
            <span style="color: #116329">&lt;version&gt;</span>1.36.1<span style="color: #116329">&lt;/version&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>io.opentelemetry<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>opentelemetry-api<span style="color: #116329">&lt;/artifactId&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>io.opentelemetry<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>opentelemetry-sdk<span style="color: #116329">&lt;/artifactId&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>io.opentelemetry<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>opentelemetry-sdk-trace<span style="color: #116329">&lt;/artifactId&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>io.opentelemetry<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>opentelemetry-exporter-jaeger<span style="color: #116329">&lt;/artifactId&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
    <span style="color: #116329">&lt;/dependencies&gt;</span>
<span style="color: #116329">&lt;/project&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>By setting up the parent POM this way, we&#8217;ll make the three submodules much simpler. Since the two services are largely identical, we&#8217;ll only look at one of those POMs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-basic-rest-service">The Basic REST service</h2>
<div class="sectionbody">
<div class="listingblock xml">
<div class="title">service1/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre>&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;parent&gt;
        &lt;artifactId&gt;multiservice-demo&lt;/artifactId&gt;
        &lt;groupId&gt;com.steeplesoft.otel&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;

    &lt;artifactId&gt;service1&lt;/artifactId&gt;
    &lt;packaging&gt;war&lt;/packaging&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;${project.groupId}&lt;/groupId&gt;
            &lt;artifactId&gt;otel-integration&lt;/artifactId&gt;
            &lt;version&gt;${project.version}&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s really not much to this beyond a dependency on another module from our project, which we&#8217;ll look at shortly. First, our
REST endpoint:</p>
</div>
<div class="listingblock">
<div class="title">RestEndpoint1.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="code"><pre><span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/endpoint1"</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">RestEndpoint1</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@Inject</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">Tracer</span> <span style="color: #24292f;background-color: #f6f8fa">tracer</span><span style="color: #0550ae">;</span>
    <span style="color: #8250df">@Inject</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">OpenTelemetry</span> <span style="color: #24292f;background-color: #f6f8fa">otel</span><span style="color: #0550ae">;</span>


    <span style="color: #8250df">@GET</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">String</span> <span style="color: #8250df">method1</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">final</span> <span style="color: #953800">Span</span> <span style="color: #24292f;background-color: #f6f8fa">span</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">tracer</span><span style="color: #0550ae">.</span><span style="color: #116329">spanBuilder</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Doing some work"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">startSpan</span><span style="color: #0550ae">();</span>

        <span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">makeCurrent</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">setAttribute</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"in.my"</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"application"</span><span style="color: #0550ae">);</span>
        <span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">addEvent</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Test Event"</span><span style="color: #0550ae">);</span>
        <span style="color: #24292f;background-color: #f6f8fa">sleep</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">doSomeMoreWork</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">addEvent</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"After work"</span><span style="color: #0550ae">);</span>

        <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">service2</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">sendRequest</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">sleep</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">doEvenMoreWork</span><span style="color: #0550ae">();</span>

        <span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">end</span><span style="color: #0550ae">();</span>

        <span style="color: #cf222e">return</span> <span style="color: #0a3069">"Hello World, from service 1! Service 2 happened to say '"</span> <span style="color: #0550ae">+</span> <span style="color: #24292f;background-color: #f6f8fa">service2</span> <span style="color: #0550ae">+</span> <span style="color: #0a3069">"'"</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #cf222e">private</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">doSomeMoreWork</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">final</span> <span style="color: #953800">Span</span> <span style="color: #24292f;background-color: #f6f8fa">span</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">tracer</span><span style="color: #0550ae">.</span><span style="color: #116329">spanBuilder</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Doing some more work"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">startSpan</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">makeCurrent</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">sleep</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">doEvenMoreWork</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">end</span><span style="color: #0550ae">();</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #cf222e">private</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">doEvenMoreWork</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">final</span> <span style="color: #953800">Span</span> <span style="color: #24292f;background-color: #f6f8fa">span</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">tracer</span><span style="color: #0550ae">.</span><span style="color: #116329">spanBuilder</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Doing even more work"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">startSpan</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">makeCurrent</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">sleep</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">end</span><span style="color: #0550ae">();</span>
    <span style="color: #0550ae">}</span>
    <span style="color: #6e7781">// ...</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a pretty boring, if somewhat contrived, REST endpoint. The interesting part is the injection of the OpenTelemetry <code>Tracer</code> instance, and the creation of the spans in the REST method itself. From the <a href="https://opentelemetry.io/docs/concepts/data-sources/">OpenTelemetrey docs</a>, we learn that</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Traces track the progression of a single request, called a trace, as it is handled by services that make up an application&#8230;&#8203;Each unit of work in a trace is called a span; a trace is a tree of spans." and that "[s]pans are objects that represent the work being done by individual services or components involved in a request as it flows through a system.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In the midst of our "work", then, we create a span to track the process. This will help help us mark the beginning and end of unit of work. As we monitor the system, we can compute statistics on, for example, the average time a given span takes. Should it start deviating wildly, we may have found our issue&#8217;s culprit. The use of a span may look something like this, generically speaking:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span style="color: #953800">Span</span> <span style="color: #24292f;background-color: #f6f8fa">span</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">tracer</span><span style="color: #0550ae">.</span><span style="color: #116329">spanBuilder</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Doing some work"</span><span style="color: #0550ae">)</span>
    <span style="color: #0550ae">.</span><span style="color: #116329">startSpan</span><span style="color: #0550ae">();</span>
<span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">makeCurrent</span><span style="color: #0550ae">();</span>
<span style="color: #6e7781">// Do some work</span>
<span style="color: #24292f;background-color: #f6f8fa">span</span><span style="color: #0550ae">.</span><span style="color: #116329">end</span><span style="color: #0550ae">();</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>When creating the span, we want to give it a meaningful name so we can find it more easily when we look at the logs.</p>
</div>
<div class="paragraph">
<p>Remember, though, that a <code>trace</code> is a tree of <code>spans</code>. When we create the span here, OpenTelemetry automatically sets as its parent any span that might be current. In looking through our endpoint, we create several spans, and their parent span is automatically set for us so we can see the relationship of one span to another (e.g., "Span A" encompasses "Span B" through "Span D") to get a better picture of a request&#8217;s flow through the system.</p>
</div>
<div class="paragraph">
<p>While that&#8217;s all well and good, where do <code>OpenTelemetry</code> and <code>Tracer</code> come from? For that, let&#8217;s look at the <code>otel-integration</code> module.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="opentelemetry-integration-module">OpenTelemetry Integration Module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the moment, unless one is using OpenTelemetry&#8217;s automatic instrumentation to integrate the library, there&#8217;s a small bit of setup that is required. This module offers three classes that do that: one to produce the <code>OpenTelemetry</code> instance, one for the <code>Tracer</code>, and one to set up a Jakarta REST filter to automatically trace incoming requests.</p>
</div>
<div class="paragraph">
<p>The producer methods are fairly standard CDI producers. For <code>OpenTelemetry</code>, we have this:</p>
</div>
<div class="listingblock">
<div class="title">OpenTelemetryProducer.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="code"><pre><span style="color: #8250df">@ApplicationScoped</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">OpenTelemetryProducer</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@javax</span><span style="color: #0550ae">.</span><span style="color: #116329">annotation</span><span style="color: #0550ae">.</span><span style="color: #116329">Resource</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">lookup</span><span style="color: #0550ae">=</span><span style="color: #0a3069">"java:app/AppName"</span><span style="color: #0550ae">)</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">applicationName</span><span style="color: #0550ae">;</span>

    <span style="color: #cf222e">private</span> <span style="color: #cf222e">volatile</span> <span style="color: #953800">OpenTelemetry</span> <span style="color: #24292f;background-color: #f6f8fa">openTelemetry</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@Produces</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">OpenTelemetry</span> <span style="color: #8250df">getOpenTelemetryInstance</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">OpenTelemetry</span> <span style="color: #24292f;background-color: #f6f8fa">localRef</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">openTelemetry</span><span style="color: #0550ae">;</span>
        <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">localRef</span> <span style="color: #0550ae">==</span> <span style="color: #0550ae">null</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #cf222e">synchronized</span> <span style="color: #0550ae">(</span><span style="color: #cf222e">this</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
                <span style="color: #24292f;background-color: #f6f8fa">localRef</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">openTelemetry</span><span style="color: #0550ae">;</span>
                <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">localRef</span> <span style="color: #0550ae">==</span> <span style="color: #0550ae">null</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
                    <span style="color: #24292f;background-color: #f6f8fa">openTelemetry</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">localRef</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">localBuild</span><span style="color: #0550ae">();</span>
                <span style="color: #0550ae">}</span>
            <span style="color: #0550ae">}</span>
        <span style="color: #0550ae">}</span>

        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">localRef</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #cf222e">private</span> <span style="color: #953800">OpenTelemetrySdk</span> <span style="color: #8250df">localBuild</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">final</span> <span style="color: #953800">JaegerGrpcSpanExporterBuilder</span> <span style="color: #24292f;background-color: #f6f8fa">exporterBuilder</span> <span style="color: #0550ae">=</span> <span style="color: #953800">JaegerGrpcSpanExporter</span><span style="color: #0550ae">.</span><span style="color: #116329">builder</span><span style="color: #0550ae">();</span>
        <span style="color: #cf222e">final</span> <span style="color: #953800">BatchSpanProcessorBuilder</span> <span style="color: #24292f;background-color: #f6f8fa">spanProcessorBuilder</span> <span style="color: #0550ae">=</span> <span style="color: #953800">BatchSpanProcessor</span><span style="color: #0550ae">.</span><span style="color: #116329">builder</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">exporterBuilder</span><span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">());</span>

        <span style="color: #cf222e">final</span> <span style="color: #953800">SdkTracerProviderBuilder</span> <span style="color: #24292f;background-color: #f6f8fa">tracerProviderBuilder</span> <span style="color: #0550ae">=</span> <span style="color: #953800">SdkTracerProvider</span><span style="color: #0550ae">.</span><span style="color: #116329">builder</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">addSpanProcessor</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">spanProcessorBuilder</span><span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">())</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">setResource</span><span style="color: #0550ae">(</span><span style="color: #953800">Resource</span><span style="color: #0550ae">.</span><span style="color: #116329">create</span><span style="color: #0550ae">(</span><span style="color: #953800">Attributes</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span>
                        <span style="color: #953800">ResourceAttributes</span><span style="color: #0550ae">.</span><span style="color: #116329">SERVICE_NAME</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">applicationName</span><span style="color: #0550ae">,</span>
                        <span style="color: #953800">AttributeKey</span><span style="color: #0550ae">.</span><span style="color: #116329">stringKey</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"foo"</span><span style="color: #0550ae">),</span> <span style="color: #0a3069">"bar"</span><span style="color: #0550ae">)));</span>

        <span style="color: #cf222e">return</span> <span style="color: #953800">OpenTelemetrySdk</span><span style="color: #0550ae">.</span><span style="color: #116329">builder</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">setTracerProvider</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">tracerProviderBuilder</span><span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">())</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">setPropagators</span><span style="color: #0550ae">(</span><span style="color: #953800">ContextPropagators</span><span style="color: #0550ae">.</span><span style="color: #116329">create</span><span style="color: #0550ae">(</span><span style="color: #953800">W3CTraceContextPropagator</span><span style="color: #0550ae">.</span><span style="color: #116329">getInstance</span><span style="color: #0550ae">()))</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">buildAndRegisterGlobal</span><span style="color: #0550ae">();</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this application-scoped bean, we have a producer method that&#8230;&#8203; produces the <code>OpenTelemetry</code> instance, using the double-check idiom (you can read more about that <a href="https://www.oracle.com/technical-resources/articles/javase/bloch-effective-08-qa.html">here</a>, if you&#8217;re curious, and, yes, using it might be overkill, but better safe, eh? :) In the <code>localBuild()</code> method (so named to differentiate from the <code>GlobalOpenTelemetry.get()</code> approach), we define an exporter, which will export our trace information to an external system, Jaeger, for aggregation and study, and a <code>Tracer</code> provider, which lets us configure our <code>Tracer</code>. In this case, we want to use the Jakarta EE application name, injected into <code>applicationName</code> to set the service name (and we add a random attribute just to demonstrate where that might show up).</p>
</div>
<div class="paragraph">
<p>For the <code>Tracer</code>, we have something similar:</p>
</div>
<div class="listingblock">
<div class="title">TracerProvider.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span style="color: #8250df">@ApplicationScoped</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">TracerProducer</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@Inject</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">OpenTelemetry</span> <span style="color: #24292f;background-color: #f6f8fa">openTelemetry</span><span style="color: #0550ae">;</span>
    <span style="color: #cf222e">private</span> <span style="color: #cf222e">volatile</span> <span style="color: #953800">Tracer</span> <span style="color: #24292f;background-color: #f6f8fa">tracer</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@Produces</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">Tracer</span> <span style="color: #8250df">getTracer</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">Tracer</span> <span style="color: #24292f;background-color: #f6f8fa">localRef</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">tracer</span><span style="color: #0550ae">;</span>
        <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">localRef</span> <span style="color: #0550ae">==</span> <span style="color: #0550ae">null</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #cf222e">synchronized</span> <span style="color: #0550ae">(</span><span style="color: #cf222e">this</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
                <span style="color: #24292f;background-color: #f6f8fa">localRef</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">tracer</span><span style="color: #0550ae">;</span>
                <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">localRef</span> <span style="color: #0550ae">==</span> <span style="color: #0550ae">null</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
                    <span style="color: #24292f;background-color: #f6f8fa">tracer</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">localRef</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">openTelemetry</span><span style="color: #0550ae">.</span><span style="color: #116329">getTracer</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"com.steeplesoft.otel"</span><span style="color: #0550ae">,</span>
                            <span style="color: #0a3069">"1.0.0-SNAPSHOT"</span><span style="color: #0550ae">);</span>
                <span style="color: #0550ae">}</span>
            <span style="color: #0550ae">}</span>
        <span style="color: #0550ae">}</span>
        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">localRef</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only new thing of note here is simply the OpenTelemetry API call to get the <code>Tracer</code> instance.</p>
</div>
<div class="paragraph">
<p>Finally, let&#8217;s look at our request/response filter:</p>
</div>
<div class="listingblock">
<div class="title">OpenTelemetryFilter.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="code"><pre><span style="color: #8250df">@ApplicationScoped</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">OpenTelemetryFilter</span> <span style="color: #cf222e">implements</span> <span style="color: #953800">ContainerRequestFilter</span><span style="color: #0550ae">,</span> <span style="color: #953800">ContainerResponseFilter</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@Inject</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">OpenTelemetry</span> <span style="color: #24292f;background-color: #f6f8fa">openTelemetry</span><span style="color: #0550ae">;</span>
    <span style="color: #8250df">@Inject</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">Tracer</span> <span style="color: #24292f;background-color: #f6f8fa">tracer</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">filter</span><span style="color: #0550ae">(</span><span style="color: #953800">ContainerRequestContext</span> <span style="color: #24292f;background-color: #f6f8fa">requestContext</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">Context</span> <span style="color: #24292f;background-color: #f6f8fa">extractedContext</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">openTelemetry</span><span style="color: #0550ae">.</span><span style="color: #116329">getPropagators</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">getTextMapPropagator</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">extract</span><span style="color: #0550ae">(</span><span style="color: #953800">Context</span><span style="color: #0550ae">.</span><span style="color: #116329">current</span><span style="color: #0550ae">(),</span> <span style="color: #24292f;background-color: #f6f8fa">requestContext</span><span style="color: #0550ae">,</span> <span style="color: #cf222e">new</span> <span style="color: #953800">TextMapGetter</span><span style="color: #0550ae">&lt;&gt;()</span> <span style="color: #0550ae">{</span>
                    <span style="color: #8250df">@Override</span>
                    <span style="color: #cf222e">public</span> <span style="color: #953800">String</span> <span style="color: #8250df">get</span><span style="color: #0550ae">(</span><span style="color: #953800">ContainerRequestContext</span> <span style="color: #24292f;background-color: #f6f8fa">requestContext</span><span style="color: #0550ae">,</span> <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">key</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
                        <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">requestContext</span><span style="color: #0550ae">.</span><span style="color: #116329">getHeaders</span><span style="color: #0550ae">().</span><span style="color: #116329">containsKey</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">key</span><span style="color: #0550ae">))</span> <span style="color: #0550ae">{</span>
                            <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">requestContext</span><span style="color: #0550ae">.</span><span style="color: #116329">getHeaders</span><span style="color: #0550ae">().</span><span style="color: #116329">get</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">key</span><span style="color: #0550ae">).</span><span style="color: #116329">get</span><span style="color: #0550ae">(</span><span style="color: #0550ae">0</span><span style="color: #0550ae">);</span>
                        <span style="color: #0550ae">}</span>
                        <span style="color: #cf222e">return</span> <span style="color: #0550ae">null</span><span style="color: #0550ae">;</span>
                    <span style="color: #0550ae">}</span>

                    <span style="color: #8250df">@Override</span>
                    <span style="color: #cf222e">public</span> <span style="color: #953800">Iterable</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #8250df">keys</span><span style="color: #0550ae">(</span><span style="color: #953800">ContainerRequestContext</span> <span style="color: #24292f;background-color: #f6f8fa">requestContext</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
                        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">requestContext</span><span style="color: #0550ae">.</span><span style="color: #116329">getHeaders</span><span style="color: #0550ae">().</span><span style="color: #116329">keySet</span><span style="color: #0550ae">();</span>
                    <span style="color: #0550ae">}</span>
                <span style="color: #0550ae">});</span>
        <span style="color: #cf222e">final</span> <span style="color: #953800">UriInfo</span> <span style="color: #24292f;background-color: #f6f8fa">uriInfo</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">requestContext</span><span style="color: #0550ae">.</span><span style="color: #116329">getUriInfo</span><span style="color: #0550ae">();</span>
        <span style="color: #cf222e">final</span> <span style="color: #953800">URI</span> <span style="color: #24292f;background-color: #f6f8fa">requestUri</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">uriInfo</span><span style="color: #0550ae">.</span><span style="color: #116329">getRequestUri</span><span style="color: #0550ae">();</span>
        <span style="color: #cf222e">final</span> <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">method</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">requestContext</span><span style="color: #0550ae">.</span><span style="color: #116329">getMethod</span><span style="color: #0550ae">();</span>
        <span style="color: #cf222e">final</span> <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">uri</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">uriInfo</span><span style="color: #0550ae">.</span><span style="color: #116329">getPath</span><span style="color: #0550ae">();</span>

        <span style="color: #953800">Span</span> <span style="color: #24292f;background-color: #f6f8fa">serverSpan</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">tracer</span><span style="color: #0550ae">.</span><span style="color: #116329">spanBuilder</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">method</span> <span style="color: #0550ae">+</span> <span style="color: #0a3069">" "</span> <span style="color: #0550ae">+</span> <span style="color: #24292f;background-color: #f6f8fa">uri</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">setSpanKind</span><span style="color: #0550ae">(</span><span style="color: #953800">SpanKind</span><span style="color: #0550ae">.</span><span style="color: #116329">SERVER</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">setParent</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">extractedContext</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">startSpan</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">serverSpan</span><span style="color: #0550ae">.</span><span style="color: #116329">makeCurrent</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">serverSpan</span><span style="color: #0550ae">.</span><span style="color: #116329">setAttribute</span><span style="color: #0550ae">(</span><span style="color: #953800">SemanticAttributes</span><span style="color: #0550ae">.</span><span style="color: #116329">HTTP_METHOD</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">method</span><span style="color: #0550ae">);</span>
        <span style="color: #24292f;background-color: #f6f8fa">serverSpan</span><span style="color: #0550ae">.</span><span style="color: #116329">setAttribute</span><span style="color: #0550ae">(</span><span style="color: #953800">SemanticAttributes</span><span style="color: #0550ae">.</span><span style="color: #116329">HTTP_SCHEME</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">requestUri</span><span style="color: #0550ae">.</span><span style="color: #116329">getScheme</span><span style="color: #0550ae">());</span>
        <span style="color: #24292f;background-color: #f6f8fa">serverSpan</span><span style="color: #0550ae">.</span><span style="color: #116329">setAttribute</span><span style="color: #0550ae">(</span><span style="color: #953800">SemanticAttributes</span><span style="color: #0550ae">.</span><span style="color: #116329">HTTP_HOST</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">requestUri</span><span style="color: #0550ae">.</span><span style="color: #116329">getHost</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">+</span> <span style="color: #0a3069">":"</span> <span style="color: #0550ae">+</span> <span style="color: #24292f;background-color: #f6f8fa">requestUri</span><span style="color: #0550ae">.</span><span style="color: #116329">getPort</span><span style="color: #0550ae">());</span>
        <span style="color: #24292f;background-color: #f6f8fa">serverSpan</span><span style="color: #0550ae">.</span><span style="color: #116329">setAttribute</span><span style="color: #0550ae">(</span><span style="color: #953800">SemanticAttributes</span><span style="color: #0550ae">.</span><span style="color: #116329">HTTP_TARGET</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">uri</span><span style="color: #0550ae">);</span>

        <span style="color: #24292f;background-color: #f6f8fa">requestContext</span><span style="color: #0550ae">.</span><span style="color: #116329">setProperty</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"span"</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">serverSpan</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">filter</span><span style="color: #0550ae">(</span><span style="color: #953800">ContainerRequestContext</span> <span style="color: #24292f;background-color: #f6f8fa">containerRequestContext</span><span style="color: #0550ae">,</span> <span style="color: #953800">ContainerResponseContext</span> <span style="color: #24292f;background-color: #f6f8fa">containerResponseContext</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">Object</span> <span style="color: #24292f;background-color: #f6f8fa">serverSpan</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">containerRequestContext</span><span style="color: #0550ae">.</span><span style="color: #116329">getProperty</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"span"</span><span style="color: #0550ae">);</span>
        <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">serverSpan</span> <span style="color: #0550ae">!=</span> <span style="color: #0550ae">null</span> <span style="color: #0550ae">&amp;&amp;</span> <span style="color: #24292f;background-color: #f6f8fa">serverSpan</span> <span style="color: #cf222e">instanceof</span> <span style="color: #953800">Span</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #0550ae">((</span><span style="color: #953800">Span</span><span style="color: #0550ae">)</span> <span style="color: #24292f;background-color: #f6f8fa">serverSpan</span><span style="color: #0550ae">).</span><span style="color: #116329">end</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s quite a bit going on here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, we extract any context that may have been propagated to us by the calling system. OpenTelemetry is a specification with implementations in many languages, so it&#8217;s entirely possible that, say, a JavaScript client has created a trace and is calling our service. In that case, we want to pick up that context and continue using it in this part of the system. We&#8217;ll see this in use when we call between our two Java services in a bit.</p>
</li>
<li>
<p>Next, we extract some information about the request from the Jakarta REST <code>UriInfo</code> instance on the <code>ContainerRequestContext</code>.</p>
</li>
<li>
<p>We create a server <code>span</code>, adding information about the request as attributes.</p>
</li>
<li>
<p>Before finishing up the request part of the filter, we set the <code>span</code> as a property on the <code>ContainerRequestContext</code> for use later.</p>
</li>
<li>
<p>Finally, in the response portion of the filter, we retrieve the <code>span</code> from the <code>ContainerRequestContext</code> and call <code>span.end()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If we deploy the services now, we&#8217;ll certainly get traces logged, but when we call from Service 1 to Service 2, we lose some of the context, so let&#8217;s see how to get the trace to propagate across services.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="context-propagation">Context Propagation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Back in Service 1, we make a call to Service 2 in the method <code>sendRequest()</code>. We left that out earlier for brevity&#8217;s sake, so let&#8217;s look at that now:</p>
</div>
<div class="listingblock">
<div class="title">RestEndpoint1.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span style="color: #cf222e">private</span> <span style="color: #953800">String</span> <span style="color: #8250df">sendRequest</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
    <span style="color: #953800">TextMapSetter</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">HttpRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">Builder</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">setter</span> <span style="color: #0550ae">=</span>
            <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">requestBuilder</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">key</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">value</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">-&gt;</span> <span style="color: #0550ae">{</span>
                <span style="color: #24292f;background-color: #f6f8fa">requestBuilder</span><span style="color: #0550ae">.</span><span style="color: #116329">header</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">key</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">value</span><span style="color: #0550ae">);</span>
            <span style="color: #0550ae">};</span>

    <span style="color: #953800">HttpRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">Builder</span> <span style="color: #24292f;background-color: #f6f8fa">builder</span> <span style="color: #0550ae">=</span> <span style="color: #953800">HttpRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">newBuilder</span><span style="color: #0550ae">()</span>
            <span style="color: #0550ae">.</span><span style="color: #116329">uri</span><span style="color: #0550ae">(</span><span style="color: #953800">URI</span><span style="color: #0550ae">.</span><span style="color: #116329">create</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"http://localhost:8080/service2-1.0-SNAPSHOT/api/endpoint2"</span><span style="color: #0550ae">))</span>
            <span style="color: #0550ae">.</span><span style="color: #116329">timeout</span><span style="color: #0550ae">(</span><span style="color: #953800">Duration</span><span style="color: #0550ae">.</span><span style="color: #116329">ofMinutes</span><span style="color: #0550ae">(</span><span style="color: #0550ae">1</span><span style="color: #0550ae">))</span>
            <span style="color: #0550ae">.</span><span style="color: #116329">header</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Content-Type"</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"application/json"</span><span style="color: #0550ae">)</span>
            <span style="color: #0550ae">.</span><span style="color: #116329">GET</span><span style="color: #0550ae">();</span>

    <span style="color: #24292f;background-color: #f6f8fa">otel</span><span style="color: #0550ae">.</span><span style="color: #116329">getPropagators</span><span style="color: #0550ae">().</span><span style="color: #116329">getTextMapPropagator</span><span style="color: #0550ae">().</span><span style="color: #116329">inject</span><span style="color: #0550ae">(</span><span style="color: #953800">Context</span><span style="color: #0550ae">.</span><span style="color: #116329">current</span><span style="color: #0550ae">(),</span> <span style="color: #24292f;background-color: #f6f8fa">builder</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">setter</span><span style="color: #0550ae">);</span>

    <span style="color: #cf222e">final</span> <span style="color: #953800">HttpRequest</span> <span style="color: #24292f;background-color: #f6f8fa">request</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">builder</span><span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>
    <span style="color: #cf222e">try</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">HttpResponse</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">response</span> <span style="color: #0550ae">=</span> <span style="color: #953800">HttpClient</span><span style="color: #0550ae">.</span><span style="color: #116329">newBuilder</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">version</span><span style="color: #0550ae">(</span><span style="color: #953800">HttpClient</span><span style="color: #0550ae">.</span><span style="color: #116329">Version</span><span style="color: #0550ae">.</span><span style="color: #116329">HTTP_2</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">send</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">,</span> <span style="color: #953800">HttpResponse</span><span style="color: #0550ae">.</span><span style="color: #116329">BodyHandlers</span><span style="color: #0550ae">.</span><span style="color: #116329">ofString</span><span style="color: #0550ae">());</span>
        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">response</span><span style="color: #0550ae">.</span><span style="color: #116329">body</span><span style="color: #0550ae">();</span>
    <span style="color: #0550ae">}</span> <span style="color: #cf222e">catch</span> <span style="color: #0550ae">(</span><span style="color: #953800">Exception</span> <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">throw</span> <span style="color: #cf222e">new</span> <span style="color: #8250df">RuntimeException</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to reading the context from an incoming request, we create an instance of <code>TextMapSetter&lt;T&gt;</code> that will write the context propagation header to the outgoing request. We start building the request, using Java 11&#8217;s HTTP client, hardcoding Service 2&#8217;s API because we can. :)</p>
</div>
<div class="paragraph">
<p>In the middle, there, we ask <code>OpenTelemetry</code> to inject itself into the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span style="color: #24292f;background-color: #f6f8fa">otel</span><span style="color: #0550ae">.</span><span style="color: #116329">getPropagators</span><span style="color: #0550ae">().</span><span style="color: #116329">getTextMapPropagator</span><span style="color: #0550ae">().</span><span style="color: #116329">inject</span><span style="color: #0550ae">(</span><span style="color: #953800">Context</span><span style="color: #0550ae">.</span><span style="color: #116329">current</span><span style="color: #0550ae">(),</span> <span style="color: #24292f;background-color: #f6f8fa">builder</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">setter</span><span style="color: #0550ae">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This line of code adds a header that our request filter above will then extract to set up the trace context in service 2. Once the context headers are injected, we finish the request to service 2, and let the request to service 1 complete as well.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="looking-at-the-traces">Looking at the traces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we&#8217;ve instrumented our application, how do we view the telemetry data? For that, we&#8217;re going to use Jaeger, and since this post is already long enough and a production setup of Jaeger is out of scope, we&#8217;ll go super simple. Download the Jaeger all-in-one distribution from <a href="https://www.jaegertracing.io/download/#binaries">here</a> and run it in one terminal, then start, say, WildFly in another, and deploy our apps in still another:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span style="color: #0550ae">$ </span>jaeger-all-in-one <span style="color: #116329">--collector</span>.zipkin.host-port<span style="color: #0550ae">=</span>:9411
// Another terminal
<span style="color: #0550ae">$ </span>bin/standalone.sh
// Yet another
<span style="color: #0550ae">$ </span><span style="color: #953800">cd</span> <span style="color: #0550ae">$PROJECT_DIR</span>
<span style="color: #0550ae">$ </span>mvn clean package
...
<span style="color: #0550ae">$ </span>jboss-cli.sh <span style="color: #116329">-c</span> <span style="color: #0a3069">"deploy --force service1/target/service1-1.0-SNAPSHOT.war"</span> <span style="color: #0550ae">&amp;&amp;</span> jboss-cli.sh <span style="color: #116329">-c</span> <span style="color: #0a3069">"deploy --force service2/target/service2-1.0-SNAPSHOT.war"</span>
<span style="color: #0550ae">$ </span>http :8080/service1-1.0-SNAPSHOT/api/endpoint1
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 81
Content-Type: application/octet-stream
Date: Wed, 02 Jun 2021 21:44:11 GMT

Hello World, from service 1! Service 2 happened to say <span style="color: #0a3069">'Service 2 did something!'</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>While this proves our services work (for some value of 'work'), where are the traces? For that, point your browser at the <a href="http://localhost:16686/search">Jaeger UI</a>. Once the page loads, select <code>service1-1.0-SNAPSHOT</code> from the <code>Service</code> dropdown, then click <code>Find Traces</code>. You should see results that look something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2021/jaeger_search.png" alt="jaeger search">
</div>
</div>
<div class="paragraph">
<p>Clicking on that first trace, should get you a screen like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2021/jaeger_trace.png" alt="jaeger trace">
</div>
</div>
<div class="paragraph">
<p>You should see 8 spans across 2 different services. I added some random sleeps in the services to help the nested spans be more obvious.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wrapping-up">Wrapping Up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I am not an expert on OpenTelemetry, so I can&#8217;t guarantee this is a production-sound approach, but, Jaeger setup aside, it feels pretty solid to me at this point. At the very least, I hope it offers someone some help in getting started with OpenTelemetry. I should note that I&#8217;m doing this, at least in part, as part of the nascent efforts of adding OpenTelemetry support to WildFly, so, if all goes well, much of this will be done for you automatically if you deploy to WildFly. Until then, go forth and instrument your applications manually. :)</p>
</div>
<div class="paragraph">
<p>If you&#8217;d like to see the entire project, you can find it on <a href="https://github.com/jasondlee/multiservice-otel-demo">GitHub</a>, and you can find me on <a href="https://twitter.com/jasondlee">Twitter</a>.</p>
</div>
</div>
</div>
    </div>
    <footer>
        <div class="grid">
            <div class="col tags">
                
                <span class="title">tags: </span>
                
                <a href="/tag/java/">Java</a>
                <!--                <a href="https://jasondl.ee/tags/Java.html">Java</a>-->
                
                <a href="/tag/jakarta-ee/">Jakarta EE</a>
                <!--                <a href="https://jasondl.ee/tags/Jakarta EE.html">Jakarta EE</a>-->
                
                <a href="/tag/wildfly/">WildFly</a>
                <!--                <a href="https://jasondl.ee/tags/WildFly.html">WildFly</a>-->
                
                <a href="/tag/opentelemetry/">OpenTelemetry</a>
                <!--                <a href="https://jasondl.ee/tags/OpenTelemetry.html">OpenTelemetry</a>-->
                
                <a href="/tag/microservices/">Microservices</a>
                <!--                <a href="https://jasondl.ee/tags/Microservices.html">Microservices</a>-->
                
                
            </div>
            <div class="col"><span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2021/opentelemetry-and-jakarta-rest-services&title=OpenTelemetry and Jakarta REST Services" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=OpenTelemetry and Jakarta REST Services&url=https://jasondl.ee/2021/opentelemetry-and-jakarta-rest-services&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2021/opentelemetry-and-jakarta-rest-services" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2021/opentelemetry-and-jakarta-rest-services" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=OpenTelemetry and Jakarta REST Services&amp;body=OpenTelemetry and Jakarta REST Services https://jasondl.ee/2021/opentelemetry-and-jakarta-rest-services" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>
</div>
        </div>
    </footer>
</article>

        </div>
    </div>
    <div class="col-3 widget">
        <div>
            <h3>Search</h3>
            <!-- HTML elements for search -->
            <input type="text" id="search-input" placeholder="Search blog posts.." style="width: 98%"/>
            <ul id="results-container"></ul>

            <script>
                var sjs = SimpleJekyllSearch({
                    searchInput: document.getElementById('search-input'),
                    resultsContainer: document.getElementById('results-container'),
                    json: '/search.json',
                    limit: 50
                })
            </script>
        </div>
        <div>
            <h3>Quotes</h3>
            <p id="quote">Sample quote</p>
            <p id="source">Quote source</p>
        </div>
        <div>
            <h3>About</h3>
            <p><img src="/images/profile-pic.jpg" style="float:right; object-fit: scale-down; padding-bottom: 1em;"/>My name is Jason Lee. I am a software developer living in the middle of Oklahoma. Ive been a professional developer since 1997,
using a variety of languages, including Java, Javascript, PHP, Python, Delphi, and even a bit of C#. I currently work for Red Hat
on the WildFly/EAP team, where, among other things, I maintain integrations for some MicroProfile specs, OpenTelemetry, Micrometer,
Jakarta Faces, and Bean Validation. (Full resume <a href="resume">here</a>.
LinkedIn <a href="https://www.linkedin.com/in/jasondlee">profile</a>)</p>

<p>I am the president of the Oklahoma City JUG, and an occasional speaker at the JUG and a variety of technical conferences.</p>

<p>On the personal side, Im active in my church, and enjoy bass guitar, running, fishing, and a variety of martial arts. Im also
married to a beautiful woman, and have two boys, who, thankfully, look like their mother.</p>

        </div>
        <div>
            <h3>My Links</h3>
            <ul>
                
                <li>
                    <a href="/presentations" title="Presentations">
                        Presentations
                    </a>
                </li>
                
                <li>
                    <a href="/assets/resume.pdf" title="Resume/CV">
                        Resume/CV
                    </a>
                </li>
                
                <li>
                    <a href="https://linkedin.com/in/jasondlee" title="LinkedIn">
                        LinkedIn
                    </a>
                </li>
                
                <li>
                    <a href="https://twitter.com/jasondlee" title="Twitter">
                        Twitter
                    </a>
                </li>
                
                <li>
                    <a href="https://mastodon.cloud/@jasondlee" title="Mastodon">
                        Mastodon
                    </a>
                </li>
                
                <li>
                    <a href="/tag" title="Tags">
                        Tags
                    </a>
                </li>
                
            </ul>

        </div>
        <div>
            <h3>Publications</h3>
            <ul>
                <li>
                    <div class="grid">
                        <div class="col-8" style="text-weight: bold; font-size: large">
                            <div>Java 9 Programming Blueprints:</div>
                            <div>
                                <a title="My Java 9 book at Amazon" href="https://amzn.to/2FD2XAo" style="padding-left: 10px">Amazon</a>
                            </div>
                            <div>
                                <a title="My Java 9 book at Packt"
                                   href="https://www.packtpub.com/application-development/java-9-programming-blueprints"
                                   style="padding-left: 10px">Packt</a>
                            </div>
                        </div>
                            <div class="col-4">
                                <a href="https://amzn.to/2FD2XAo"><img src="/images/2017/j9pb.png" width="100"/></a>
                            </div>
                    </div>
                </li>
                
                <li>
                    <a href="https://jaxenter.com/tips-for-writing-pluggable-java-ee-applications-105281.html" title="This article discusses ways to use Java EE specs to implement a simple, yet powerful plugin system with a minimum of thrid party libraries.">
                        Tips for Writing Pluggable Java EE Applications
                    </a>
                </li>
                
                <li>
                    <a href="http://www.oracle.com/technetwork/articles/javaee/jsf-templating-137822.html" title="An article Ken Paulsen and I wrote detailing easy JSF component creation">
                        JSFTemplating and Woodstock: Component Authoring Made Easy
                    </a>
                </li>
                
                <li>
                    <a href="http://jsfcentral.com/articles/lee-03-09.html" title="Jason Lee in depth: Mojarra and Scales">
                        Jason Lee in depth: Mojarra and Scales
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20090301060746/http://www.theserverside.com/news/thread.tss?thread_id=49343" title="My JavaOne 2008 Wrap Up">
                        Jason Lee: Postmortem for JavaOne 2008
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20130621192312/https://blogs.oracle.com/stories/entry/international_environmental" title="The GlassFish Adoption Story from my time at IEC">
                        International Environmental: A Cooling Company Which Prefers Hot Software
                    </a>
                </li>
                
                <li>
                    <a href="http://www.jsfcentral.com/articles/trenches_7.html" title="This details the project that spawned a couple of the Mojarra Scales components">
                        IEC donates custom JSF component to Mojarra Scales
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>
<div class="footer">
    <div>
        <p>&#169; Copyright Jason Lee, 2005-2023. All rights reserved.</p>
    </div>
</div>
<!--
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-1091049-6', 'auto');
    ga('send', 'pageview');
</script>
-->
<script src="/assets/js/quotes.js" type="text/javascript"></script>
<script src="/assets/js/local.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script type="text/javascript" src="/assets/js/copy.js"></script>
</body>
</html>
