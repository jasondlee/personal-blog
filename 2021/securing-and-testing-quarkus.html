<!DOCTYPE html>
<html>
<head>
    <title>Coming Up for Air : Securing and Testing Quarkus Applications using Keycloak and Wiremock</title>

    <script src="/assets/js/simple-jekyll-search.min.js" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3GQK1YDRQM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-3GQK1YDRQM');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="me" href="https://mastodon.cloud/@jasondlee"/>

    <link rel="alternate" type="application/rss+xml" title="jasondl.ee RSS feed" href="/feed.xml">

    <link rel="stylesheet" href="/assets/css/main.css" />

    <!-- Web Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Cherry+Cream+Soda">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Philosopher">
    <link rel="stylesheet" type="text/css" href="/assets/css/font-awesome.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/primeflex@3.1.2/primeflex.css"/>
    <link rel="stylesheet" href="https://unpkg.com/primeflex/themes/saga-blue.css"/>
    <link rel="author" href="/images/profile-pic.jpg"/>
</head>
<body>
<div class="grid">
    <div class="col blogname">
        <span>
            <a href="https://jasondl.ee">Coming Up for Air</a>
        </span>
    </div>
</div>
<div class="grid main">
    <div class="col-9">
        <div id="content">
            <article class="post">
    <h1 class="title" style="border-bottom: solid 1px #47586d; margin-bottom: 0.25rem;">
        Securing and Testing Quarkus Applications using Keycloak and Wiremock
    </h1>
    Wednesday, February 17, 2021 | <span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2021/securing-and-testing-quarkus&title=Securing and Testing Quarkus Applications using Keycloak and Wiremock" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Securing and Testing Quarkus Applications using Keycloak and Wiremock&url=https://jasondl.ee/2021/securing-and-testing-quarkus&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2021/securing-and-testing-quarkus" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2021/securing-and-testing-quarkus" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Securing and Testing Quarkus Applications using Keycloak and Wiremock&amp;body=Securing and Testing Quarkus Applications using Keycloak and Wiremock https://jasondl.ee/2021/securing-and-testing-quarkus" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>

    <div>
        <div class="paragraph">
<p>Obviously, web apps need to be secured. If you&#8217;re brave (and some might say foolish), you can roll your own security. Unless you have compelling reasons to do so, however, you probably shouldn&#8217;t. Almost as if by design (nyuk nyuk), Quarkus makes it easy to use any OpenID Connect server. One such server is Keycloak, an open source offering also from Red Hat. If your experience is like mine, though, securing endpoints makes testing a touch more complicated. In this post, I&#8217;d like to present and walk through a complete example of a secured Quarkus app, using Keycloak, JUnit and Wiremock.</p>
</div>
<div class="paragraph">
<p>To begin, let&#8217;s set up a <strong>very</strong> simple Quarkus application. All it contains is a single resource, <code>SampleResource</code>, with two endpoints: one for admins, and one for users. In the interest of completeness, we start by setting up the project&#8217;s POM:</p>
</div>
<div class="sect1">
<h2 id="the-application">The Application</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="code"><pre><span style="color: #6e7781">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span style="color: #116329">&lt;project</span> <span style="color: #116329">xmlns=</span><span style="color: #0a3069">"http://maven.apache.org/POM/4.0.0"</span>
         <span style="color: #116329">xmlns:xsi=</span><span style="color: #0a3069">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span style="color: #116329">xsi:schemaLocation=</span><span style="color: #0a3069">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span style="color: #116329">&gt;</span>
    <span style="color: #116329">&lt;modelVersion&gt;</span>4.0.0<span style="color: #116329">&lt;/modelVersion&gt;</span>

    <span style="color: #116329">&lt;groupId&gt;</span>com.steeplesoft<span style="color: #116329">&lt;/groupId&gt;</span>
    <span style="color: #116329">&lt;artifactId&gt;</span>quarkus-keycloak-wiremock<span style="color: #116329">&lt;/artifactId&gt;</span>
    <span style="color: #116329">&lt;version&gt;</span>1.0-SNAPSHOT<span style="color: #116329">&lt;/version&gt;</span>

    <span style="color: #116329">&lt;properties&gt;</span>
        <span style="color: #116329">&lt;maven.compiler.source&gt;</span>11<span style="color: #116329">&lt;/maven.compiler.source&gt;</span>
        <span style="color: #116329">&lt;maven.compiler.target&gt;</span>11<span style="color: #116329">&lt;/maven.compiler.target&gt;</span>
        <span style="color: #116329">&lt;version.quarkus.platform&gt;</span>1.11.3.Final<span style="color: #116329">&lt;/version.quarkus.platform&gt;</span>
        <span style="color: #116329">&lt;version.compiler-plugin&gt;</span>3.8.1<span style="color: #116329">&lt;/version.compiler-plugin&gt;</span>
        <span style="color: #116329">&lt;version.surefire-plugin&gt;</span>2.22.2<span style="color: #116329">&lt;/version.surefire-plugin&gt;</span>
    <span style="color: #116329">&lt;/properties&gt;</span>

    <span style="color: #116329">&lt;dependencyManagement&gt;</span>
        <span style="color: #116329">&lt;dependencies&gt;</span>
            <span style="color: #116329">&lt;dependency&gt;</span>
                <span style="color: #116329">&lt;groupId&gt;</span>io.quarkus<span style="color: #116329">&lt;/groupId&gt;</span>
                <span style="color: #116329">&lt;artifactId&gt;</span>quarkus-bom<span style="color: #116329">&lt;/artifactId&gt;</span>
                <span style="color: #116329">&lt;version&gt;</span>${version.quarkus.platform}<span style="color: #116329">&lt;/version&gt;</span>
                <span style="color: #116329">&lt;type&gt;</span>pom<span style="color: #116329">&lt;/type&gt;</span>
                <span style="color: #116329">&lt;scope&gt;</span>import<span style="color: #116329">&lt;/scope&gt;</span>
            <span style="color: #116329">&lt;/dependency&gt;</span>
        <span style="color: #116329">&lt;/dependencies&gt;</span>
    <span style="color: #116329">&lt;/dependencyManagement&gt;</span>

    <span style="color: #116329">&lt;dependencies&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>io.quarkus<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>quarkus-resteasy<span style="color: #116329">&lt;/artifactId&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>io.quarkus<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>quarkus-resteasy-jackson<span style="color: #116329">&lt;/artifactId&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>io.quarkus<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>quarkus-oidc<span style="color: #116329">&lt;/artifactId&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
    <span style="color: #116329">&lt;/dependencies&gt;</span>

    <span style="color: #116329">&lt;build&gt;</span>
        <span style="color: #116329">&lt;plugins&gt;</span>
            <span style="color: #116329">&lt;plugin&gt;</span>
                <span style="color: #116329">&lt;groupId&gt;</span>io.quarkus<span style="color: #116329">&lt;/groupId&gt;</span>
                <span style="color: #116329">&lt;artifactId&gt;</span>quarkus-maven-plugin<span style="color: #116329">&lt;/artifactId&gt;</span>
                <span style="color: #116329">&lt;version&gt;</span>${version.quarkus.platform}<span style="color: #116329">&lt;/version&gt;</span>
                <span style="color: #116329">&lt;executions&gt;</span>
                    <span style="color: #116329">&lt;execution&gt;</span>
                        <span style="color: #116329">&lt;goals&gt;</span>
                            <span style="color: #116329">&lt;goal&gt;</span>build<span style="color: #116329">&lt;/goal&gt;</span>
                        <span style="color: #116329">&lt;/goals&gt;</span>
                    <span style="color: #116329">&lt;/execution&gt;</span>
                <span style="color: #116329">&lt;/executions&gt;</span>
            <span style="color: #116329">&lt;/plugin&gt;</span>
    <span style="color: #116329">&lt;/build&gt;</span>

<span style="color: #116329">&lt;/project&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s typically more in a Quarkus POM, but I&#8217;ve stripped this down to the bare minimum. Next, our simple resource:</p>
</div>
<div class="listingblock">
<div class="title">SampleResource.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span style="color: #cf222e">import</span> <span style="color: #953800">javax.annotation.security.RolesAllowed</span><span style="color: #0550ae">;</span>
<span style="color: #cf222e">import</span> <span style="color: #953800">javax.ws.rs.GET</span><span style="color: #0550ae">;</span>
<span style="color: #cf222e">import</span> <span style="color: #953800">javax.ws.rs.Path</span><span style="color: #0550ae">;</span>

<span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/sample"</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">SampleResource</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@GET</span>
    <span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"admin"</span><span style="color: #0550ae">)</span>
    <span style="color: #8250df">@RolesAllowed</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"admin"</span><span style="color: #0550ae">)</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">String</span> <span style="color: #8250df">admin</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #0a3069">"admin"</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #8250df">@GET</span>
    <span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"user"</span><span style="color: #0550ae">)</span>
    <span style="color: #8250df">@RolesAllowed</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"user"</span><span style="color: #0550ae">)</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">String</span> <span style="color: #8250df">user</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #0a3069">"user"</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we can start the app, we need to configure the OIDC support:</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre>quarkus.oidc.auth-server-url=${OIDC_URL:https://localhost:8180/auth/realms/quarkus-demo}
quarkus.oidc.client-id=${OIDC_CLIENT_ID:backend-service}
quarkus.oidc.credentials.secret=${OIDC_SECRET:51ebd5dc-5f2e-403c-be60-60fed3a75c47}
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are now ready, or so we might think, to run our project: <code>mvn compile quarkus:dev</code>. Assuming you have Keycloak running on <code>localhost</code> but haven&#8217;t configured it, you should see an error like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre>Caused by: io.vertx.core.impl.NoStackTraceThrowable: Not Found: {"error":"Realm does not exist"}
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we can&#8217;t run our app just yet, let&#8217;s configure Keycloak.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="keycloak">Keycloak</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="create-the-realm">Create the realm</h3>
<div class="paragraph">
<p>For a more complete Getting Started, you can visit the Keycloak docs[<a href="https://www.keycloak.org/getting-started/getting-started-zip" class="bare">https://www.keycloak.org/getting-started/getting-started-zip</a>]. For our purposes, we&#8217;ll be brief:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download the latest version of <a href="https://www.keycloak.org/downloads">Keycloak</a></p>
</li>
<li>
<p>Extract the zip</p>
</li>
<li>
<p>Start Keycloak with a port offset to avoid conflicts with our application: <code>$KEYCLOAK_DIR/bin/standalone.sh -Djboss.socket.binding.port-offset=100</code></p>
</li>
<li>
<p>Create an admin user: <a href="http://localhost:8180" class="bare">http://localhost:8180</a></p>
<div class="ulist">
<ul>
<li>
<p>User: admin</p>
</li>
<li>
<p>Password: admin</p>
</li>
</ul>
</div>
</li>
<li>
<p>Log on to the admin console by clicking on the <code>Administration Console</code> link</p>
</li>
<li>
<p>Add a realm</p>
<div class="ulist">
<ul>
<li>
<p>Move your mouse over <code>Master</code> in the left nav bar</p>
</li>
<li>
<p>Click <code>Add Realm</code></p>
</li>
<li>
<p>Click <code>Select File</code></p>
</li>
<li>
<p>Navigate to and select <code>quarkus-realm.json</code> that we downloaded above</p>
</li>
<li>
<p>Set the realm name to <code>quarkus-demo</code></p>
</li>
<li>
<p>Click <code>Create</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>We now have a realm for our demo, so next we need to configure the roles and add a user.</p>
</div>
</div>
<div class="sect2">
<h3 id="configure-roles-and-users">Configure roles and users</h3>
<div class="paragraph">
<p>Ordinarily, we would need to add these, but since we imported a realm, that work has been done for us. To verify:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure the realm <code>quarkus-demo</code> is selected at the top the left nav bar.</p>
</li>
<li>
<p>Click <code>Roles</code> in the nav bar</p>
</li>
<li>
<p>In the list, you should see <code>admin</code> and <code>user</code> as well as a few others.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Similarly, we don&#8217;t need to add users, as the import handled that for us. To verify that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Click <code>Users</code> under the <code>Manage section</code> in the nav bar</p>
</li>
<li>
<p>In the list, you should see <code>admin</code>, alice`, and <code>jdoe</code></p>
</li>
<li>
<p>To verify <code>admin</code></p>
<div class="ulist">
<ul>
<li>
<p>Click the UUID in the ID column</p>
</li>
<li>
<p>Click the <code>Role Mappings</code> tab</p>
</li>
<li>
<p>Verify that <code>admin</code> and <code>user</code> are listed under <code>Assigned Roles</code></p>
</li>
<li>
<p>Let&#8217;s change the password</p>
<div class="ulist">
<ul>
<li>
<p>Click the <code>Credentials</code> tab</p>
</li>
<li>
<p>Enter "password" in the <code>Password</code> and <code>Password Confirmation</code> fields</p>
</li>
<li>
<p>Set <code>Temporary</code> to "Off"</p>
</li>
<li>
<p>Click <code>Reset Password</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>To view <code>alice</code> 's roles</p>
<div class="ulist">
<ul>
<li>
<p>Click the <code>Users</code> nav bar link to return to the user list</p>
</li>
<li>
<p>Click the UUID in the ID column for <code>alice</code></p>
</li>
<li>
<p>Click the <code>Role Mapping</code> tab</p>
</li>
<li>
<p>Verify that only <code>user</code> is listed under <code>Assigned Roles</code></p>
</li>
<li>
<p>Change the password for <code>alice</code> as we did above.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="configure-the-client">Configure the client</h3>
<div class="paragraph">
<p>We have one last step, configuring the client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Click <code>Clients</code> in the left nav bar</p>
</li>
<li>
<p>Click <code>backend-service</code> in the table</p>
</li>
<li>
<p>Click the <code>Credentials</code> tab</p>
</li>
<li>
<p>Click the <code>Regenerate Secret</code> button</p>
</li>
<li>
<p>Copy the new value in the <code>Secret</code> field and update <code>quarkus.oidc.credentials.secret</code> in <code>application.properties</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="manually-test-the-application">Manually test the application</h3>
<div class="paragraph">
<p>With our realm configured, we&#8217;re ready to test our application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span style="color: #0550ae">$ </span>mvn compile quarkus:dev
...
INFO  <span style="color: #0550ae">[</span>io.quarkus] <span style="color: #0550ae">(</span>Quarkus Main Thread<span style="color: #0550ae">)</span> quarkus-keycloak-wiremock 1.0-SNAPSHOT on JVM <span style="color: #0550ae">(</span>powered by Quarkus 1.11.3.Final<span style="color: #0550ae">)</span>
     started <span style="color: #cf222e">in </span>2.806s. Listening on: http://localhost:8080
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>And in another console (I&#8217;m using <a href="https://httpie.io">httpie</a> here, btw):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span style="color: #0550ae">$ </span>http <span style="color: #116329">--form</span> <span style="color: #0a3069">\</span>
    <span style="color: #116329">--auth</span> backend-service:51ebd5dc-5f2e-403c-be60-60fed3a75c47 <span style="color: #0a3069">\</span>
    :8180/auth/realms/quarkus-demo/protocol/openid-connect/token <span style="color: #0a3069">\</span>
    <span style="color: #0a3069">'Content-Type:application/x-www-form-urlencoded'</span> <span style="color: #0a3069">\</span>
    <span style="color: #0550ae">username</span><span style="color: #0550ae">=</span>alice <span style="color: #0a3069">\</span>
    <span style="color: #0550ae">password</span><span style="color: #0550ae">=</span>alice <span style="color: #0a3069">\</span>
    grant_type: password
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>That gets a not-small JSON response, but we only want a part, so we can use the JSON query tool, <code>jq</code>, to help us extract the value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span style="color: #0550ae">$ </span><span style="color: #953800">export </span><span style="color: #0550ae">TOKEN</span><span style="color: #0550ae">=</span><span style="color: #0550ae">`</span>http <span style="color: #116329">--form</span> <span style="color: #0a3069">\</span>
    <span style="color: #116329">--auth</span> backend-service:51ebd5dc-5f2e-403c-be60-60fed3a75c47<span style="color: #0a3069">\</span>
    :8180/auth/realms/quarkus-demo/protocol/openid-connect/token <span style="color: #0a3069">\</span>
    <span style="color: #0a3069">'Content-Type:application/x-www-form-urlencoded'</span> <span style="color: #0a3069">\</span>
    <span style="color: #0550ae">username</span><span style="color: #0550ae">=</span>alice <span style="color: #0a3069">\</span>
    <span style="color: #0550ae">password</span><span style="color: #0550ae">=</span>password <span style="color: #0a3069">\</span>
    grant_type: password | jq <span style="color: #116329">--raw-output</span> <span style="color: #0a3069">'.access_token'</span><span style="color: #0550ae">`</span>
<span style="color: #0550ae">$ </span><span style="color: #953800">echo</span> <span style="color: #0550ae">$TOKEN</span>
eyJhbGciOiJSUzI1Ni....
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try accessing the application now, first without a token, and then hitting each restricted endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span style="color: #0550ae">$ </span>http :8080/sample/user
HTTP/1.1 401 Unauthorized
Content-Length: 0

<span style="color: #0550ae">$ </span>http :8080/sample/admin <span style="color: #0a3069">"Authorization:Bearer </span><span style="color: #0550ae">$TOKEN</span><span style="color: #0a3069">"</span>
HTTP/1.1 403 Forbidden
Content-Length: 0

<span style="color: #0550ae">$ </span>http :8080/sample/user <span style="color: #0a3069">"Authorization:Bearer </span><span style="color: #0550ae">$TOKEN</span><span style="color: #0a3069">"</span>
HTTP/1.1 200 OK
Content-Length: 4
Content-Type: application/octet-stream

user
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we see unauthenticated users rejected, unauthorized users rejected, and authorized users allowed, exactly as expected. Let&#8217;s check an admin user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span style="color: #0550ae">$ </span><span style="color: #953800">export </span><span style="color: #0550ae">TOKEN</span><span style="color: #0550ae">=</span><span style="color: #0550ae">`</span>http <span style="color: #116329">--form</span> <span style="color: #0a3069">\</span>
    <span style="color: #116329">--auth</span> backend-service:51ebd5dc-5f2e-403c-be60-60fed3a75c47<span style="color: #0a3069">\</span>
    :8180/auth/realms/quarkus-demo/protocol/openid-connect/token <span style="color: #0a3069">\</span>
    <span style="color: #0a3069">'Content-Type:application/x-www-form-urlencoded'</span> <span style="color: #0a3069">\</span>
    <span style="color: #0550ae">username</span><span style="color: #0550ae">=</span>admin <span style="color: #0a3069">\</span>
    <span style="color: #0550ae">password</span><span style="color: #0550ae">=</span>password <span style="color: #0a3069">\</span>
    grant_type: password | jq <span style="color: #116329">--raw-output</span> <span style="color: #0a3069">'.access_token'</span><span style="color: #0550ae">`</span>

<span style="color: #0550ae">$ </span>http :8080/sample/admin <span style="color: #0a3069">"Authorization:Bearer </span><span style="color: #0550ae">$TOKEN</span><span style="color: #0a3069">"</span>
HTTP/1.1 200 OK
Content-Length: 5
Content-Type: application/octet-stream

admin

<span style="color: #0550ae">$ </span>http :8080/sample/user <span style="color: #0a3069">"Authorization:Bearer </span><span style="color: #0550ae">$TOKEN</span><span style="color: #0a3069">"</span>
HTTP/1.1 200 OK
Content-Length: 4
Content-Type: application/octet-stream

user
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve manually tested the app, but that doesn&#8217;t scale, so let&#8217;s take a look at how to test this simple application programmatically.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing">Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Part of the trick in testing an OIDC-secured apps can be tricky. Given how the token is verified behind the scenes, intercepting those calls can be difficult. Fortunately, <a href="http://wiremock.org/">WireMock</a> handles that for us. Setting up the project is easy. Here, we&#8217;re adding JUnit5, WireMock, and some supporting libraries:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre><span style="color: #116329">&lt;dependency&gt;</span>
    <span style="color: #116329">&lt;groupId&gt;</span>io.quarkus<span style="color: #116329">&lt;/groupId&gt;</span>
    <span style="color: #116329">&lt;artifactId&gt;</span>quarkus-junit5<span style="color: #116329">&lt;/artifactId&gt;</span>
    <span style="color: #116329">&lt;scope&gt;</span>test<span style="color: #116329">&lt;/scope&gt;</span>
<span style="color: #116329">&lt;/dependency&gt;</span>
<span style="color: #116329">&lt;dependency&gt;</span>
    <span style="color: #116329">&lt;groupId&gt;</span>io.rest-assured<span style="color: #116329">&lt;/groupId&gt;</span>
    <span style="color: #116329">&lt;artifactId&gt;</span>rest-assured<span style="color: #116329">&lt;/artifactId&gt;</span>
    <span style="color: #116329">&lt;scope&gt;</span>test<span style="color: #116329">&lt;/scope&gt;</span>
<span style="color: #116329">&lt;/dependency&gt;</span>
<span style="color: #116329">&lt;dependency&gt;</span>
    <span style="color: #116329">&lt;groupId&gt;</span>org.assertj<span style="color: #116329">&lt;/groupId&gt;</span>
    <span style="color: #116329">&lt;artifactId&gt;</span>assertj-core<span style="color: #116329">&lt;/artifactId&gt;</span>
    <span style="color: #116329">&lt;version&gt;</span>3.18.1<span style="color: #116329">&lt;/version&gt;</span>
    <span style="color: #116329">&lt;scope&gt;</span>test<span style="color: #116329">&lt;/scope&gt;</span>
<span style="color: #116329">&lt;/dependency&gt;</span>
<span style="color: #116329">&lt;dependency&gt;</span>
    <span style="color: #116329">&lt;groupId&gt;</span>com.github.tomakehurst<span style="color: #116329">&lt;/groupId&gt;</span>
    <span style="color: #116329">&lt;artifactId&gt;</span>wiremock-jre8<span style="color: #116329">&lt;/artifactId&gt;</span>
    <span style="color: #116329">&lt;version&gt;</span>2.26.3<span style="color: #116329">&lt;/version&gt;</span>
    <span style="color: #116329">&lt;scope&gt;</span>test<span style="color: #116329">&lt;/scope&gt;</span>
<span style="color: #116329">&lt;/dependency&gt;</span>
<span style="color: #116329">&lt;dependency&gt;</span>
    <span style="color: #116329">&lt;groupId&gt;</span>com.nimbusds<span style="color: #116329">&lt;/groupId&gt;</span>
    <span style="color: #116329">&lt;artifactId&gt;</span>nimbus-jose-jwt<span style="color: #116329">&lt;/artifactId&gt;</span>
    <span style="color: #116329">&lt;version&gt;</span>8.20<span style="color: #116329">&lt;/version&gt;</span>
    <span style="color: #116329">&lt;scope&gt;</span>test<span style="color: #116329">&lt;/scope&gt;</span>
<span style="color: #116329">&lt;/dependency&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The test itself is also pretty simple:</p>
</div>
<div class="listingblock">
<div class="title">SampleResourceTest.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="code"><pre><span style="color: #8250df">@QuarkusTest</span>
<span style="color: #8250df">@QuarkusTestResource</span><span style="color: #0550ae">(</span><span style="color: #953800">MockAuthorizationServer</span><span style="color: #0550ae">.</span><span style="color: #116329">class</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">SampleResourceTest</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@Test</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">testUserAsUser</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">RestAssured</span><span style="color: #0550ae">.</span><span style="color: #116329">given</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">contentType</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"application/json"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">auth</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">oauth2</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">generateJWT</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"user"</span><span style="color: #0550ae">))</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">get</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/sample/user"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">then</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">statusCode</span><span style="color: #0550ae">(</span><span style="color: #0550ae">200</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #6e7781">// ...</span>

    <span style="color: #cf222e">private</span> <span style="color: #953800">String</span> <span style="color: #8250df">generateJWT</span><span style="color: #0550ae">(</span><span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">role</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #6e7781">// Prepare JWT with claims set</span>
        <span style="color: #953800">SignedJWT</span> <span style="color: #24292f;background-color: #f6f8fa">signedJWT</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">SignedJWT</span><span style="color: #0550ae">(</span>
                <span style="color: #cf222e">new</span> <span style="color: #953800">JWSHeader</span><span style="color: #0550ae">.</span><span style="color: #116329">Builder</span><span style="color: #0550ae">(</span><span style="color: #953800">JWSAlgorithm</span><span style="color: #0550ae">.</span><span style="color: #116329">RS256</span><span style="color: #0550ae">)</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">keyID</span><span style="color: #0550ae">(</span><span style="color: #953800">MockAuthorizationServer</span><span style="color: #0550ae">.</span><span style="color: #116329">keyPair</span><span style="color: #0550ae">.</span><span style="color: #116329">getKeyID</span><span style="color: #0550ae">())</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">type</span><span style="color: #0550ae">(</span><span style="color: #953800">JOSEObjectType</span><span style="color: #0550ae">.</span><span style="color: #116329">JWT</span><span style="color: #0550ae">)</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">(),</span>
                <span style="color: #cf222e">new</span> <span style="color: #953800">JWTClaimsSet</span><span style="color: #0550ae">.</span><span style="color: #116329">Builder</span><span style="color: #0550ae">()</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">subject</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"backend-service"</span><span style="color: #0550ae">)</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">issuer</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"https://wiremock"</span><span style="color: #0550ae">)</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">claim</span><span style="color: #0550ae">(</span>
                                <span style="color: #0a3069">"realm_access"</span><span style="color: #0550ae">,</span>
                                <span style="color: #cf222e">new</span> <span style="color: #953800">JWTClaimsSet</span><span style="color: #0550ae">.</span><span style="color: #116329">Builder</span><span style="color: #0550ae">()</span>
                                        <span style="color: #0550ae">.</span><span style="color: #116329">claim</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"roles"</span><span style="color: #0550ae">,</span> <span style="color: #953800">Arrays</span><span style="color: #0550ae">.</span><span style="color: #116329">asList</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">role</span><span style="color: #0550ae">))</span>
                                        <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">()</span>
                                        <span style="color: #0550ae">.</span><span style="color: #116329">toJSONObject</span><span style="color: #0550ae">()</span>
                        <span style="color: #0550ae">)</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">claim</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"scope"</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"openid email profile"</span><span style="color: #0550ae">)</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">expirationTime</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">Date</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">Date</span><span style="color: #0550ae">().</span><span style="color: #116329">getTime</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">+</span> <span style="color: #0550ae">60</span> <span style="color: #0550ae">*</span> <span style="color: #0550ae">1000</span><span style="color: #0550ae">))</span>
                        <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">()</span>
        <span style="color: #0550ae">);</span>
        <span style="color: #6e7781">// Compute the RSA signature</span>
        <span style="color: #cf222e">try</span> <span style="color: #0550ae">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">signedJWT</span><span style="color: #0550ae">.</span><span style="color: #116329">sign</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">RSASSASigner</span><span style="color: #0550ae">(</span><span style="color: #953800">MockAuthorizationServer</span><span style="color: #0550ae">.</span><span style="color: #116329">keyPair</span><span style="color: #0550ae">.</span><span style="color: #116329">toRSAKey</span><span style="color: #0550ae">()));</span>
        <span style="color: #0550ae">}</span> <span style="color: #cf222e">catch</span> <span style="color: #0550ae">(</span><span style="color: #953800">JOSEException</span> <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #cf222e">throw</span> <span style="color: #cf222e">new</span> <span style="color: #8250df">RuntimeException</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">);</span>
        <span style="color: #0550ae">}</span>
        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">signedJWT</span><span style="color: #0550ae">.</span><span style="color: #116329">serialize</span><span style="color: #0550ae">();</span>
    <span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <a href="https://github.com/rest-assured/rest-assured">REST Assured</a>, we simply submit a request to server. The magic starts with the call to <code>generateJWT()</code>. In this method, we create a signed JWT using the key pair from our mock authorization server (which we&#8217;ll look at next), we sign the key, and return it. REST Assured passes this as part of the request, which Quarkus will extract and pass to the authorization server to validate.</p>
</div>
<div class="paragraph">
<p>So what does the mock authorization server look like?</p>
</div>
<div class="listingblock">
<div class="title">MockAuthorizationServer.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="code"><pre><span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">MockAuthorizationServer</span> <span style="color: #cf222e">implements</span> <span style="color: #953800">QuarkusTestResourceLifecycleManager</span> <span style="color: #0550ae">{</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">WireMockServer</span> <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">;</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">static</span> <span style="color: #953800">RSAKey</span> <span style="color: #24292f;background-color: #f6f8fa">keyPair</span><span style="color: #0550ae">;</span>

    <span style="color: #cf222e">static</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">try</span> <span style="color: #0550ae">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">keyPair</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">RSAKeyGenerator</span><span style="color: #0550ae">(</span><span style="color: #0550ae">2048</span><span style="color: #0550ae">)</span>
                    <span style="color: #0550ae">.</span><span style="color: #116329">keyID</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"123"</span><span style="color: #0550ae">)</span>
                    <span style="color: #0550ae">.</span><span style="color: #116329">keyUse</span><span style="color: #0550ae">(</span><span style="color: #953800">KeyUse</span><span style="color: #0550ae">.</span><span style="color: #116329">SIGNATURE</span><span style="color: #0550ae">)</span>
                    <span style="color: #0550ae">.</span><span style="color: #116329">generate</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span> <span style="color: #cf222e">catch</span> <span style="color: #0550ae">(</span><span style="color: #953800">JOSEException</span> <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #0550ae">.</span><span style="color: #116329">printStackTrace</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">Map</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">,</span> <span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #8250df">start</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">WireMockServer</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">.</span><span style="color: #116329">start</span><span style="color: #0550ae">();</span>

        <span style="color: #24292f;background-color: #f6f8fa">postStubMapping</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">oidcConfigurationStub</span><span style="color: #0550ae">());</span>
        <span style="color: #24292f;background-color: #f6f8fa">postStubMapping</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">publicKeysStub</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">keyPair</span><span style="color: #0550ae">.</span><span style="color: #116329">toPublicJWK</span><span style="color: #0550ae">().</span><span style="color: #116329">toJSONString</span><span style="color: #0550ae">()));</span>

        <span style="color: #953800">Map</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">,</span><span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">props</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">new</span> <span style="color: #953800">HashMap</span><span style="color: #0550ae">&lt;&gt;();</span>
        <span style="color: #24292f;background-color: #f6f8fa">props</span><span style="color: #0550ae">.</span><span style="color: #116329">put</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"quarkus.oidc.auth-server-url"</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">.</span><span style="color: #116329">baseUrl</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">+</span> <span style="color: #0a3069">"/mock-server"</span><span style="color: #0550ae">);</span>
        <span style="color: #24292f;background-color: #f6f8fa">props</span><span style="color: #0550ae">.</span><span style="color: #116329">put</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"wiremock.url"</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">.</span><span style="color: #116329">baseUrl</span><span style="color: #0550ae">());</span>
        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">props</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #8250df">@Override</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">stop</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">if</span> <span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span> <span style="color: #0550ae">!=</span> <span style="color: #0550ae">null</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">.</span><span style="color: #116329">stop</span><span style="color: #0550ae">();</span>
        <span style="color: #0550ae">}</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #cf222e">private</span> <span style="color: #953800">ResponseBody</span><span style="color: #0550ae">&lt;?&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">postStubMapping</span><span style="color: #0550ae">(</span><span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">RestAssured</span><span style="color: #0550ae">.</span><span style="color: #116329">baseURI</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">.</span><span style="color: #116329">baseUrl</span><span style="color: #0550ae">();</span>
        <span style="color: #cf222e">return</span> <span style="color: #953800">RestAssured</span><span style="color: #0550ae">.</span><span style="color: #116329">given</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">body</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">post</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/__admin/mappings"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">then</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">statusCode</span><span style="color: #0550ae">(</span><span style="color: #953800">Response</span><span style="color: #0550ae">.</span><span style="color: #116329">Status</span><span style="color: #0550ae">.</span><span style="color: #116329">CREATED</span><span style="color: #0550ae">.</span><span style="color: #116329">getStatusCode</span><span style="color: #0550ae">())</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">extract</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">response</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">body</span><span style="color: #0550ae">();</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #cf222e">private</span> <span style="color: #953800">String</span> <span style="color: #8250df">oidcConfigurationStub</span><span style="color: #0550ae">()</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #8250df">readFile</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/oidcconfig.json"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">replace</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"$baseUrl"</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">wireMockServer</span><span style="color: #0550ae">.</span><span style="color: #116329">baseUrl</span><span style="color: #0550ae">());</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #cf222e">private</span> <span style="color: #953800">String</span> <span style="color: #8250df">publicKeysStub</span><span style="color: #0550ae">(</span><span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">keys</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #8250df">readFile</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/publickey.json"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">replace</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"$keys"</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">keys</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #cf222e">private</span> <span style="color: #953800">String</span> <span style="color: #8250df">readFile</span><span style="color: #0550ae">(</span><span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">fileName</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #cf222e">new</span> <span style="color: #8250df">Scanner</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">getClass</span><span style="color: #0550ae">()</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">getResourceAsStream</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">fileName</span><span style="color: #0550ae">),</span> <span style="color: #0a3069">"UTF-8"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">useDelimiter</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"\\A"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">next</span><span style="color: #0550ae">();</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s a lot going on here, and I&#8217;m not going to pretend to be an expert. In effect, we&#8217;re setting up a mock server, configuring two endpoints, defined in <code>oidcconfig.json</code> and <code>publickey.json</code>, and those files look like this:</p>
</div>
<div class="listingblock">
<div class="title">oidcconfig.json</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="json"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #24292f;background-color: #f6f8fa">
  </span><span style="color: #0550ae">"name"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"oidc_configuration"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
  </span><span style="color: #0550ae">"request"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #0550ae">"method"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"GET"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #0550ae">"url"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"/mock-server/.well-known/openid-configuration"</span><span style="color: #24292f;background-color: #f6f8fa">
  </span><span style="color: #24292f;background-color: #f6f8fa">},</span><span style="color: #24292f;background-color: #f6f8fa">
  </span><span style="color: #0550ae">"response"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #0550ae">"status"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0550ae">200</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #0550ae">"headers"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0550ae">"Content-Type"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"application/json;charset=UTF-8"</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">},</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #0550ae">"jsonBody"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"issuer"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"$baseUrl/mock-server"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"authorization_endpoint"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"$baseUrl/v1/authorize"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"token_endpoint"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"$baseUrl/v1/token"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"userinfo_endpoint"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"$baseUrl/v1/userinfo"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"registration_endpoint"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"$baseUrl/v1/clients"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"jwks_uri"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"$baseUrl/v1/keys"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"response_types_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"code"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"id_token"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"code id_token"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"code token"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"id_token token"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"code id_token token"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"response_modes_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"query"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"fragment"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"form_post"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"okta_post_message"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"grant_types_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"authorization_code"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"implicit"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"refresh_token"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"password"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"subject_types_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"public"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"id_token_signing_alg_values_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"RS256"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"scopes_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"sms"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"openid"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"profile"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"email"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"address"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"phone"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"offline_access"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"token_endpoint_auth_methods_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"client_secret_basic"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"client_secret_post"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"client_secret_jwt"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"private_key_jwt"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"none"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"claims_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"iss"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"ver"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"sub"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"aud"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"iat"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"exp"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"jti"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"auth_time"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"amr"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"idp"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"nonce"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"name"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"nickname"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"preferred_username"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"given_name"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"middle_name"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"family_name"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"email"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"email_verified"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"profile"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"zoneinfo"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"locale"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"address"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"phone_number"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"picture"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"website"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"gender"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"birthdate"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"updated_at"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"at_hash"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"c_hash"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"code_challenge_methods_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"S256"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"introspection_endpoint"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"$baseUrl/v1/introspect"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"introspection_endpoint_auth_methods_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"client_secret_basic"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"client_secret_post"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"client_secret_jwt"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"private_key_jwt"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"none"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"revocation_endpoint"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"$baseUrl/v1/revoke"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"revocation_endpoint_auth_methods_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"client_secret_basic"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"client_secret_post"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"client_secret_jwt"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"private_key_jwt"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"none"</span><span style="color: #24292f;background-color: #f6f8fa">],</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"end_session_endpoint"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"$baseUrl/v1/logout"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"request_parameter_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0550ae">true</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"request_object_signing_alg_values_supported"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"HS256"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"HS384"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"HS512"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"RS256"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"RS384"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"RS512"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"ES256"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"ES384"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"ES512"</span><span style="color: #24292f;background-color: #f6f8fa">]</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #24292f;background-color: #f6f8fa">}</span><span style="color: #24292f;background-color: #f6f8fa">
  </span><span style="color: #24292f;background-color: #f6f8fa">}</span><span style="color: #24292f;background-color: #f6f8fa">
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">publickey.json</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="json"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #24292f;background-color: #f6f8fa">
  </span><span style="color: #0550ae">"name"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"public_keys_stub"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
  </span><span style="color: #0550ae">"request"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #0550ae">"method"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"GET"</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #0550ae">"url"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"/v1/keys"</span><span style="color: #24292f;background-color: #f6f8fa">
  </span><span style="color: #24292f;background-color: #f6f8fa">},</span><span style="color: #24292f;background-color: #f6f8fa">
  </span><span style="color: #0550ae">"response"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #0550ae">"status"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0550ae">200</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #0550ae">"headers"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"Content-Type"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #0a3069">"application/json;charset=UTF-8"</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #24292f;background-color: #f6f8fa">},</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #0550ae">"jsonBody"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #0550ae">"keys"</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #24292f;background-color: #f6f8fa"> </span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #24292f;background-color: #f6f8fa">
        </span><span style="color: #f6f8fa;background-color: #82071e">$keys</span><span style="color: #24292f;background-color: #f6f8fa">
      </span><span style="color: #24292f;background-color: #f6f8fa">]</span><span style="color: #24292f;background-color: #f6f8fa">
    </span><span style="color: #24292f;background-color: #f6f8fa">}</span><span style="color: #24292f;background-color: #f6f8fa">
  </span><span style="color: #24292f;background-color: #f6f8fa">}</span><span style="color: #24292f;background-color: #f6f8fa">
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>These are basically mock objects, but representing requests. When a request for <code>request.url</code> comes in, WireMock returns <code>response</code>. Before passing the values to WireMock, we do a simple string replace to configure the responses to look how they should for a given request. We tie, so to speak, the Quarkus test to our <code>MockAuthorizatioServer</code> (which is a <code>QuarkusTestResourceLifecycleManager</code>) via the <code>@QuarkusTestResource</code> annotation on our test class. All that&#8217;s left is to run it.</p>
</div>
<div class="paragraph">
<p>And there you have it. A complete, albeit absurdly simple, Quarkus application, secured with OIDC via Keycloak, and tested with WireMock. It&#8217;s a simple example, but it&#8217;s a working one, so hopefully it will be enough to get you started. If you find any interesting tips or tricks, be sure to drop a comment below! You can find the full source for the project <a href="https://github.com/jasondlee/quarkus-keycloak-wiremock">here</a>.</p>
</div>
</div>
</div>
    </div>
    <footer>
        <div class="grid">
            <div class="col tags">
                
                <span class="title">tags: </span>
                
                <a href="/tag/java/">Java</a>
                <!--                <a href="https://jasondl.ee/tags/Java.html">Java</a>-->
                
                <a href="/tag/quarkus/">Quarkus</a>
                <!--                <a href="https://jasondl.ee/tags/Quarkus.html">Quarkus</a>-->
                
                <a href="/tag/keycloak/">Keycloak</a>
                <!--                <a href="https://jasondl.ee/tags/Keycloak.html">Keycloak</a>-->
                
                <a href="/tag/junit/">JUnit</a>
                <!--                <a href="https://jasondl.ee/tags/JUnit.html">JUnit</a>-->
                
                <a href="/tag/wiremock/">Wiremock</a>
                <!--                <a href="https://jasondl.ee/tags/Wiremock.html">Wiremock</a>-->
                
                
            </div>
            <div class="col"><span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2021/securing-and-testing-quarkus&title=Securing and Testing Quarkus Applications using Keycloak and Wiremock" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Securing and Testing Quarkus Applications using Keycloak and Wiremock&url=https://jasondl.ee/2021/securing-and-testing-quarkus&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2021/securing-and-testing-quarkus" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2021/securing-and-testing-quarkus" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Securing and Testing Quarkus Applications using Keycloak and Wiremock&amp;body=Securing and Testing Quarkus Applications using Keycloak and Wiremock https://jasondl.ee/2021/securing-and-testing-quarkus" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>
</div>
        </div>
    </footer>
</article>

        </div>
    </div>
    <div class="col-3 widget">
        <div>
            <h3>Search</h3>
            <!-- HTML elements for search -->
            <input type="text" id="search-input" placeholder="Search blog posts.." style="width: 98%"/>
            <ul id="results-container"></ul>

            <script>
                var sjs = SimpleJekyllSearch({
                    searchInput: document.getElementById('search-input'),
                    resultsContainer: document.getElementById('results-container'),
                    json: '/search.json',
                    limit: 50
                })
            </script>
        </div>
        <div>
            <h3>Quotes</h3>
            <p id="quote">Sample quote</p>
            <p id="source">Quote source</p>
        </div>
        <div>
            <h3>About</h3>
            <p><img src="/images/profile-pic.jpg" style="float:right; object-fit: scale-down; padding-bottom: 1em;"/>My name is Jason Lee. I am a software developer living in the middle of Oklahoma. I’ve been a professional developer since 1997,
using a variety of languages, including Java, Javascript, PHP, Python, Delphi, and even a bit of C#. I currently work for Red Hat
on the WildFly/EAP team, where, among other things, I maintain integrations for some MicroProfile specs, OpenTelemetry, Micrometer,
Jakarta Faces, and Bean Validation. (Full resume <a href="resume">here</a>.
LinkedIn <a href="https://www.linkedin.com/in/jasondlee">profile</a>)</p>

<p>I am the president of the Oklahoma City JUG, and an occasional speaker at the JUG and a variety of technical conferences.</p>

<p>On the personal side, I’m active in my church, and enjoy bass guitar, running, fishing, and a variety of martial arts. I’m also
married to a beautiful woman, and have two boys, who, thankfully, look like their mother.</p>

        </div>
        <div>
            <h3>My Links</h3>
            <ul>
                
                <li>
                    <a href="/presentations" title="Presentations">
                        Presentations
                    </a>
                </li>
                
                <li>
                    <a href="/assets/resume.pdf" title="Resume/CV">
                        Resume/CV
                    </a>
                </li>
                
                <li>
                    <a href="https://linkedin.com/in/jasondlee" title="LinkedIn">
                        LinkedIn
                    </a>
                </li>
                
                <li>
                    <a href="https://twitter.com/jasondlee" title="Twitter">
                        Twitter
                    </a>
                </li>
                
                <li>
                    <a href="https://mastodon.cloud/@jasondlee" title="Mastodon">
                        Mastodon
                    </a>
                </li>
                
                <li>
                    <a href="/tag" title="Tags">
                        Tags
                    </a>
                </li>
                
            </ul>

        </div>
        <div>
            <h3>Publications</h3>
            <ul>
                <li>
                    <div class="grid">
                        <div class="col-8" style="text-weight: bold; font-size: large">
                            <div>Java 9 Programming Blueprints:</div>
                            <div>
                                <a title="My Java 9 book at Amazon" href="https://amzn.to/2FD2XAo" style="padding-left: 10px">Amazon</a>
                            </div>
                            <div>
                                <a title="My Java 9 book at Packt"
                                   href="https://www.packtpub.com/application-development/java-9-programming-blueprints"
                                   style="padding-left: 10px">Packt</a>
                            </div>
                        </div>
                            <div class="col-4">
                                <a href="https://amzn.to/2FD2XAo"><img src="/images/2017/j9pb.png" width="100"/></a>
                            </div>
                    </div>
                </li>
                
                <li>
                    <a href="https://jaxenter.com/tips-for-writing-pluggable-java-ee-applications-105281.html" title="This article discusses ways to use Java EE specs to implement a simple, yet powerful plugin system with a minimum of thrid party libraries.">
                        Tips for Writing Pluggable Java EE Applications
                    </a>
                </li>
                
                <li>
                    <a href="http://www.oracle.com/technetwork/articles/javaee/jsf-templating-137822.html" title="An article Ken Paulsen and I wrote detailing easy JSF component creation">
                        JSFTemplating and Woodstock: Component Authoring Made Easy
                    </a>
                </li>
                
                <li>
                    <a href="http://jsfcentral.com/articles/lee-03-09.html" title="Jason Lee in depth: Mojarra and Scales">
                        Jason Lee in depth: Mojarra and Scales
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20090301060746/http://www.theserverside.com/news/thread.tss?thread_id=49343" title="My JavaOne 2008 Wrap Up">
                        Jason Lee: Postmortem for JavaOne 2008
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20130621192312/https://blogs.oracle.com/stories/entry/international_environmental" title="The GlassFish Adoption Story from my time at IEC">
                        International Environmental: A Cooling Company Which Prefers Hot Software
                    </a>
                </li>
                
                <li>
                    <a href="http://www.jsfcentral.com/articles/trenches_7.html" title="This details the project that spawned a couple of the Mojarra Scales components">
                        IEC donates custom JSF component to Mojarra Scales
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>
<div class="footer">
    <div>
        <p>&#169; Copyright Jason Lee, 2005-2023. All rights reserved.</p>
    </div>
</div>
<!--
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-1091049-6', 'auto');
    ga('send', 'pageview');
</script>
-->
<script src="/assets/js/quotes.js" type="text/javascript"></script>
<script src="/assets/js/local.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script type="text/javascript" src="/assets/js/copy.js"></script>
</body>
</html>
