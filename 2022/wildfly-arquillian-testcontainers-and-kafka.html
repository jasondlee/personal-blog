<!DOCTYPE html>
<html>
<head>
    <title>Coming Up for Air : WildFly, Arquillian, Testcontainers, and Kafka</title>

    <script src="/assets/js/simple-jekyll-search.min.js" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3GQK1YDRQM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-3GQK1YDRQM');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="me" href="https://mastodon.cloud/@jasondlee"/>

    <link rel="alternate" type="application/rss+xml" title="jasondl.ee RSS feed" href="/feed.xml">

    <link rel="stylesheet" href="/assets/css/main.css" />

    <!-- Web Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Cherry+Cream+Soda">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Philosopher">
    <link rel="stylesheet" type="text/css" href="/assets/css/font-awesome.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/primeflex@3.1.2/primeflex.css"/>
    <link rel="stylesheet" href="https://unpkg.com/primeflex/themes/saga-blue.css"/>
    <link rel="author" href="/images/profile-pic.jpg"/>
</head>
<body>
<div class="grid">
    <div class="col blogname">
        <span>
            <a href="https://jasondl.ee">Coming Up for Air</a>
        </span>
    </div>
</div>
<div class="grid main">
    <div class="col-9">
        <div id="content">
            <article class="post">
    <h1 class="title" style="border-bottom: solid 1px #47586d; margin-bottom: 0.25rem;">
        WildFly, Arquillian, Testcontainers, and Kafka
    </h1>
    Wednesday, August 24, 2022 | <span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2022/wildfly-arquillian-testcontainers-and-kafka&title=WildFly, Arquillian, Testcontainers, and Kafka" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=WildFly, Arquillian, Testcontainers, and Kafka&url=https://jasondl.ee/2022/wildfly-arquillian-testcontainers-and-kafka&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2022/wildfly-arquillian-testcontainers-and-kafka" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2022/wildfly-arquillian-testcontainers-and-kafka" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=WildFly, Arquillian, Testcontainers, and Kafka&amp;body=WildFly, Arquillian, Testcontainers, and Kafka https://jasondl.ee/2022/wildfly-arquillian-testcontainers-and-kafka" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>

    <div>
        <div class="paragraph">
<p>Back again with another Testcontainers example. This time, though, the environment is a bit different. We&#8217;ll be looking at a Jakarta EE application using <a href="https://wildfly.org">WildFly</a> and <a href="https://github.com/eclipse/microprofile-reactive-messaging">MicroProfile Reactive Messaging</a> (MP RM), and we&#8217;re going to test it using <a href="http://arquillian.org/">Arquillian</a> and <a href="https://www.testcontainers.org/">Testcontainers</a>. Let&#8217;s get to it. :)</p>
</div>
<div class="sect1">
<h2 id="the-application">The Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To make things simple, we&#8217;ll develop a <em>really</em> simple application. It will have one endpoint that takes an entity, then publishes it to a Kafka stream. It&#8217;s not a very interesting app, but should be enough for demonstration purposes.</p>
</div>
<div class="paragraph">
<p>While you can see the entire application in the <a href="https://github.com/jasondlee/wildfly-arquillian-testcontainers-kafka-demo">repo</a>, for completeness' sake, let&#8217;s show the pieces, starting with the code:</p>
</div>
<div class="listingblock">
<div class="title">MyResource.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span style="color: #8250df">@Path</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"/"</span><span style="color: #0550ae">)</span>
<span style="color: #8250df">@RequestScoped</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">MyResource</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@Inject</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">MyService</span> <span style="color: #24292f;background-color: #f6f8fa">service</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@POST</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">Response</span> <span style="color: #8250df">create</span><span style="color: #0550ae">(</span><span style="color: #953800">MyModel</span> <span style="color: #24292f;background-color: #f6f8fa">model</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #953800">Response</span><span style="color: #0550ae">.</span><span style="color: #116329">ok</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">service</span><span style="color: #0550ae">.</span><span style="color: #116329">sendModel</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">model</span><span style="color: #0550ae">))</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This just takes a <code>MyModel</code> instance, passes it to the service, the passing along to the client what the service returns.</p>
</div>
<div class="listingblock">
<div class="title">MyService.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span style="color: #8250df">@RequestScoped</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">MyService</span> <span style="color: #0550ae">{</span>

    <span style="color: #8250df">@Inject</span>
    <span style="color: #8250df">@Channel</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"model"</span><span style="color: #0550ae">)</span>
    <span style="color: #953800">Emitter</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">MyModel</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">emitter</span><span style="color: #0550ae">;</span>

    <span style="color: #cf222e">public</span> <span style="color: #953800">MyModel</span> <span style="color: #8250df">sendModel</span><span style="color: #0550ae">(</span><span style="color: #953800">MyModel</span> <span style="color: #24292f;background-color: #f6f8fa">model</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #24292f;background-color: #f6f8fa">emitter</span><span style="color: #0550ae">.</span><span style="color: #116329">send</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">model</span><span style="color: #0550ae">);</span>

        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">model</span><span style="color: #0550ae">;</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the service, we <code>@Inject</code> a MicroProfile Reactive Messaging <code>Emitter</code>, which is annotated with the name of the channel to which <code>MyModel</code> instances will be emitted. With that in hand, we send the model, and return the value. The real magic, if you can call it that, is in <code>MessageService</code>:</p>
</div>
<div class="listingblock">
<div class="title">MessageService.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span style="color: #8250df">@Dependent</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">MessageService</span> <span style="color: #0550ae">{</span>
    <span style="color: #8250df">@Incoming</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"model"</span><span style="color: #0550ae">)</span>
    <span style="color: #8250df">@Outgoing</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"model-event"</span><span style="color: #0550ae">)</span>
    <span style="color: #cf222e">public</span> <span style="color: #953800">Message</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #8250df">sendToKafka</span><span style="color: #0550ae">(</span><span style="color: #953800">MyModel</span> <span style="color: #24292f;background-color: #f6f8fa">model</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">data</span> <span style="color: #0550ae">=</span> <span style="color: #953800">JsonbBuilder</span><span style="color: #0550ae">.</span><span style="color: #116329">create</span><span style="color: #0550ae">().</span><span style="color: #116329">toJson</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">model</span><span style="color: #0550ae">);</span>
        <span style="color: #953800">Message</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">m</span> <span style="color: #0550ae">=</span> <span style="color: #953800">Message</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">data</span><span style="color: #0550ae">);</span>

        <span style="color: #6e7781">// Create Metadata containing the Kafka key</span>
        <span style="color: #953800">OutgoingKafkaRecordMetadata</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">md</span> <span style="color: #0550ae">=</span> <span style="color: #953800">OutgoingKafkaRecordMetadata</span>
                <span style="color: #0550ae">.&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">builder</span><span style="color: #0550ae">().</span><span style="color: #116329">withKey</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">model</span><span style="color: #0550ae">.</span><span style="color: #116329">getId</span><span style="color: #0550ae">().</span><span style="color: #116329">toString</span><span style="color: #0550ae">())</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>

        <span style="color: #6e7781">// The returned message will have the metadata added</span>
        <span style="color: #cf222e">return</span> <span style="color: #953800">KafkaMetadataUtil</span><span style="color: #0550ae">.</span><span style="color: #116329">writeOutgoingKafkaMetadata</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">m</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">md</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Things to note:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The method <code>sendToKafka()</code> is annotated with <code>@Incoming("channel")</code>. Thanks to the magic of Reactive Messaging, any time a <code>MyModel</code> is emitted to that channel, this method will be called with that <code>MyModel</code> instance.</p>
</li>
<li>
<p>The method is also annotated with <code>@Outgoing("model-event")</code>. Whatever this method returns will be published to the <code>model-event</code> stream. Notice that we use some Kafka APIs to add some metadata to the object before writing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now we need to set up the MP RM wiring for Kafka, which we do via MicroProfile Config:</p>
</div>
<div class="listingblock">
<div class="title">META-INF/microprofile-config.properties</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="properties"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span style="color: #0550ae">mp.messaging.connector.smallrye-kafka.bootstrap.servers</span><span style="color: #24292f;background-color: #f6f8fa">=</span><span style="color: #0a3069">localhost:9092</span>
<span style="color: #0550ae">mp.messaging.connector.smallrye-kafka.group.id</span><span style="color: #24292f;background-color: #f6f8fa">=</span><span style="color: #0a3069">"watkdemo"</span>

<span style="color: #0550ae">mp.messaging.outgoing.model-event.connector</span><span style="color: #24292f;background-color: #f6f8fa">=</span><span style="color: #0a3069">smallrye-kafka</span>
<span style="color: #0550ae">mp.messaging.outgoing.model-event.topic</span><span style="color: #24292f;background-color: #f6f8fa">=</span><span style="color: #0a3069">ModelEvent</span>
<span style="color: #0550ae">mp.messaging.outgoing.model-event.key.serializer</span><span style="color: #24292f;background-color: #f6f8fa">=</span><span style="color: #0a3069">org.apache.kafka.common.serialization.StringSerializer</span>
<span style="color: #0550ae">mp.messaging.outgoing.model-event.value.serializer</span><span style="color: #24292f;background-color: #f6f8fa">=</span><span style="color: #0a3069">org.apache.kafka.common.serialization.StringSerializer</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In theory, once you start up Kafka and WildFly (as described in the <a href="https://github.com/jasondlee/wildfly-arquillian-testcontainers-kafka-demo/blob/master/README.md">README</a>), you should be able to deploy and test the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span style="color: #0550ae">$ </span>mvn package wildfly:deploy
<span style="color: #0550ae">$ </span>http <span style="color: #116329">-v</span> POST :8080/wildfly-arq-testcontainers-kafka-1.0-SNAPSHOT <span style="color: #0a3069">\</span>
    <span style="color: #0550ae">foo</span><span style="color: #0550ae">=</span>blah <span style="color: #0550ae">bar</span><span style="color: #0550ae">=</span>49152
POST /wildfly-arq-testcontainers-kafka-1.0-SNAPSHOT HTTP/1.1
Accept: application/json, <span style="color: #cf222e">*</span>/<span style="color: #cf222e">*</span><span style="color: #24292f;background-color: #f6f8fa">;</span><span style="color: #0550ae">q</span><span style="color: #0550ae">=</span>0.5
Accept-Encoding: <span style="color: #953800">gzip</span>, deflate, br
Connection: keep-alive
Content-Length: 31
Content-Type: application/json
Host: localhost:8080
User-Agent: HTTPie/3.2.1

<span style="color: #0550ae">{</span>
    <span style="color: #0a3069">"bar"</span>: <span style="color: #0a3069">"49152"</span>,
    <span style="color: #0a3069">"foo"</span>: <span style="color: #0a3069">"blah"</span>
<span style="color: #0550ae">}</span>


HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 70
Content-Type: application/json
Date: Tue, 23 Aug 2022 21:54:02 GMT

<span style="color: #0550ae">{</span>
    <span style="color: #0a3069">"bar"</span>: 49152,
    <span style="color: #0a3069">"foo"</span>: <span style="color: #0a3069">"blah"</span>,
    <span style="color: #0a3069">"id"</span>: <span style="color: #0a3069">"f76acba6-08fd-4ff1-a357-c9d23d471154"</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Voilà! Now how do we test it?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-test">The Test</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;ve skipped looking at the Maven POM so far, as it&#8217;s pretty run-of-the-mill for the application part, but to get a test set up, we&#8217;re going to need peel back the covers on it. Let&#8217;s start at the top:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span style="color: #116329">&lt;properties&gt;</span>
    <span style="color: #116329">&lt;maven.compiler.source&gt;</span>11<span style="color: #116329">&lt;/maven.compiler.source&gt;</span>
    <span style="color: #116329">&lt;maven.compiler.target&gt;</span>11<span style="color: #116329">&lt;/maven.compiler.target&gt;</span>
    <span style="color: #116329">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span style="color: #116329">&lt;/project.build.sourceEncoding&gt;</span>

    <span style="color: #116329">&lt;version.arquillian&gt;</span>1.6.0.Final<span style="color: #116329">&lt;/version.arquillian&gt;</span>
    <span style="color: #116329">&lt;version.failsafe.plugin&gt;</span>${version.surefire.plugin}<span style="color: #116329">&lt;/version.failsafe.plugin&gt;</span>
    <span style="color: #116329">&lt;version.surefire.plugin&gt;</span>2.22.2<span style="color: #116329">&lt;/version.surefire.plugin&gt;</span>
    <span style="color: #116329">&lt;version.testcontainers&gt;</span>1.17.3<span style="color: #116329">&lt;/version.testcontainers&gt;</span>
    <span style="color: #116329">&lt;version.wildfly.maven.plugin&gt;</span>3.0.2.Final<span style="color: #116329">&lt;/version.wildfly.maven.plugin&gt;</span>
    <span style="color: #116329">&lt;version.wildfly&gt;</span>26.1.1.Final<span style="color: #116329">&lt;/version.wildfly&gt;</span>

    <span style="color: #116329">&lt;wildfly.dir&gt;</span>${project.basedir}/target/wildfly-${version.wildfly}<span style="color: #116329">&lt;/wildfly.dir&gt;</span>
<span style="color: #116329">&lt;/properties&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The interesting portion here is the version definitions. Feel free use Java 17 or later if you like. :)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-integration-test-profile">The integration test profile</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First step, let&#8217;s set up our integration tests in a <code>profile</code>. This allows us to have normal unit testing as part of the build and save the integration tests for CI or an explicit manual run for faster feedback and build loops:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span style="color: #116329">&lt;profiles&gt;</span>
    <span style="color: #116329">&lt;profile&gt;</span>
        <span style="color: #6e7781">&lt;!-- An optional Arquillian testing profile that executes tests in your JBoss EAP instance.
             This profile will start a new JBoss EAP instance, and execute the test, shutting it
             down when done. Run with: mvn clean verify -Parq-managed --&gt;</span>
        <span style="color: #116329">&lt;id&gt;</span>arq-managed<span style="color: #116329">&lt;/id&gt;</span>
        <span style="color: #116329">&lt;build&gt;</span>
            <span style="color: #116329">&lt;defaultGoal&gt;</span>verify<span style="color: #116329">&lt;/defaultGoal&gt;</span>
            <span style="color: #116329">&lt;plugins&gt;</span>
                <span style="color: #116329">&lt;plugin&gt;</span>
                    <span style="color: #116329">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #116329">&lt;/groupId&gt;</span>
                    <span style="color: #116329">&lt;artifactId&gt;</span>maven-failsafe-plugin<span style="color: #116329">&lt;/artifactId&gt;</span>
                    <span style="color: #116329">&lt;version&gt;</span>${version.failsafe.plugin}<span style="color: #116329">&lt;/version&gt;</span>
                    <span style="color: #116329">&lt;executions&gt;</span>
                        <span style="color: #116329">&lt;execution&gt;</span>
                            <span style="color: #116329">&lt;goals&gt;</span>
                                <span style="color: #116329">&lt;goal&gt;</span>integration-test<span style="color: #116329">&lt;/goal&gt;</span>
                                <span style="color: #116329">&lt;goal&gt;</span>verify<span style="color: #116329">&lt;/goal&gt;</span>
                            <span style="color: #116329">&lt;/goals&gt;</span>
                            <span style="color: #116329">&lt;configuration&gt;</span>
                                <span style="color: #116329">&lt;systemPropertyVariables&gt;</span>
                                    <span style="color: #116329">&lt;arquillian.launch&gt;</span>jboss<span style="color: #116329">&lt;/arquillian.launch&gt;</span>
                                    <span style="color: #116329">&lt;java.util.logging.manager&gt;</span>org.jboss.logmanager.LogManager<span style="color: #116329">&lt;/java.util.logging.manager&gt;</span>
                                    <span style="color: #116329">&lt;jboss.home&gt;</span>${wildfly.dir}<span style="color: #116329">&lt;/jboss.home&gt;</span>
                                    <span style="color: #116329">&lt;kafka.server&gt;</span>${kafka.server}<span style="color: #116329">&lt;/kafka.server&gt;</span>
                                <span style="color: #116329">&lt;/systemPropertyVariables&gt;</span>
                                <span style="color: #116329">&lt;redirectTestOutputToFile&gt;</span>false<span style="color: #116329">&lt;/redirectTestOutputToFile&gt;</span>
                            <span style="color: #116329">&lt;/configuration&gt;</span>
                        <span style="color: #116329">&lt;/execution&gt;</span>
                    <span style="color: #116329">&lt;/executions&gt;</span>
                <span style="color: #116329">&lt;/plugin&gt;</span>
            <span style="color: #116329">&lt;/plugins&gt;</span>
        <span style="color: #116329">&lt;/build&gt;</span>
    <span style="color: #116329">&lt;/profile&gt;</span>
<span style="color: #116329">&lt;/profiles&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we&#8217;re simply configuring the <code>maven-failsafe-plugin</code>, and setting the default goal to <code>verify</code> should this profile be activated (via <code>-Parq-managed</code> on the Maven command line).</p>
</div>
<div class="paragraph">
<p>We&#8217;re also setting some system properties, the most notable of which is the Arquillian config we want to launch (<code>arquillian.launch</code>), and the location of the WildFly (<code>jboss.home</code>) and Kafka (<code>kafka.server</code>) servers. We&#8217;ll fill in those details shortly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="arquillian-config">Arquillian Config</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To configure Arquillian, we need an <code>arquillian.xml</code> config file:</p>
</div>
<div class="listingblock">
<div class="title">src/test/resources/arquillian.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span style="color: #6e7781">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span style="color: #116329">&lt;arquillian</span> <span style="color: #116329">xmlns=</span><span style="color: #0a3069">"http://jboss.org/schema/arquillian"</span>
            <span style="color: #116329">xmlns:xsi=</span><span style="color: #0a3069">"http://www.w3.org/2001/XMLSchema-instance"</span>
            <span style="color: #116329">xsi:schemaLocation=</span><span style="color: #0a3069">"http://jboss.org/schema/arquillian
    http://jboss.org/schema/arquillian/arquillian_1_0.xsd"</span><span style="color: #116329">&gt;</span>

    <span style="color: #116329">&lt;engine&gt;</span>
        <span style="color: #116329">&lt;property</span> <span style="color: #116329">name=</span><span style="color: #0a3069">"deploymentExportPath"</span><span style="color: #116329">&gt;</span>target/deployments<span style="color: #116329">&lt;/property&gt;</span>
    <span style="color: #116329">&lt;/engine&gt;</span>

    <span style="color: #116329">&lt;container</span> <span style="color: #116329">qualifier=</span><span style="color: #0a3069">"jboss"</span> <span style="color: #116329">default=</span><span style="color: #0a3069">"true"</span><span style="color: #116329">&gt;</span>
        <span style="color: #116329">&lt;configuration&gt;</span>
            <span style="color: #116329">&lt;property</span> <span style="color: #116329">name=</span><span style="color: #0a3069">"allowConnectingToRunningServer"</span><span style="color: #116329">&gt;</span>true<span style="color: #116329">&lt;/property&gt;</span>
        <span style="color: #116329">&lt;/configuration&gt;</span>
    <span style="color: #116329">&lt;/container&gt;</span>
<span style="color: #116329">&lt;/arquillian&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;m a big fan of holding on the deployment archives that are created for Arquillian testing, so we configure that in the <code>engine</code> section.</p>
</div>
<div class="paragraph">
<p>In order to test on WildFly, we&#8217;ll need a WildFly instance. Arquillian supports a few different operating modes for the test server, but we&#8217;re interested in <code>managed</code>, which means Arquillian will start and stop the server as needed. The WildFly connector for Arquillian, though, is going to require that it be pointed at a local installation (and not a zip). Downloading and extracting zips via Maven isn&#8217;t very pretty (IMO), but, fortunately, the WildFly Maven Plugin lets us build the exact server we want, so let&#8217;s do that.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-test-wildfly-instance">The Test WildFly Instance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, we&#8217;ll define a version in the <code>pluginManagement</code> section of the build. Declaring this in the main build allows us to use it deploy the application, as well as to provision a test server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span style="color: #116329">&lt;build&gt;</span>
    <span style="color: #116329">&lt;pluginManagement&gt;</span>
        <span style="color: #116329">&lt;plugins&gt;</span>
            <span style="color: #116329">&lt;plugin&gt;</span>
                <span style="color: #116329">&lt;groupId&gt;</span>org.wildfly.plugins<span style="color: #116329">&lt;/groupId&gt;</span>
                <span style="color: #116329">&lt;artifactId&gt;</span>wildfly-maven-plugin<span style="color: #116329">&lt;/artifactId&gt;</span>
                <span style="color: #116329">&lt;version&gt;</span>${version.wildfly.maven.plugin}<span style="color: #116329">&lt;/version&gt;</span>
            <span style="color: #116329">&lt;/plugin&gt;</span>
        <span style="color: #116329">&lt;/plugins&gt;</span>
    <span style="color: #116329">&lt;/pluginManagement&gt;</span>
<span style="color: #116329">&lt;/build&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, in our <code>arq-managed</code> profile, we configure a use of the plugin to provision our server:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span style="color: #116329">&lt;plugin&gt;</span>
    <span style="color: #116329">&lt;groupId&gt;</span>org.wildfly.plugins<span style="color: #116329">&lt;/groupId&gt;</span>
    <span style="color: #116329">&lt;artifactId&gt;</span>wildfly-maven-plugin<span style="color: #116329">&lt;/artifactId&gt;</span>
    <span style="color: #116329">&lt;executions&gt;</span>
        <span style="color: #116329">&lt;execution&gt;</span>
            <span style="color: #116329">&lt;id&gt;</span>provision-server<span style="color: #116329">&lt;/id&gt;</span>
            <span style="color: #116329">&lt;phase&gt;</span>pre-integration-test<span style="color: #116329">&lt;/phase&gt;</span>
            <span style="color: #116329">&lt;goals&gt;</span>
                <span style="color: #116329">&lt;goal&gt;</span>provision<span style="color: #116329">&lt;/goal&gt;</span>
            <span style="color: #116329">&lt;/goals&gt;</span>
            <span style="color: #116329">&lt;configuration&gt;</span>
                <span style="color: #116329">&lt;recordProvisioningState&gt;</span>true<span style="color: #116329">&lt;/recordProvisioningState&gt;</span>
                <span style="color: #116329">&lt;feature-packs&gt;</span>
                    <span style="color: #116329">&lt;feature-pack&gt;</span>
                        <span style="color: #116329">&lt;location&gt;</span>
                            org.wildfly:wildfly-cloud-legacy-galleon-pack:${version.wildfly}
                        <span style="color: #116329">&lt;/location&gt;</span>
                    <span style="color: #116329">&lt;/feature-pack&gt;</span>
                <span style="color: #116329">&lt;/feature-packs&gt;</span>
                <span style="color: #116329">&lt;layers&gt;</span>
                    <span style="color: #116329">&lt;layer&gt;</span>jaxrs-server<span style="color: #116329">&lt;/layer&gt;</span>
                    <span style="color: #116329">&lt;layer&gt;</span>microprofile-reactive-messaging<span style="color: #116329">&lt;/layer&gt;</span>
                    <span style="color: #116329">&lt;layer&gt;</span>microprofile-reactive-messaging-kafka<span style="color: #116329">&lt;/layer&gt;</span>
                <span style="color: #116329">&lt;/layers&gt;</span>
            <span style="color: #116329">&lt;/configuration&gt;</span>
        <span style="color: #116329">&lt;/execution&gt;</span>
    <span style="color: #116329">&lt;/executions&gt;</span>
    <span style="color: #116329">&lt;configuration&gt;</span>
        <span style="color: #116329">&lt;provisioning-dir&gt;</span>${wildfly.dir}<span style="color: #116329">&lt;/provisioning-dir&gt;</span>
    <span style="color: #116329">&lt;/configuration&gt;</span>
<span style="color: #116329">&lt;/plugin&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the plugin executes, it will build a server based on version <code>${version.wildfly}</code>, and add support for only JAX-RS and MicroProfile Reactive Messaging with Kafka support (and any needed dependencies). This gives us a thinner, smaller server to work with.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This works great for testing, but you can also use this approach (via the Galleon command line utility), to build  slimmed down server for production deployments, but that&#8217;s a topic for another day. :)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The generated server is put in <code>${project.basedir}/target</code> via <code>provisioning-dir</code> (and the property defined above) so we can easily clean up after ourselves. Note that we use value to set <code>jboss.home</code> above in the <code>maven-failsafe-pugin</code> configuration so Arquillian can find the server.</p>
</div>
<div class="paragraph">
<p>That&#8217;s a lot of steps already, but we&#8217;re still not quite ready to write tests yet. We need a Kafka server.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-test-kafka-instance">The Test Kafka Instance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;re going to use <a href="https://testcontainers.org">Testcontainers</a> to manage our Kafka instance. If you read my <a href="quarkus-dev-services-jooq-flyway-testcontainers-full-example.html">'Quarkus Dev Services, jOOQ, Flyway, and Testcontainers: A Full Example'</a> post, this approach will be familiar to you. We&#8217;ll use the <code>groovy-maven-plugin</code> to create a Testcontainer-based Kafka instance, and pass the relevant information to the test via system properties.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span style="color: #116329">&lt;plugin&gt;</span>
    <span style="color: #116329">&lt;groupId&gt;</span>org.codehaus.gmaven<span style="color: #116329">&lt;/groupId&gt;</span>
    <span style="color: #116329">&lt;artifactId&gt;</span>groovy-maven-plugin<span style="color: #116329">&lt;/artifactId&gt;</span>
    <span style="color: #116329">&lt;version&gt;</span>2.1.1<span style="color: #116329">&lt;/version&gt;</span>
    <span style="color: #116329">&lt;executions&gt;</span>
        <span style="color: #116329">&lt;execution&gt;</span>
            <span style="color: #116329">&lt;id&gt;</span>kafka<span style="color: #116329">&lt;/id&gt;</span>
            <span style="color: #116329">&lt;phase&gt;</span>pre-integration-test<span style="color: #116329">&lt;/phase&gt;</span>
            <span style="color: #116329">&lt;goals&gt;</span>
                <span style="color: #116329">&lt;goal&gt;</span>execute<span style="color: #116329">&lt;/goal&gt;</span>
            <span style="color: #116329">&lt;/goals&gt;</span>
            <span style="color: #116329">&lt;configuration&gt;</span>
                <span style="color: #116329">&lt;source&gt;</span>
                    def image = org.testcontainers.utility.DockerImageName.parse("confluentinc/cp-kafka").withTag("7.2.1")
                    def kafka = new org.testcontainers.containers.KafkaContainer(image)
                    kafka.start()
                    project.properties.setProperty('kafka.server', kafka.bootstrapServers)
                <span style="color: #116329">&lt;/source&gt;</span>
            <span style="color: #116329">&lt;/configuration&gt;</span>
        <span style="color: #116329">&lt;/execution&gt;</span>
    <span style="color: #116329">&lt;/executions&gt;</span>
    <span style="color: #116329">&lt;dependencies&gt;</span>
        <span style="color: #116329">&lt;dependency&gt;</span>
            <span style="color: #116329">&lt;groupId&gt;</span>org.testcontainers<span style="color: #116329">&lt;/groupId&gt;</span>
            <span style="color: #116329">&lt;artifactId&gt;</span>kafka<span style="color: #116329">&lt;/artifactId&gt;</span>
            <span style="color: #116329">&lt;version&gt;</span>${version.testcontainers}<span style="color: #116329">&lt;/version&gt;</span>
        <span style="color: #116329">&lt;/dependency&gt;</span>
    <span style="color: #116329">&lt;/dependencies&gt;</span>
<span style="color: #116329">&lt;/plugin&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s nothing particularly interesting here if you&#8217;re familiar with Testcontainers, but here&#8217;s a summary</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We parse an image name (<code>confluentinc/cp-kafka:7.2.1</code>)</p>
</li>
<li>
<p>We create an instance of <code>KafkaContainer</code>, using that image</p>
</li>
<li>
<p>We start the server</p>
</li>
<li>
<p>We get the <code>bootstrapServers</code> value, and assign that to a build property</p>
</li>
<li>
<p>In the <code>maven-failsafe-plugin</code> config above, we set a system property using this build property</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As the build finishes and the JVM exits, the container is shut down and cleaned up. It&#8217;s really pretty slick.</p>
</div>
<div class="paragraph">
<p>Take a deep breath&#8201;&#8212;&#8201;and maybe a coffee break&#8201;&#8212;&#8201;as we&#8217;re in the home stretch. It&#8217;s actually time to write a test. :)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-test-for-real">The Test. For Real.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here&#8217;s (most of) the test class:</p>
</div>
<div class="listingblock">
<div class="title">MyServiceIT.java</div>
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span style="color: #8250df">@RunWith</span><span style="color: #0550ae">(</span><span style="color: #953800">Arquillian</span><span style="color: #0550ae">.</span><span style="color: #116329">class</span><span style="color: #0550ae">)</span>
<span style="color: #cf222e">public</span> <span style="color: #cf222e">class</span> <span style="color: #953800">MyServiceIT</span> <span style="color: #0550ae">{</span>

    <span style="color: #8250df">@ArquillianResource</span>
    <span style="color: #cf222e">private</span> <span style="color: #953800">URL</span> <span style="color: #24292f;background-color: #f6f8fa">url</span><span style="color: #0550ae">;</span>

    <span style="color: #8250df">@Deployment</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">static</span> <span style="color: #953800">Archive</span> <span style="color: #8250df">getDeployment</span><span style="color: #0550ae">()</span> <span style="color: #cf222e">throws</span> <span style="color: #953800">IOException</span> <span style="color: #0550ae">{</span>
        <span style="color: #953800">String</span> <span style="color: #24292f;background-color: #f6f8fa">config</span> <span style="color: #0550ae">=</span> <span style="color: #953800">Files</span><span style="color: #0550ae">.</span><span style="color: #116329">readString</span><span style="color: #0550ae">(</span><span style="color: #953800">Path</span><span style="color: #0550ae">.</span><span style="color: #116329">of</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"src/main/resources/META-INF/microprofile-config.properties"</span><span style="color: #0550ae">));</span>
        <span style="color: #24292f;background-color: #f6f8fa">config</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #0550ae">.</span><span style="color: #116329">replaceAll</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"localhost:9092"</span><span style="color: #0550ae">,</span> <span style="color: #953800">System</span><span style="color: #0550ae">.</span><span style="color: #116329">getProperty</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"kafka.server"</span><span style="color: #0550ae">));</span>

        <span style="color: #cf222e">return</span> <span style="color: #953800">ShrinkWrap</span><span style="color: #0550ae">.</span><span style="color: #116329">create</span><span style="color: #0550ae">(</span><span style="color: #953800">WebArchive</span><span style="color: #0550ae">.</span><span style="color: #116329">class</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"test.war"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">addAsWebInfResource</span><span style="color: #0550ae">(</span><span style="color: #953800">EmptyAsset</span><span style="color: #0550ae">.</span><span style="color: #116329">INSTANCE</span><span style="color: #0550ae">,</span> <span style="color: #0a3069">"beans.xml"</span><span style="color: #0550ae">)</span> <span style="color: #6e7781">// Warning: This breaks in EE 10</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">addAsResource</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">StringAsset</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #0550ae">),</span> <span style="color: #0a3069">"META-INF/microprofile-config.properties"</span><span style="color: #0550ae">)</span>
                <span style="color: #0550ae">.</span><span style="color: #116329">addPackages</span><span style="color: #0550ae">(</span><span style="color: #0550ae">true</span><span style="color: #0550ae">,</span> <span style="color: #953800">MyService</span><span style="color: #0550ae">.</span><span style="color: #116329">class</span><span style="color: #0550ae">.</span><span style="color: #116329">getPackage</span><span style="color: #0550ae">().</span><span style="color: #116329">getName</span><span style="color: #0550ae">());</span>
    <span style="color: #0550ae">}</span>

    <span style="color: #8250df">@Test</span>
    <span style="color: #8250df">@RunAsClient</span>
    <span style="color: #cf222e">public</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">sendMessage</span><span style="color: #0550ae">()</span> <span style="color: #cf222e">throws</span> <span style="color: #953800">Exception</span> <span style="color: #0550ae">{</span>
        <span style="color: #cf222e">int</span> <span style="color: #24292f;background-color: #f6f8fa">count</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #0550ae">;</span>
        <span style="color: #cf222e">boolean</span> <span style="color: #24292f;background-color: #f6f8fa">found</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">false</span><span style="color: #0550ae">;</span>

        <span style="color: #24292f;background-color: #f6f8fa">sendRestRequest</span><span style="color: #0550ae">();</span>

        <span style="color: #953800">KafkaConsumer</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">,</span> <span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">consumer</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">getConsumer</span><span style="color: #0550ae">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">consumer</span><span style="color: #0550ae">.</span><span style="color: #116329">subscribe</span><span style="color: #0550ae">(</span><span style="color: #953800">Collections</span><span style="color: #0550ae">.</span><span style="color: #116329">singleton</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"ModelEvent"</span><span style="color: #0550ae">));</span>

        <span style="color: #cf222e">while</span> <span style="color: #0550ae">(!</span><span style="color: #24292f;background-color: #f6f8fa">found</span> <span style="color: #0550ae">&amp;&amp;</span> <span style="color: #24292f;background-color: #f6f8fa">count</span> <span style="color: #0550ae">&lt;</span> <span style="color: #0550ae">10</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">consumer</span><span style="color: #0550ae">.</span><span style="color: #116329">seekToBeginning</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">consumer</span><span style="color: #0550ae">.</span><span style="color: #116329">assignment</span><span style="color: #0550ae">());</span>
            <span style="color: #953800">ConsumerRecords</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">,</span> <span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">records</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">consumer</span><span style="color: #0550ae">.</span><span style="color: #116329">poll</span><span style="color: #0550ae">(</span><span style="color: #953800">Duration</span><span style="color: #0550ae">.</span><span style="color: #116329">ofMillis</span><span style="color: #0550ae">(</span><span style="color: #0550ae">100</span><span style="color: #0550ae">));</span>
            <span style="color: #24292f;background-color: #f6f8fa">count</span><span style="color: #0550ae">++;</span>
            <span style="color: #cf222e">for</span> <span style="color: #0550ae">(</span><span style="color: #953800">ConsumerRecord</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">,</span> <span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">r</span> <span style="color: #0550ae">:</span> <span style="color: #24292f;background-color: #f6f8fa">records</span><span style="color: #0550ae">)</span> <span style="color: #0550ae">{</span>
                <span style="color: #24292f;background-color: #f6f8fa">found</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">true</span><span style="color: #0550ae">;</span>
                <span style="color: #953800">System</span><span style="color: #0550ae">.</span><span style="color: #116329">out</span><span style="color: #0550ae">.</span><span style="color: #116329">println</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"***** Message received: "</span> <span style="color: #0550ae">+</span> <span style="color: #24292f;background-color: #f6f8fa">r</span><span style="color: #0550ae">.</span><span style="color: #116329">value</span><span style="color: #0550ae">());</span>
            <span style="color: #0550ae">}</span>
        <span style="color: #0550ae">}</span>
        <span style="color: #24292f;background-color: #f6f8fa">assertTrue</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Message not found in stream"</span><span style="color: #0550ae">,</span> <span style="color: #24292f;background-color: #f6f8fa">found</span><span style="color: #0550ae">);</span>
    <span style="color: #0550ae">}</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>I don&#8217;t want to spend too much time on Arquillian specifics, so we&#8217;ll move fast here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We annotate the class with <code>@RunWith(Arquillian.class)</code> to make this an Arquillian test.</p>
</li>
<li>
<p>This class will be wrapped up and deployed to the server, so we can <code>@Inject</code> the class we want to test (<code>MyService</code>)</p>
</li>
<li>
<p>We do, though, need to define what to deploy, so we have an <code>@Deployment</code>.</p>
<div class="ulist">
<ul>
<li>
<p>To make things simpler, I&#8217;m simply adding everything under the package <code>com.steeplesoft.watkdemo</code></p>
</li>
<li>
<p>I&#8217;m also reading the MP Config file and changing the value for the Kafka server to point to our test containers. There are probably smarter ways of doing this, but they eluded me long enough that I went with the sledgehammer. :P</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The test is where things get interesting. We&#8217;re going to do an end-to-end test (thus "integration test"), from REST request to Kafka stream, so we make this test as <code>@RunAsClient</code>. In it, send the REST request (see below), then we connect to our test Kafka server and poll it until either we find our message, or we time out.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>I&#8217;m not a Kafka expert, so please be kind. :) If you know a better way to do this, then please feel free. You can also find me and clue me in. :P</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To send the request, we have this method, using Java 11&#8217;s <code>HttpClient</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</pre></td><td class="code"><pre><span style="color: #cf222e">private</span> <span style="color: #cf222e">void</span> <span style="color: #8250df">sendRestRequest</span><span style="color: #0550ae">()</span> <span style="color: #cf222e">throws</span> <span style="color: #953800">Exception</span> <span style="color: #0550ae">{</span>
    <span style="color: #953800">HttpRequest</span> <span style="color: #24292f;background-color: #f6f8fa">request</span> <span style="color: #0550ae">=</span> <span style="color: #953800">HttpRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">newBuilder</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">url</span><span style="color: #0550ae">.</span><span style="color: #116329">toURI</span><span style="color: #0550ae">())</span>
            <span style="color: #0550ae">.</span><span style="color: #116329">header</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Accept"</span><span style="color: #0550ae">,</span> <span style="color: #953800">MediaType</span><span style="color: #0550ae">.</span><span style="color: #116329">APPLICATION_JSON</span><span style="color: #0550ae">)</span>
            <span style="color: #0550ae">.</span><span style="color: #116329">header</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"Content-type"</span><span style="color: #0550ae">,</span> <span style="color: #953800">MediaType</span><span style="color: #0550ae">.</span><span style="color: #116329">APPLICATION_JSON</span><span style="color: #0550ae">)</span>
            <span style="color: #0550ae">.</span><span style="color: #116329">POST</span><span style="color: #0550ae">(</span><span style="color: #953800">HttpRequest</span><span style="color: #0550ae">.</span><span style="color: #116329">BodyPublishers</span><span style="color: #0550ae">.</span><span style="color: #116329">ofString</span><span style="color: #0550ae">(</span>
                    <span style="color: #cf222e">new</span> <span style="color: #8250df">ObjectMapper</span><span style="color: #0550ae">().</span><span style="color: #116329">writeValueAsString</span><span style="color: #0550ae">(</span><span style="color: #cf222e">new</span> <span style="color: #953800">MyModel</span><span style="color: #0550ae">(</span><span style="color: #0a3069">"foo"</span><span style="color: #0550ae">,</span> <span style="color: #0550ae">49152</span><span style="color: #0550ae">))))</span>
            <span style="color: #0550ae">.</span><span style="color: #116329">build</span><span style="color: #0550ae">();</span>
    <span style="color: #953800">HttpResponse</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">String</span><span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">response</span> <span style="color: #0550ae">=</span> <span style="color: #953800">HttpClient</span><span style="color: #0550ae">.</span><span style="color: #116329">newHttpClient</span><span style="color: #0550ae">().</span><span style="color: #116329">send</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">request</span><span style="color: #0550ae">,</span> <span style="color: #953800">HttpResponse</span><span style="color: #0550ae">.</span><span style="color: #116329">BodyHandlers</span><span style="color: #0550ae">.</span><span style="color: #116329">ofString</span><span style="color: #0550ae">());</span>
    <span style="color: #24292f;background-color: #f6f8fa">assertEquals</span><span style="color: #0550ae">(</span><span style="color: #24292f;background-color: #f6f8fa">response</span><span style="color: #0550ae">.</span><span style="color: #116329">statusCode</span><span style="color: #0550ae">(),</span> <span style="color: #0550ae">200</span><span style="color: #0550ae">);</span>
<span style="color: #0550ae">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>We should have all the pieces in place, so let&#8217;s run the test. You should see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span style="color: #0550ae">$ </span>mvn <span style="color: #116329">-Parq-managed</span> verify
...
<span style="color: #0550ae">[</span>INFO] Checking the system...
<span style="color: #0550ae">[</span>INFO] ✔︎ Docker server version should be at least 1.6.0
<span style="color: #0550ae">[</span>INFO] Creating container <span style="color: #cf222e">for </span>image: confluentinc/cp-kafka:7.2.1
<span style="color: #0550ae">[</span>INFO] Creating container <span style="color: #cf222e">for </span>image: testcontainers/ryuk:0.3.3
<span style="color: #0550ae">[</span>INFO] Container testcontainers/ryuk:0.3.3 is starting: 41c8a0373fe07619232a748df3e39d2ef40425b43bc203f3188a5b24260c3113
<span style="color: #0550ae">[</span>INFO] Container testcontainers/ryuk:0.3.3 started <span style="color: #cf222e">in </span>PT0.414602S
<span style="color: #0550ae">[</span>INFO] Container confluentinc/cp-kafka:7.2.1 is starting: 5ec0656459ece52dbf69e9cb99f0f7c8cfabc81686fbed8036c25500289da31b
<span style="color: #0550ae">[</span>INFO] Container confluentinc/cp-kafka:7.2.1 started <span style="color: #cf222e">in </span>PT4.465336S
...
INFO] Running com.steeplesoft.watkdemo.MyServiceIT
Aug 24, 2022 12:49:20 PM org.jboss.threads.Version &lt;clinit&gt;
INFO: JBoss Threads version 2.3.0.Beta2
Aug 24, 2022 12:49:20 PM org.jboss.as.arquillian.container.CommonManagedDeployableContainer startInternal
...
12:49:23,413 INFO  <span style="color: #0550ae">[</span>org.jboss.as.server.deployment] <span style="color: #0550ae">(</span>MSC service thread 1-2<span style="color: #0550ae">)</span> WFLYSRV0027: Starting deployment of <span style="color: #0a3069">"test.war"</span> <span style="color: #0550ae">(</span>runtime-name: <span style="color: #0a3069">"test.war"</span><span style="color: #0550ae">)</span>
12:49:23,830 INFO  <span style="color: #0550ae">[</span>org.jboss.weld.deployer] <span style="color: #0550ae">(</span>MSC service thread 1-4<span style="color: #0550ae">)</span> WFLYWELD0003: Processing weld deployment test.war
...
12:49:26,073 INFO  <span style="color: #0550ae">[</span>org.apache.kafka.clients.Metadata] <span style="color: #0550ae">(</span>kafka-producer-network-thread | kafka-producer-model-event<span style="color: #0550ae">)</span> <span style="color: #0550ae">[</span>Producer <span style="color: #0550ae">clientId</span><span style="color: #0550ae">=</span>kafka-producer-model-event] Resetting the last seen epoch of partition ModelEvent-0 to 0 since the associated topicId changed from null to oOHfjaIyR-S-gvivnsnGYg





<span style="color: #cf222e">*****</span> Message received: <span style="color: #0550ae">{</span><span style="color: #0a3069">"bar"</span>:49152,<span style="color: #0a3069">"foo"</span>:<span style="color: #0a3069">"foo"</span>,<span style="color: #0a3069">"id"</span>:<span style="color: #0a3069">"2b66b9c4-3de5-40a4-91b6-e7b511f5233b"</span><span style="color: #0550ae">}</span>





12:49:26,866 INFO  <span style="color: #0550ae">[</span>org.wildfly.extension.undertow] <span style="color: #0550ae">(</span>ServerService Thread Pool <span style="color: #116329">--</span> 15<span style="color: #0550ae">)</span> WFLYUT0022: Unregistered web context: <span style="color: #0a3069">'/test'</span> from server <span style="color: #0a3069">'default-server'</span>
12:49:26,871 INFO  <span style="color: #0550ae">[</span>org.apache.kafka.clients.producer.KafkaProducer] <span style="color: #0550ae">(</span>smallrye-kafka-producer-thread-0<span style="color: #0550ae">)</span> <span style="color: #0550ae">[</span>Producer <span style="color: #0550ae">clientId</span><span style="color: #0550ae">=</span>kafka-producer-model-event] Closing the Kafka producer with timeoutMillis <span style="color: #0550ae">=</span> 10000 ms.
...
<span style="color: #0550ae">[</span>INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 6.426 s - <span style="color: #cf222e">in </span>com.steeplesoft.watkdemo.MyServiceIT
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In that brief log excerpt, we can see</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The test container spinning up</p>
</li>
<li>
<p>WildFly starting</p>
</li>
<li>
<p>The output from our test when we find the message</p>
</li>
<li>
<p>And the most important part: <code>Tests run: 1, Failures: 0, Errors: 0, Skipped: 0</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="were-done">We&#8217;re Done!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While the application under test is pretty simple, hopefully this example will give you enough to test your application if you have a similar architectural stack. If you have questions, comments, concerns, etc., you can find me on <a href="https://jasondl.ee">Twitter</a>. :)</p>
</div>
</div>
</div>
    </div>
    <footer>
        <div class="grid">
            <div class="col tags">
                
                <span class="title">tags: </span>
                
                <a href="/tag/java/">Java</a>
                <!--                <a href="https://jasondl.ee/tags/Java.html">Java</a>-->
                
                <a href="/tag/wildfly/">WildFly</a>
                <!--                <a href="https://jasondl.ee/tags/WildFly.html">WildFly</a>-->
                
                <a href="/tag/kafka/">Kafka</a>
                <!--                <a href="https://jasondl.ee/tags/Kafka.html">Kafka</a>-->
                
                <a href="/tag/arquillian/">Arquillian</a>
                <!--                <a href="https://jasondl.ee/tags/Arquillian.html">Arquillian</a>-->
                
                <a href="/tag/testcontainers/">Testcontainers</a>
                <!--                <a href="https://jasondl.ee/tags/Testcontainers.html">Testcontainers</a>-->
                
                
            </div>
            <div class="col"><span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2022/wildfly-arquillian-testcontainers-and-kafka&title=WildFly, Arquillian, Testcontainers, and Kafka" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=WildFly, Arquillian, Testcontainers, and Kafka&url=https://jasondl.ee/2022/wildfly-arquillian-testcontainers-and-kafka&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2022/wildfly-arquillian-testcontainers-and-kafka" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2022/wildfly-arquillian-testcontainers-and-kafka" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=WildFly, Arquillian, Testcontainers, and Kafka&amp;body=WildFly, Arquillian, Testcontainers, and Kafka https://jasondl.ee/2022/wildfly-arquillian-testcontainers-and-kafka" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>
</div>
        </div>
    </footer>
</article>

        </div>
    </div>
    <div class="col-3 widget">
        <div>
            <h3>Search</h3>
            <!-- HTML elements for search -->
            <input type="text" id="search-input" placeholder="Search blog posts.." style="width: 98%"/>
            <ul id="results-container"></ul>

            <script>
                var sjs = SimpleJekyllSearch({
                    searchInput: document.getElementById('search-input'),
                    resultsContainer: document.getElementById('results-container'),
                    json: '/search.json',
                    limit: 50
                })
            </script>
        </div>
        <div>
            <h3>Quotes</h3>
            <p id="quote">Sample quote</p>
            <p id="source">Quote source</p>
        </div>
        <div>
            <h3>About</h3>
            <p><img src="/images/profile-pic.jpg" style="float:right; object-fit: scale-down; padding-bottom: 1em;"/>My name is Jason Lee. I am a software developer living in the middle of Oklahoma. I’ve been a professional developer since 1997,
using a variety of languages, including Java, Javascript, PHP, Python, Delphi, and even a bit of C#. I currently work for Red Hat
on the WildFly/EAP team, where, among other things, I maintain integrations for some MicroProfile specs, OpenTelemetry, Micrometer,
Jakarta Faces, and Bean Validation. (Full resume <a href="resume">here</a>.
LinkedIn <a href="https://www.linkedin.com/in/jasondlee">profile</a>)</p>

<p>I am the president of the Oklahoma City JUG, and an occasional speaker at the JUG and a variety of technical conferences.</p>

<p>On the personal side, I’m active in my church, and enjoy bass guitar, running, fishing, and a variety of martial arts. I’m also
married to a beautiful woman, and have two boys, who, thankfully, look like their mother.</p>

        </div>
        <div>
            <h3>My Links</h3>
            <ul>
                
                <li>
                    <a href="/presentations" title="Presentations">
                        Presentations
                    </a>
                </li>
                
                <li>
                    <a href="/assets/resume.pdf" title="Resume/CV">
                        Resume/CV
                    </a>
                </li>
                
                <li>
                    <a href="https://linkedin.com/in/jasondlee" title="LinkedIn">
                        LinkedIn
                    </a>
                </li>
                
                <li>
                    <a href="https://twitter.com/jasondlee" title="Twitter">
                        Twitter
                    </a>
                </li>
                
                <li>
                    <a href="https://mastodon.cloud/@jasondlee" title="Mastodon">
                        Mastodon
                    </a>
                </li>
                
                <li>
                    <a href="/tag" title="Tags">
                        Tags
                    </a>
                </li>
                
            </ul>

        </div>
        <div>
            <h3>Publications</h3>
            <ul>
                <li>
                    <div class="grid">
                        <div class="col-8" style="text-weight: bold; font-size: large">
                            <div>Java 9 Programming Blueprints:</div>
                            <div>
                                <a title="My Java 9 book at Amazon" href="https://amzn.to/2FD2XAo" style="padding-left: 10px">Amazon</a>
                            </div>
                            <div>
                                <a title="My Java 9 book at Packt"
                                   href="https://www.packtpub.com/application-development/java-9-programming-blueprints"
                                   style="padding-left: 10px">Packt</a>
                            </div>
                        </div>
                            <div class="col-4">
                                <a href="https://amzn.to/2FD2XAo"><img src="/images/2017/j9pb.png" width="100"/></a>
                            </div>
                    </div>
                </li>
                
                <li>
                    <a href="https://jaxenter.com/tips-for-writing-pluggable-java-ee-applications-105281.html" title="This article discusses ways to use Java EE specs to implement a simple, yet powerful plugin system with a minimum of thrid party libraries.">
                        Tips for Writing Pluggable Java EE Applications
                    </a>
                </li>
                
                <li>
                    <a href="http://www.oracle.com/technetwork/articles/javaee/jsf-templating-137822.html" title="An article Ken Paulsen and I wrote detailing easy JSF component creation">
                        JSFTemplating and Woodstock: Component Authoring Made Easy
                    </a>
                </li>
                
                <li>
                    <a href="http://jsfcentral.com/articles/lee-03-09.html" title="Jason Lee in depth: Mojarra and Scales">
                        Jason Lee in depth: Mojarra and Scales
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20090301060746/http://www.theserverside.com/news/thread.tss?thread_id=49343" title="My JavaOne 2008 Wrap Up">
                        Jason Lee: Postmortem for JavaOne 2008
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20130621192312/https://blogs.oracle.com/stories/entry/international_environmental" title="The GlassFish Adoption Story from my time at IEC">
                        International Environmental: A Cooling Company Which Prefers Hot Software
                    </a>
                </li>
                
                <li>
                    <a href="http://www.jsfcentral.com/articles/trenches_7.html" title="This details the project that spawned a couple of the Mojarra Scales components">
                        IEC donates custom JSF component to Mojarra Scales
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>
<div class="footer">
    <div>
        <p>&#169; Copyright Jason Lee, 2005-2023. All rights reserved.</p>
    </div>
</div>
<!--
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-1091049-6', 'auto');
    ga('send', 'pageview');
</script>
-->
<script src="/assets/js/quotes.js" type="text/javascript"></script>
<script src="/assets/js/local.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script type="text/javascript" src="/assets/js/copy.js"></script>
</body>
</html>
