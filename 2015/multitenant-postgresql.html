<!DOCTYPE html>
<html>
<head>
    <title>Coming Up for Air : Multitenant PostgreSQL</title>

    <script src="/assets/js/simple-jekyll-search.min.js" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3GQK1YDRQM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-3GQK1YDRQM');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="me" href="https://mastodon.cloud/@jasondlee"/>

    <link rel="alternate" type="application/rss+xml" title="jasondl.ee RSS feed" href="/feed.xml">

    <link rel="stylesheet" href="/assets/css/main.css" />

    <!-- Web Fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Cherry+Cream+Soda">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Philosopher">
    <link rel="stylesheet" type="text/css" href="/assets/css/font-awesome.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/primeflex@3.1.2/primeflex.css"/>
    <link rel="stylesheet" href="https://unpkg.com/primeflex/themes/saga-blue.css"/>
    <link rel="author" href="/images/profile-pic.jpg"/>
</head>
<body>
<div class="grid">
    <div class="col blogname">
        <span>
            <a href="https://jasondl.ee">Coming Up for Air</a>
        </span>
    </div>
</div>
<div class="grid main">
    <div class="col-9">
        <div id="content">
            <article class="post">
    <h1 class="title" style="border-bottom: solid 1px #47586d; margin-bottom: 0.25rem;">
        Multitenant PostgreSQL
    </h1>
    Wednesday, February 18, 2015 | <span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2015/multitenant-postgresql&title=Multitenant PostgreSQL" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Multitenant PostgreSQL&url=https://jasondl.ee/2015/multitenant-postgresql&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2015/multitenant-postgresql" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2015/multitenant-postgresql" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Multitenant PostgreSQL&amp;body=Multitenant PostgreSQL https://jasondl.ee/2015/multitenant-postgresql" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>

    <div>
        <div class="paragraph">
<p>As more and more of our applications move into "the cloud", multi-tenancy has become a pretty big thing these days. In a nutshell, "multi-tenancy" means handling multiple customers data using, say, a single server. This concept scales, of course, to clusters, etc., but the concept is the same: a bunch of people&#8217;s data all mixed together in one big bucket. The problem, then, for the development team is isolating one customer&#8217;s data from another&#8217;s, disallowing, for example, the viewing or editing of another customer&#8217;s information. There are a myriad of ways to accomplish this, but I&#8217;d like to discuss here a way to accomplish this using a single database.</p>
</div>
<div class="paragraph">
<p>While the concept can certainly be applied on just about any database, for this discussion, we&#8217;ll use PostgreSQL, my favorite database (and, yes, as a geek I&#8217;m allowed to say things like that). The concepts we&#8217;ll use are views, triggers, and session variables.</p>
</div>
<div class="paragraph">
<p>To keep things simple, our entity/model will be a very simple one called Item, which has one column, data. The DDL for its table might look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span style="color: #cf222e">CREATE</span> <span style="color: #cf222e">TABLE</span> <span style="color: #24292f;background-color: #f6f8fa">items</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>
	<span style="color: #24292f;background-color: #f6f8fa">id</span> <span style="color: #953800">SERIAL</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
	<span style="color: #cf222e">data</span> <span style="color: #953800">text</span>
<span style="color: #24292f;background-color: #f6f8fa">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s not very exciting, but that&#8217;s OK. I&#8217;m probably not either. In thinking about multiple customers, though, we need a way to discriminate between one customer&#8217;s Items and another, so we&#8217;ll add a company ID:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span style="color: #cf222e">CREATE</span> <span style="color: #cf222e">TABLE</span> <span style="color: #24292f;background-color: #f6f8fa">items</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>
	<span style="color: #24292f;background-color: #f6f8fa">id</span> <span style="color: #953800">SERIAL</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
	<span style="color: #24292f;background-color: #f6f8fa">company_id</span> <span style="color: #953800">int</span> <span style="color: #cf222e">not</span> <span style="color: #cf222e">null</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
	<span style="color: #cf222e">data</span> <span style="color: #953800">text</span>
<span style="color: #24292f;background-color: #f6f8fa">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>But how do we restrict customer #1 from seeing customer #2&#8217;s data? We&#8217;ll do that with a view:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span style="color: #cf222e">CREATE</span> <span style="color: #cf222e">OR</span> <span style="color: #cf222e">REPLACE</span> <span style="color: #cf222e">VIEW</span> <span style="color: #24292f;background-color: #f6f8fa">company_items</span> <span style="color: #cf222e">AS</span>
	<span style="color: #cf222e">SELECT</span> <span style="color: #0550ae">*</span> <span style="color: #cf222e">FROM</span> <span style="color: #24292f;background-color: #f6f8fa">items</span> <span style="color: #cf222e">WHERE</span> <span style="color: #24292f;background-color: #f6f8fa">company_id</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">...</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can tell, that&#8217;s not quite going to work. Where does the value for <code>company_id</code> come from? The answer to that is session variables. Unfortunately, as best as I can tell, Postgres doesn&#8217;t support this idea natively, so we have to roll our own, which we&#8217;ll do using plperl, the Postgres extension which allows writing stored procedures in Perl. There are other languages available, and perhaps I&#8217;ll port this to, say, Python, because Perl is pretty nasty stuff. :) Nevertheless, this is working code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span style="color: #cf222e">CREATE</span> <span style="color: #cf222e">OR</span> <span style="color: #cf222e">REPLACE</span> <span style="color: #cf222e">FUNCTION</span> <span style="color: #24292f;background-color: #f6f8fa">set_var</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">name</span> <span style="color: #953800">text</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #24292f;background-color: #f6f8fa">val</span> <span style="color: #953800">text</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">RETURNS</span> <span style="color: #953800">text</span> <span style="color: #cf222e">AS</span> <span style="color: #f6f8fa;background-color: #82071e">$$</span>
    <span style="color: #24292f;background-color: #f6f8fa">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #f6f8fa;background-color: #82071e">$</span><span style="color: #24292f;background-color: #f6f8fa">_SHARED</span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #f6f8fa;background-color: #82071e">$</span><span style="color: #24292f;background-color: #f6f8fa">_</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">]}</span> <span style="color: #0550ae">=</span> <span style="color: #f6f8fa;background-color: #82071e">$</span><span style="color: #24292f;background-color: #f6f8fa">_</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">])</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #0a3069">'ok'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #0550ae">"cannot set shared variable $_[0] to $_[1]"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #f6f8fa;background-color: #82071e">$$</span> <span style="color: #cf222e">LANGUAGE</span> <span style="color: #24292f;background-color: #f6f8fa">plperl</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">CREATE</span> <span style="color: #cf222e">OR</span> <span style="color: #cf222e">REPLACE</span> <span style="color: #cf222e">FUNCTION</span> <span style="color: #24292f;background-color: #f6f8fa">get_var</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">name</span> <span style="color: #953800">text</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">RETURNS</span> <span style="color: #953800">text</span> <span style="color: #cf222e">AS</span> <span style="color: #f6f8fa;background-color: #82071e">$$</span>
    <span style="color: #cf222e">return</span> <span style="color: #f6f8fa;background-color: #82071e">$</span><span style="color: #24292f;background-color: #f6f8fa">_SHARED</span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #f6f8fa;background-color: #82071e">$</span><span style="color: #24292f;background-color: #f6f8fa">_</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">]};</span>
<span style="color: #f6f8fa;background-color: #82071e">$$</span> <span style="color: #cf222e">LANGUAGE</span> <span style="color: #24292f;background-color: #f6f8fa">plperl</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates two functions, <code>set_var</code> and <code>get_var</code>, whose functionality should be apparent from the function names. With these in place, we can update the view as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span style="color: #cf222e">CREATE</span> <span style="color: #cf222e">OR</span> <span style="color: #cf222e">REPLACE</span> <span style="color: #cf222e">VIEW</span> <span style="color: #24292f;background-color: #f6f8fa">company_items</span> <span style="color: #cf222e">AS</span>
	<span style="color: #cf222e">SELECT</span> <span style="color: #0550ae">*</span> <span style="color: #cf222e">FROM</span> <span style="color: #24292f;background-color: #f6f8fa">items</span> <span style="color: #cf222e">WHERE</span> <span style="color: #24292f;background-color: #f6f8fa">company_id</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">cast</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">get_var</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'company_id'</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">AS</span> <span style="color: #953800">NUMERIC</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>To get the value from a function in Postgres, you SELECT from it, which we&#8217;ve added to the query that builds the view. You&#8217;ll also notice that <code>get_var</code> and <code>set_var</code> deal with strings, so the value needs to be cast to <code>NUMERIC</code> or the view creation will fail.</p>
</div>
<div class="paragraph">
<p>With all of this in place, we can test this using psql:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="code"><pre><i class="conum" data-value="1"></i><b>(1)</b>
<span style="color: #24292f;background-color: #f6f8fa">mydb</span><span style="color: #0550ae">=#</span> <span style="color: #cf222e">insert</span> <span style="color: #cf222e">into</span> <span style="color: #24292f;background-color: #f6f8fa">items</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">company_id</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">data</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">values</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0a3069">'Company 1 data 1'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">mydb</span><span style="color: #0550ae">=#</span> <span style="color: #cf222e">insert</span> <span style="color: #cf222e">into</span> <span style="color: #24292f;background-color: #f6f8fa">items</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">company_id</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">data</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">values</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0a3069">'Company 1 data 2'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">mydb</span><span style="color: #0550ae">=#</span> <span style="color: #cf222e">insert</span> <span style="color: #cf222e">into</span> <span style="color: #24292f;background-color: #f6f8fa">items</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">company_id</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">data</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">values</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0a3069">'Company 1 data 3'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">mydb</span><span style="color: #0550ae">=#</span> <span style="color: #cf222e">insert</span> <span style="color: #cf222e">into</span> <span style="color: #24292f;background-color: #f6f8fa">items</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">company_id</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">data</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">values</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0a3069">'Company 2 data 1'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">mydb</span><span style="color: #0550ae">=#</span> <span style="color: #cf222e">insert</span> <span style="color: #cf222e">into</span> <span style="color: #24292f;background-color: #f6f8fa">items</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">company_id</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">data</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">values</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0a3069">'Company 2 data 2'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
<i class="conum" data-value="2"></i><b>(2)</b>
<span style="color: #24292f;background-color: #f6f8fa">mydb</span><span style="color: #0550ae">=#</span> <span style="color: #cf222e">select</span> <span style="color: #0550ae">*</span> <span style="color: #cf222e">from</span> <span style="color: #24292f;background-color: #f6f8fa">company_items</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
 <span style="color: #24292f;background-color: #f6f8fa">id</span> <span style="color: #0550ae">|</span> <span style="color: #24292f;background-color: #f6f8fa">company_id</span> <span style="color: #0550ae">|</span> <span style="color: #cf222e">data</span>
<span style="color: #6e7781">----+------------+------</span>
<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0</span> <span style="color: #cf222e">rows</span><span style="color: #24292f;background-color: #f6f8fa">)</span>

<i class="conum" data-value="3"></i><b>(3)</b>
<span style="color: #24292f;background-color: #f6f8fa">mydb</span><span style="color: #0550ae">=#</span> <span style="color: #cf222e">select</span> <span style="color: #24292f;background-color: #f6f8fa">set_var</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'company_id'</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0a3069">'2'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
 <span style="color: #24292f;background-color: #f6f8fa">set_var</span>
<span style="color: #6e7781">---------</span>
 <span style="color: #24292f;background-color: #f6f8fa">ok</span>
<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span> <span style="color: #cf222e">row</span><span style="color: #24292f;background-color: #f6f8fa">)</span>

<i class="conum" data-value="4"></i><b>(4)</b>
<span style="color: #24292f;background-color: #f6f8fa">mydb</span><span style="color: #0550ae">=#</span> <span style="color: #cf222e">select</span> <span style="color: #0550ae">*</span> <span style="color: #cf222e">from</span> <span style="color: #24292f;background-color: #f6f8fa">company_items</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
 <span style="color: #24292f;background-color: #f6f8fa">id</span> <span style="color: #0550ae">|</span> <span style="color: #24292f;background-color: #f6f8fa">company_id</span> <span style="color: #0550ae">|</span>       <span style="color: #cf222e">data</span>
<span style="color: #6e7781">----+------------+------------------</span>
  <span style="color: #0550ae">4</span> <span style="color: #0550ae">|</span>          <span style="color: #0550ae">2</span> <span style="color: #0550ae">|</span> <span style="color: #24292f;background-color: #f6f8fa">Company</span> <span style="color: #0550ae">2</span> <span style="color: #cf222e">data</span> <span style="color: #0550ae">1</span>
  <span style="color: #0550ae">5</span> <span style="color: #0550ae">|</span>          <span style="color: #0550ae">2</span> <span style="color: #0550ae">|</span> <span style="color: #24292f;background-color: #f6f8fa">Company</span> <span style="color: #0550ae">2</span> <span style="color: #cf222e">data</span> <span style="color: #0550ae">2</span>
<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">2</span> <span style="color: #cf222e">rows</span><span style="color: #24292f;background-color: #f6f8fa">)</span>

<i class="conum" data-value="5"></i><b>(5)</b>
<span style="color: #24292f;background-color: #f6f8fa">mydb</span><span style="color: #0550ae">=#</span> <span style="color: #cf222e">select</span> <span style="color: #24292f;background-color: #f6f8fa">set_var</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'company_id'</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0a3069">'1'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
 <span style="color: #24292f;background-color: #f6f8fa">set_var</span>
<span style="color: #6e7781">---------</span>
 <span style="color: #24292f;background-color: #f6f8fa">ok</span>
<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span> <span style="color: #cf222e">row</span><span style="color: #24292f;background-color: #f6f8fa">)</span>

<i class="conum" data-value="6"></i><b>(6)</b>
<span style="color: #24292f;background-color: #f6f8fa">mydb</span><span style="color: #0550ae">=#</span> <span style="color: #cf222e">select</span> <span style="color: #0550ae">*</span> <span style="color: #cf222e">from</span> <span style="color: #24292f;background-color: #f6f8fa">company_items</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
 <span style="color: #24292f;background-color: #f6f8fa">id</span> <span style="color: #0550ae">|</span> <span style="color: #24292f;background-color: #f6f8fa">company_id</span> <span style="color: #0550ae">|</span>       <span style="color: #cf222e">data</span>
<span style="color: #6e7781">----+------------+------------------</span>
  <span style="color: #0550ae">1</span> <span style="color: #0550ae">|</span>          <span style="color: #0550ae">1</span> <span style="color: #0550ae">|</span> <span style="color: #24292f;background-color: #f6f8fa">Company</span> <span style="color: #0550ae">1</span> <span style="color: #cf222e">data</span> <span style="color: #0550ae">1</span>
  <span style="color: #0550ae">2</span> <span style="color: #0550ae">|</span>          <span style="color: #0550ae">1</span> <span style="color: #0550ae">|</span> <span style="color: #24292f;background-color: #f6f8fa">Company</span> <span style="color: #0550ae">1</span> <span style="color: #cf222e">data</span> <span style="color: #0550ae">2</span>
  <span style="color: #0550ae">3</span> <span style="color: #0550ae">|</span>          <span style="color: #0550ae">1</span> <span style="color: #0550ae">|</span> <span style="color: #24292f;background-color: #f6f8fa">Company</span> <span style="color: #0550ae">1</span> <span style="color: #cf222e">data</span> <span style="color: #0550ae">3</span>
<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">3</span> <span style="color: #cf222e">rows</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the data</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Select from the view</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the current company ID</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Select from the view again and see data</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Change the company ID</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Select from the view again and see different data</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see, the contents of the view <code>company_items</code> is controlled by the current state of the session variable <code>company_id</code>. It&#8217;s also clear that if it&#8217;s not set, then the view is empty, clearly indicating that the app must take care to set this session variable on each use. In the context of a web app, this would be done per request, just after authentication: the user&#8217;s credentials are verified, the company to which the user belongs is identified, and the session variable is set.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
One thing to be careful about that I have not yet had the chance to test is this: in a pooled connection environment, is the value of the session variable cleared when the connection is returned to the pool? My guess is that it is not. How to manage that, though, is beyond the scope of this post.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One final nugget. In such an environment, it would be nice if the application didn&#8217;t have to remember to set the company ID on the <code>Company_Item</code> explicitly. We can, in fact, handle that in the database layer with a trigger:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span style="color: #cf222e">CREATE</span> <span style="color: #cf222e">OR</span> <span style="color: #cf222e">REPLACE</span> <span style="color: #cf222e">FUNCTION</span> <span style="color: #24292f;background-color: #f6f8fa">set_item_company</span><span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #cf222e">RETURNS</span> <span style="color: #cf222e">trigger</span> <span style="color: #cf222e">AS</span> <span style="color: #f6f8fa;background-color: #82071e">$$</span>
    <span style="color: #cf222e">BEGIN</span>
        <span style="color: #cf222e">NEW</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">company_id</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">select</span> <span style="color: #cf222e">cast</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">get_var</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'company_id'</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">AS</span> <span style="color: #953800">NUMERIC</span><span style="color: #24292f;background-color: #f6f8fa">));</span>
        <span style="color: #cf222e">RETURN</span> <span style="color: #cf222e">NEW</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">END</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #f6f8fa;background-color: #82071e">$$</span> <span style="color: #cf222e">LANGUAGE</span> <span style="color: #24292f;background-color: #f6f8fa">plpgsql</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">CREATE</span> <span style="color: #cf222e">TRIGGER</span> <span style="color: #24292f;background-color: #f6f8fa">set_item_company</span> <span style="color: #cf222e">BEFORE</span> <span style="color: #cf222e">INSERT</span> <span style="color: #cf222e">OR</span> <span style="color: #cf222e">UPDATE</span> <span style="color: #cf222e">ON</span> <span style="color: #24292f;background-color: #f6f8fa">items</span>
    <span style="color: #cf222e">FOR</span> <span style="color: #cf222e">EACH</span> <span style="color: #cf222e">ROW</span> <span style="color: #cf222e">EXECUTE</span> <span style="color: #cf222e">PROCEDURE</span> <span style="color: #24292f;background-color: #f6f8fa">set_item_company</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>With this trigger in place, whenever a client inserts into either <code>company_items</code> or <code>items</code>, the field <code>company_id</code> is set automatically to whatever the current state of the session variable <code>company_id</code> is. Depending on your application&#8217;s architecture, frameworks, etc., this may not be necessary, but, if it&#8217;s helpful (and possible), this is an approach for handling it.</p>
</div>
<div class="paragraph">
<p>There you have it. The seeds, at least, of a fairly robust multitenant database approach that doesn&#8217;t involve separate databases or schemas for each tenant. As long as your application operates on only the views (exercise for the reader: can access to the tables be restricted at the database-level, leaving only the views accessible?) you should have a nice, clean segregation of customer data that is easy to maintain and migrate.</p>
</div>
<div class="paragraph">
<p>Find any holes? Problems? Brain dead ideas? Let me know below! 8-)</p>
</div>
    </div>
    <footer>
        <div class="grid">
            <div class="col tags">
                
                <span class="title">tags: </span>
                
                <a href="/tag/database/">database</a>
                <!--                <a href="https://jasondl.ee/tags/database.html">database</a>-->
                
                <a href="/tag/postgresql/">PostgreSQL</a>
                <!--                <a href="https://jasondl.ee/tags/PostgreSQL.html">PostgreSQL</a>-->
                
                <a href="/tag/multitenancy/">multitenancy</a>
                <!--                <a href="https://jasondl.ee/tags/multitenancy.html">multitenancy</a>-->
                
                
            </div>
            <div class="col"><span class="share-page" style="">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://jasondl.ee/2015/multitenant-postgresql&title=Multitenant PostgreSQL" rel="nofollow" target="_blank" title="Share on LinkedIn">
      <i class="fa fa-linkedin-square"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Multitenant PostgreSQL&url=https://jasondl.ee/2015/multitenant-postgresql&via=jasondlee&related=jasondlee" rel="nofollow" target="_blank" title="Share on Twitter">
      <i class="fa fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://jasondl.ee/2015/multitenant-postgresql" rel="nofollow" target="_blank" title="Share on Facebook">
      <i class="fa fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="https://www.reddit.com/submit?url=https://jasondl.ee/2015/multitenant-postgresql" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
      <i class="fa fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Multitenant PostgreSQL&amp;body=Multitenant PostgreSQL https://jasondl.ee/2015/multitenant-postgresql" title="Share via Email" >
      <i class="fa fa-envelope"></i>
  </a>
</span>
</div>
        </div>
    </footer>
</article>

        </div>
    </div>
    <div class="col-3 widget">
        <div>
            <h3>Search</h3>
            <!-- HTML elements for search -->
            <input type="text" id="search-input" placeholder="Search blog posts.." style="width: 98%"/>
            <ul id="results-container"></ul>

            <script>
                var sjs = SimpleJekyllSearch({
                    searchInput: document.getElementById('search-input'),
                    resultsContainer: document.getElementById('results-container'),
                    json: '/search.json',
                    limit: 50
                })
            </script>
        </div>
        <div>
            <h3>Quotes</h3>
            <p id="quote">Sample quote</p>
            <p id="source">Quote source</p>
        </div>
        <div>
            <h3>About</h3>
            <p><img src="/images/profile-pic.jpg" style="float:right; object-fit: scale-down; padding-bottom: 1em;"/>My name is Jason Lee. I am a software developer living in the middle of Oklahoma. I’ve been a professional developer since 1997,
using a variety of languages, including Java, Javascript, PHP, Python, Delphi, and even a bit of C#. I currently work for Red Hat
on the WildFly/EAP team, where, among other things, I maintain integrations for some MicroProfile specs, OpenTelemetry, Micrometer,
Jakarta Faces, and Bean Validation. (Full resume <a href="resume">here</a>.
LinkedIn <a href="https://www.linkedin.com/in/jasondlee">profile</a>)</p>

<p>I am the president of the Oklahoma City JUG, and an occasional speaker at the JUG and a variety of technical conferences.</p>

<p>On the personal side, I’m active in my church, and enjoy bass guitar, running, fishing, and a variety of martial arts. I’m also
married to a beautiful woman, and have two boys, who, thankfully, look like their mother.</p>

        </div>
        <div>
            <h3>My Links</h3>
            <ul>
                
                <li>
                    <a href="/presentations" title="Presentations">
                        Presentations
                    </a>
                </li>
                
                <li>
                    <a href="/assets/resume.pdf" title="Resume/CV">
                        Resume/CV
                    </a>
                </li>
                
                <li>
                    <a href="https://linkedin.com/in/jasondlee" title="LinkedIn">
                        LinkedIn
                    </a>
                </li>
                
                <li>
                    <a href="https://twitter.com/jasondlee" title="Twitter">
                        Twitter
                    </a>
                </li>
                
                <li>
                    <a href="https://mastodon.cloud/@jasondlee" title="Mastodon">
                        Mastodon
                    </a>
                </li>
                
                <li>
                    <a href="/tag" title="Tags">
                        Tags
                    </a>
                </li>
                
            </ul>

        </div>
        <div>
            <h3>Publications</h3>
            <ul>
                <li>
                    <div class="grid">
                        <div class="col-8" style="text-weight: bold; font-size: large">
                            <div>Java 9 Programming Blueprints:</div>
                            <div>
                                <a title="My Java 9 book at Amazon" href="https://amzn.to/2FD2XAo" style="padding-left: 10px">Amazon</a>
                            </div>
                            <div>
                                <a title="My Java 9 book at Packt"
                                   href="https://www.packtpub.com/application-development/java-9-programming-blueprints"
                                   style="padding-left: 10px">Packt</a>
                            </div>
                        </div>
                            <div class="col-4">
                                <a href="https://amzn.to/2FD2XAo"><img src="/images/2017/j9pb.png" width="100"/></a>
                            </div>
                    </div>
                </li>
                
                <li>
                    <a href="https://jaxenter.com/tips-for-writing-pluggable-java-ee-applications-105281.html" title="This article discusses ways to use Java EE specs to implement a simple, yet powerful plugin system with a minimum of thrid party libraries.">
                        Tips for Writing Pluggable Java EE Applications
                    </a>
                </li>
                
                <li>
                    <a href="http://www.oracle.com/technetwork/articles/javaee/jsf-templating-137822.html" title="An article Ken Paulsen and I wrote detailing easy JSF component creation">
                        JSFTemplating and Woodstock: Component Authoring Made Easy
                    </a>
                </li>
                
                <li>
                    <a href="http://jsfcentral.com/articles/lee-03-09.html" title="Jason Lee in depth: Mojarra and Scales">
                        Jason Lee in depth: Mojarra and Scales
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20090301060746/http://www.theserverside.com/news/thread.tss?thread_id=49343" title="My JavaOne 2008 Wrap Up">
                        Jason Lee: Postmortem for JavaOne 2008
                    </a>
                </li>
                
                <li>
                    <a href="https://web.archive.org/web/20130621192312/https://blogs.oracle.com/stories/entry/international_environmental" title="The GlassFish Adoption Story from my time at IEC">
                        International Environmental: A Cooling Company Which Prefers Hot Software
                    </a>
                </li>
                
                <li>
                    <a href="http://www.jsfcentral.com/articles/trenches_7.html" title="This details the project that spawned a couple of the Mojarra Scales components">
                        IEC donates custom JSF component to Mojarra Scales
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>
<div class="footer">
    <div>
        <p>&#169; Copyright Jason Lee, 2005-2023. All rights reserved.</p>
    </div>
</div>
<!--
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-1091049-6', 'auto');
    ga('send', 'pageview');
</script>
-->
<script src="/assets/js/quotes.js" type="text/javascript"></script>
<script src="/assets/js/local.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script type="text/javascript" src="/assets/js/copy.js"></script>
</body>
</html>
